<!DOCTYPE html>
<html>
<head>
    <!-- Fun compatability things -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">

    <!-- Information about this site -->
    <title>
        OpenWRT in Virtualbox
    </title>
    <meta name="description"
        content="A computer scientist working in open source towards a more hopeful future." />

    <!-- Various Twitter related content. -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg" />
    <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg" />
    <meta name="twitter:site" content="@a_hoverbear" />
    <meta name="twitter:creator" content="@a_hoverbear" />
    <link rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">

    <meta name="twitter:title"
        content="OpenWRT in Virtualbox" />
    <meta property='og:title'
        content="OpenWRT in Virtualbox" />

    <meta property='og:url'
        content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;openwrt-in-virtualbox&#x2F;" />

    <meta name="twitter:description"
        content="For my CSC 467 project I&#x27;m studying the configuration and performance of various QoS parameters in OpenWRT.
The plan is to set up an OpenWRT router in VirtualBox and orcestrate some Vagrant boxes to create a VM network.
" />
    <meta property='og:description'
        content="For my CSC 467 project I&#x27;m studying the configuration and performance of various QoS parameters in OpenWRT.
The plan is to set up an OpenWRT router in VirtualBox and orcestrate some Vagrant boxes to create a VM network.
" />


    <!-- Talk about the homepage and the rss feed. -->
    <link rel="canonical"
        href="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;openwrt-in-virtualbox&#x2F;">
    <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">

    <!-- Stylesheets are fun -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />

    <!-- Katex -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css"
        integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js"
        integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O"
        crossorigin="anonymous"></script>
    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js"
        integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
</head>

<body>
    
<div id="hero-wrapper">
    <figure class="enriched " style="">
       <figcaption>Photo&nbsp;- <a href="https://unsplash.com/photos/-N0cgDSF_MI">Kobi Li</a></figcaption>
       

<img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg 3840w
              " sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px" src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg" alt="Photo" />
</figure>
</div>
<header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
                OpenWRT in Virtualbox
            </a></h1>

        <nav id="tree">
    <ul>
        <li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul>
        </ul><ul>
        </ul>
</nav>

        <div class="metadata">
            <h5 class="description">
                A computer scientist working in open source towards a more hopeful future.
            </h5>

            <p class="date">
                Posted on 2014-11-23, around 5 minutes of reading.
            </p>
        </div>
    </div>
</header>

<main>
    
<nav id=toc>
    <ol>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#configuration">Configuration</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#getting-a-vdi">Getting a VDI</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#setup-the-vm">Setup the VM</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#wan">WAN</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#pulling-repos">Pulling Repos</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#password">Password</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#ssh">SSH</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#going-headless">Going Headless</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#guest-additions">Guest Additions</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#lan">LAN</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#dhcp">DHCP</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#firewall">Firewall</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/openwrt-in-virtualbox/#making-clients">Making Clients</a>
            
        </li>
        
    </ol>
</nav>

    <p>For my CSC 467 project I'm studying the configuration and performance of various QoS parameters in OpenWRT.</p>
<p>The plan is to set up an OpenWRT router in <a rel="noopener" target="_blank" href="https://www.virtualbox.org/">VirtualBox</a> and orcestrate some <a rel="noopener" target="_blank" href="http://vagrantup.com/">Vagrant</a> boxes to create a VM network.</p>
<span id="continue-reading"></span><h2 id="configuration">Configuration</h2>
<p>Lets configure some environment variables we'll use throughout, once you close your shell these will disappear, so you might need to reinitialize them later.</p>
<pre class="z-code"><code><span class="z-text z-plain">NAME=&quot;openwrt&quot;
</span>URL=&quot;https://downloads.openwrt.org/barrier_breaker/14.07/x86/generic/openwrt-x86-generic-combined-ext4.img.gz&quot;
</span>VDI=&quot;./openwrt.14.07.vdi&quot;
</span>VMNAME=&quot;openwrt&quot;
</span>SIZE=&#39;512000000&#39;
</span></code></pre>
<h2 id="getting-a-vdi">Getting a VDI</h2>
<p>Pull the image, unzip it, and make a VDI out of it for VirtualBox.</p>
<pre class="z-code"><code><span class="z-text z-plain">curl $URL \
</span>| gunzip \
</span>| VBoxManage convertfromraw --format VDI stdin $VDI $SIZE
</span></code></pre>
<h2 id="setup-the-vm">Setup the VM</h2>
<p>Configure a VM with some modest settings for the router. We can add adapters and other storage devices later. This is a 3 port router.</p>
<pre class="z-code"><code><span class="z-text z-plain">VBoxManage createvm --name $VMNAME --register &amp;&amp; \
</span>VBoxManage modifyvm $VMNAME \
</span>    --description &quot;A VM to build an OpenWRT Vagrant box.&quot; \
</span>    --ostype &quot;Linux26&quot; \
</span>    --memory &quot;512&quot; \
</span>    --cpus &quot;1&quot; \
</span>    --nic1 &quot;intnet&quot; \
</span>    --intnet1 &quot;port1&quot; \
</span>    --nic2 &quot;intnet&quot; \
</span>    --intnet2 &quot;port2&quot; \
</span>    --nic3 &quot;intnet&quot; \
</span>    --intnet3 &quot;port3&quot; \
</span>    --nic4 &quot;nat&quot; \
</span>    --natpf4 &quot;ssh,tcp,,2222,,22&quot; \
</span>    --natpf4 &quot;luci,tcp,,8080,,80&quot; \
</span>    --uart1 &quot;0x3F8&quot; &quot;4&quot; \
</span>    --uartmode1 &quot;disconnected&quot; &amp;&amp; \
</span>VBoxManage storagectl $VMNAME \
</span>    --name &quot;SATA Controller&quot; \
</span>    --add &quot;sata&quot; \
</span>    --portcount &quot;4&quot; \
</span>    --hostiocache &quot;on&quot; \
</span>    --bootable &quot;on&quot; &amp;&amp; \
</span>VBoxManage storageattach $VMNAME \
</span>    --storagectl &quot;SATA Controller&quot; \
</span>    --port &quot;1&quot; \
</span>    --type &quot;hdd&quot; \
</span>    --nonrotational &quot;on&quot; \
</span>    --medium $VDI
</span></code></pre>
<p>That's it! Now to fire up the VM:</p>
<pre class="z-code"><code><span class="z-text z-plain">VBoxManage startvm openwrt --type &quot;gui&quot;
</span></code></pre>
<p>Next, it's time to settle in and get comfortable. The boot output will not show you command prompt until you manually focus the window and tap return, then you should see a prompt.</p>
<figure class="enriched " style="">
       <figcaption>The VM screen</figcaption>
       

<img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;d801ceb45f1eb10f00.png 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;402f6d5eeb52c8d900.png 3840w
              " sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px" src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;d801ceb45f1eb10f00.png" alt="The VM screen" />
</figure>
<h2 id="wan">WAN</h2>
<p>You'll notice from a quick <code>ping hoverbear.org</code> that you don't have a network connection working, even though we set up a NAT connection.</p>
<p>In the OpenWRT VM, add the following to <code>/etc/config/network</code>:</p>
<pre class="z-code"><code><span class="z-text z-plain">config interface &#39;wan&#39;
</span>    option ifname   &#39;eth3&#39;
</span>    option proto    &#39;dhcp&#39;
</span></code></pre>
<p>Then restart the networking service:</p>
<pre class="z-code"><code><span class="z-text z-plain">/etc/init.d/network restart
</span></code></pre>
<p>Now you should be able to <code>ping hoverbear.org</code></p>
<h2 id="pulling-repos">Pulling Repos</h2>
<p>Before doing much more, you may wish to fetch the repository listing:</p>
<pre class="z-code"><code><span class="z-text z-plain">opkg update
</span></code></pre>
<h2 id="password">Password</h2>
<p>You may want to set up a password on the account, or put set up an SSH key for login. You may also want to use a non-root user.</p>
<pre class="z-code"><code><span class="z-text z-plain">passwd
</span></code></pre>
<h2 id="ssh">SSH</h2>
<p>OpenWRT uses Dropbear as an SSH server. <em>(In my totally unbiased opinion, that is an awesome name)</em></p>
<p>Lets set it up so we don't have to keep working in the VirtualBox GUI. Having a native terminal is much more comfortable.</p>
<p>By default, Dropbear is <strong>already</strong> installed, but if you don't have it for some reason, you can install it with:</p>
<pre class="z-code"><code><span class="z-text z-plain">  opkg install dropbear
</span></code></pre>
<p>Then check <code>/etc/config/dropbear</code>. By default, PasswordAuth and RootPasswordAuth are both on and it runs on port 22. For our Virtual Machine testing purposes, this is fine, it will be port-forwarded on port 2222 of our host machine. On a system facing the world (I.E. not behind a NAT and router etc) this would be considered very, very bad practice.</p>
<p>According to <a rel="noopener" target="_blank" href="http://wiki.openwrt.org/doc/uci/dropbear">the Dropbear WRT documentation</a>, it is already enabled. If you change the configuration make sure to restart it.</p>
<pre class="z-code"><code><span class="z-text z-plain">/etc/init.d/dropbear restart
</span></code></pre>
<p>However if you attempt to <code>ssh root@localhost -p 2222</code> you'll see a something along the lines of <code>ssh_exchange_identification: read: Connection reset by peer</code>. That's because the firewall is blocking it.</p>
<p>Now in <code>/etc/config/firewall</code> we can add a rule to fix this:</p>
<pre class="z-code"><code><span class="z-text z-plain"># ... Other Rules ...

</span># Allow SSH on wan
</span>config rule
</span>        option src              wan
</span>        option proto            tcp
</span>        option dest_port        22
</span>        option target           ACCEPT
</span></code></pre>
<p>Then restart the firewall:</p>
<pre class="z-code"><code><span class="z-text z-plain">/etc/init.d/firewall restart
</span></code></pre>
<p>Now you should be able to run <code>ssh root@localhost -2222</code> on the host machine and connect.</p>
<h2 id="going-headless">Going Headless</h2>
<p>Make sure you've set up SSH (and logged in!) first before trying this.</p>
<p>You can stop the VM and start it again in a headless form.</p>
<p>Stop the VM:</p>
<pre class="z-code"><code><span class="z-text z-plain">VBoxManage controlvm $VMNAME poweroff
</span></code></pre>
<p>Start it headless:</p>
<pre class="z-code"><code><span class="z-text z-plain">VBoxManage startvm $VMNAME --type headless
</span></code></pre>
<h2 id="guest-additions">Guest Additions</h2>
<p>Unfortunately it seems OpenWRT does not provide simple workflow for VirtualBox Guest Additions. Please let me know if you find a way of getting this working.</p>
<h2 id="lan">LAN</h2>
<p>To set up the other adapters, remove the <code>lan</code> section from the <code>/etc/config/network</code> file and replace it with:</p>
<pre class="z-code"><code><span class="z-text z-plain">config interface &#39;lan1&#39;
</span>    option ifname &#39;eth0&#39;
</span>    option proto &#39;static&#39;
</span>    option ipaddr &#39;192.168.1.1&#39;
</span>    option netmask &#39;255.255.255.0&#39;
</span>    option ip6assign &#39;60&#39;

</span>config interface &#39;lan2&#39;
</span>    option ifname &#39;eth1&#39;
</span>    option proto &#39;static&#39;
</span>    option ipaddr &#39;192.168.2.1&#39;
</span>    option netmask &#39;255.255.255.0&#39;
</span>    option ip6assign &#39;60&#39;

</span>config interface &#39;lan3&#39;
</span>    option ifname &#39;eth2&#39;
</span>    option proto &#39;static&#39;
</span>    option ipaddr &#39;192.168.3.1&#39;
</span>    option netmask &#39;255.255.255.0&#39;
</span>    option ip6assign &#39;60&#39;
</span></code></pre>
<p>Then restart the network:</p>
<pre class="z-code"><code><span class="z-text z-plain">/etc/init.d/network reload
</span></code></pre>
<h2 id="dhcp">DHCP</h2>
<p>Since we removed the <code>lan</code> interface above, you'll need to reconfigure the DHCP daemon. Remove the <code>lan</code> block from <code>/etc/config/dhcp</code> and replace it with this:</p>
<pre class="z-code"><code><span class="z-text z-plain">config dhcp &#39;lan1&#39;
</span>    option interface &#39;lan1&#39;
</span>    option start &#39;100&#39;
</span>    option limit &#39;150&#39;
</span>    option leasetime &#39;12h&#39;
</span>    option dhcpv6 &#39;server&#39;
</span>    option ra &#39;server&#39;
</span>    list &#39;dhcp_option&#39; &#39;3,192.168.1.1&#39;

</span>config dhcp &#39;lan2&#39;
</span>    option interface &#39;lan2&#39;
</span>    option start &#39;100&#39;
</span>    option limit &#39;150&#39;
</span>    option leasetime &#39;12h&#39;
</span>    option dhcpv6 &#39;server&#39;
</span>    option ra &#39;server&#39;
</span>    list &#39;dhcp_option&#39; &#39;3,192.168.2.1&#39;

</span>config dhcp &#39;lan3&#39;
</span>    option interface &#39;lan3&#39;
</span>    option start &#39;100&#39;
</span>    option limit &#39;150&#39;
</span>    option leasetime &#39;12h&#39;
</span>    option dhcpv6 &#39;server&#39;
</span>    option ra &#39;server&#39;
</span>    list &#39;dhcp_option&#39; &#39;3,192.168.3.1&#39;
</span></code></pre>
<p>Then restart the <code>dhcp</code> and <code>dnsmasq</code> services.</p>
<pre class="z-code"><code><span class="z-text z-plain">/etc/init.d/odhcpd reload
</span>/etc/init.d/dnsmasq reload
</span></code></pre>
<h2 id="firewall">Firewall</h2>
<p>This new configuration won't work without modifying the firewall, too. Change the <code>lan</code> zone in <code>/etc/config/firewall</code> to:</p>
<pre class="z-code"><code><span class="z-text z-plain">config zone
</span>    option name             lan
</span>    list   network          &#39;lan1&#39;
</span>    list   network          &#39;lan2&#39;
</span>    list   network          &#39;lan3&#39;
</span>    option input            ACCEPT
</span>    option output           ACCEPT
</span>    option forward          ACCEPT
</span></code></pre>
<p>Then restart the firewall.</p>
<pre class="z-code"><code><span class="z-text z-plain">	/etc/init.d/firewall reload
</span></code></pre>
<h2 id="making-clients">Making Clients</h2>
<p>We can create other VMs which attach to our new router.</p>
<p>I'll be writing later about how to get these subordinates, (ahem, <em>network clients</em>) working together with the router.</p>
<p><a rel="noopener" target="_blank" href="http://www.hoverbear.org/2014/12/04/vagrant-clients-for-openwrt-vms/">See next post.</a></p>

</main>
<footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;
    <a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;
    <a rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">@ana@hachyderm.io</a> on Mastodon,</a>&nbsp;
    <a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre
        class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/417d50e1050cf201c88e74681074803a86ccd018
">417d50e1050cf201c88e74681074803a86ccd018
</a></pre></body>

</html>