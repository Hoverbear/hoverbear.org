<!DOCTYPE html>
<html>
<head>
    <!-- Fun compatability things -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">

    <!-- Information about this site -->
    <title>
        Hierarchical Structures in PostgreSQL
    </title>
    <meta name="description"
        content="Modelling hierarchical&#x2F;team&#x2F;categorical&#x2F;tag data with arbitrary depths." />

    <!-- Various Twitter related content. -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;55fbc6926324726b00.jpg" />
    <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;55fbc6926324726b00.jpg" />
    <meta name="twitter:site" content="@a_hoverbear" />
    <meta name="twitter:creator" content="@a_hoverbear" />

    <meta name="twitter:title"
        content="Hierarchical Structures in PostgreSQL" />
    <meta property='og:title'
        content="Hierarchical Structures in PostgreSQL" />

    <meta property='og:url'
        content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;postgresql-hierarchical-structures&#x2F;" />

    <meta name="twitter:description"
        content="It&#x27;s a common pattern: a database developer at a startup is probably on the Product subteam of the Engineering team at their company. In a department store, shoes are a subcategory of clothing, while your favorite thermos is probably in the travel department.
In any Github organization, there are teams within teams within teams. In any large department store there are categories deeply nested. In any recipe book, there are many ways to classify food.
So how can we model them?
" />
    <meta property='og:description'
        content="It&#x27;s a common pattern: a database developer at a startup is probably on the Product subteam of the Engineering team at their company. In a department store, shoes are a subcategory of clothing, while your favorite thermos is probably in the travel department.
In any Github organization, there are teams within teams within teams. In any large department store there are categories deeply nested. In any recipe book, there are many ways to classify food.
So how can we model them?
" />


    <!-- Talk about the homepage and the rss feed. -->
    <link rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">
    <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
    <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">

    <!-- Stylesheets are fun -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />

    <!-- Katex -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css"
        integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js"
        integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O"
        crossorigin="anonymous"></script>
    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js"
        integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
</head>

<body>
    
<div id="hero-wrapper">
    <figure class="enriched " style="">
       <figcaption>Photo&nbsp;- Javier Allegue Barros; @soymeraki on Unsplash</figcaption>
       

<img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;f9d74e5edc6423d400.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;55fbc6926324726b00.jpg 3840w
              " sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px" src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;f9d74e5edc6423d400.jpg" alt="Photo" />
</figure>
</div>
<header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
                Hierarchical Structures in PostgreSQL
            </a></h1>

        <nav id="tree">
    <ul>
        <li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul>
        </ul><ul>
        </ul>
</nav>

        <div class="metadata">
            <h5 class="description">
                Modelling hierarchical/team/categorical/tag data with arbitrary depths.
            </h5>

            <p class="date">
                Posted on 2020-01-19, around 7 minutes of reading.
            </p>
        </div>
    </div>
</header>

<main>
    
<nav id=toc>
    <ol>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#core-problem">Core Problem</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#concepts">Concepts</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#before-we-start">Before we start</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#solution-1-materialized-views-and-recursive-ctes">Solution 1: Materialized Views and Recursive CTEs</a>
            
            <ol>
                
                <li>
                    <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#testing">Testing</a>
                </li>
                
            </ol>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#solution-2-ltree-columns">Solution 2: ltree columns</a>
            
            <ol>
                
                <li>
                    <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#testing-1">Testing</a>
                </li>
                
            </ol>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#conclusion">Conclusion</a>
            
        </li>
        
    </ol>
</nav>

    <p>It's a common pattern: a database developer at a startup is probably on the Product subteam of the Engineering team at their company. In a department store, shoes are a subcategory of clothing, while your favorite thermos is probably in the travel department.</p>
<p>In any Github organization, there are teams within teams within teams. In any large department store there are categories deeply nested. In any recipe book, there are many ways to classify food.</p>
<p>So how can we model them?</p>
<span id="continue-reading"></span>
<p>Jake (my boyfriend) and I have been exploring relational database concepts out of interest and pure geekery. This was a fun problem that I gave him and we got to work it out together. It was so fun we wanted to share! We won't beat the bush around with PostgreSQL installation, security, setup, blah blah at this time, let's just have some pure database fun for a few minutes!</p>
<h2 id="core-problem">Core Problem</h2>
<p>Handle a high amount of reads and a small amount of writes over a small to medium amount of keys (in this case, a text field), each of which <em>possibly</em> has a reference to a parent key.</p>
<p>In this concrete example, we will replicate team structures. Start with the teams existing inside some small organization, each with a <code>name</code> and possibly a <code>parent</code>:</p>
<table><thead><tr><th align="left">name</th><th align="left">parent</th></tr></thead><tbody>
<tr><td align="left">Engineering</td><td align="left">NULL</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td></tr>
<tr><td align="left">Administration</td><td align="left">NULL</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td></tr>
</tbody></table>
<p>Then somehow mixin the <code>path</code> which shows the datum's place in the hierarchy.</p>
<table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">NULL</td><td align="left">{Administration}</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td><td align="left">{Administration,Human Resources}</td></tr>
<tr><td align="left">Engineering</td><td align="left">NULL</td><td align="left">{Engineering}</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td><td align="left">{Engineering,Gesch√§ftst√§tigkeit}</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td><td align="left">{Logistics}</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td><td align="left">{Marketing}</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td><td align="left">{ÂõΩÈôÖÂåñ}</td></tr>
</tbody></table>
<p>For this exercise, the exact format of the <code>path</code> is not important. An HTML string, a comma separated list, or any ordered collection is acceptable.</p>
<h2 id="concepts">Concepts</h2>
<p>We'll actually cover two solutions, both of which demonstrate a few core concepts! </p>
<p>For the first solution, ensure you're familiar with the ideas of <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-comparison.html"><strong><code>NULL</code></strong></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-PRIMARY-KEYS"><strong>Primary Keys</strong></a>, and <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK"><strong>Foreign Keys</strong></a>. We'll need these for building safe, efficient linking between teams and their parents.</p>
<p>We'll then use a <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/sql-creatematerializedview.html"><strong>Materialized View</strong></a> to create a sort of <em>cache</em> of the point-in-time team structure. We'll refresh this using a <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/plpgsql-trigger.html"><strong>Function</strong></a> that is <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/trigger-definition.html"><strong>Triggered</strong></a> whenever the original table is written to.</p>
<p>For the next solution, we'll explore the tailor-made <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/ltree.html"><strong><code>ltree</code></strong></a> type that can solve our needs without the complex mechanics of the first solution. Further, this solution offers some useful functionality like <code>subpath</code>s.</p>
<h2 id="before-we-start">Before we start</h2>
<p>Please make sure your database is in UTF-8! We're going to be exploring international text today. If you're not sure, let's create a new empty database, and go ahead and connect to it.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">DATABASE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">organization WITH ENCODING &#39;UTF8&#39; </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">TEMPLATE</span></span><span class="z-keyword z-operator z-comparison z-sql">=</span>template0
</span></code></pre>
<h2 id="solution-1-materialized-views-and-recursive-ctes">Solution 1: Materialized Views and Recursive CTEs</h2>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TABLE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">teams</span></span> (
    name   <span class="z-storage z-type z-sql">TEXT</span>
           UNIQUE <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>
           <span class="z-storage z-modifier z-sql">PRIMARY KEY</span>,
    parent <span class="z-storage z-type z-sql">TEXT</span>
           <span class="z-storage z-modifier z-sql">REFERENCES</span> teams (name)
);

CREATE MATERIALIZED VIEW team_structure <span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span>
    <span class="z-keyword z-other z-DML z-sql">WITH</span> RECURSIVE teams_cte(name, parent, <span class="z-storage z-type z-sql">path</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> (
        <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">name</span>, <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">parent</span>, ARRAY [<span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">name</span>]
            <span class="z-keyword z-other z-DML z-sql">FROM</span> teams
            <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">parent</span> <span class="z-keyword z-operator z-logical z-sql">IS</span> <span class="z-constant z-language z-sql">NULL</span>
        <span class="z-keyword z-other z-DML z-sql">UNION ALL</span>
        <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">name</span>, <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">parent</span>, array_append(<span class="z-constant z-other z-database-name z-sql">teams_cte</span>.<span class="z-constant z-other z-table-name z-sql">path</span>, <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">name</span>)
            <span class="z-keyword z-other z-DML z-sql">FROM</span> teams_cte,
                 teams
            <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-constant z-other z-database-name z-sql">teams</span>.<span class="z-constant z-other z-table-name z-sql">parent</span> <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-constant z-other z-database-name z-sql">teams_cte</span>.<span class="z-constant z-other z-table-name z-sql">name</span>
    )
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span>
        <span class="z-keyword z-other z-DML z-sql">FROM</span> teams_cte;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">refresh_team_structure</span></span><span class="z-meta z-block z-sql"><span class="z-punctuation z-section z-scope z-begin z-sql">(</span><span class="z-punctuation z-section z-scope z-end z-sql">)</span></span> RETURNS TRIGGER
    LANGUAGE plpgsql <span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span>
$$
<span class="z-keyword z-other z-LUW z-sql">BEGIN</span>
    REFRESH MATERIALIZED VIEW team_structure;
    RETURN new;
<span class="z-keyword z-other z-DML z-sql">END</span>;
$$;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TRIGGER</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">trigger_update_team_structure</span></span>
    AFTER <span class="z-keyword z-other z-DML z-sql">UPDATE</span> <span class="z-keyword z-operator z-logical z-sql">OR</span> <span class="z-keyword z-other z-DML z-sql">INSERT</span> <span class="z-keyword z-operator z-logical z-sql">OR</span> <span class="z-keyword z-other z-DML z-sql">DELETE</span> <span class="z-keyword z-operator z-logical z-sql">OR</span> <span class="z-keyword z-other z-DML z-sql">TRUNCATE</span>
    ON teams
EXECUTE PROCEDURE refresh_team_structure<span class="z-meta z-block z-sql"><span class="z-punctuation z-section z-scope z-begin z-sql">(</span><span class="z-punctuation z-section z-scope z-end z-sql">)</span></span>;
</span></code></pre>
<h3 id="testing">Testing</h3>
<p>Loading the example data, including a few complex cases, like spaces, umlauts, and Chinese script:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">INSERT INTO</span> teams (name, parent)
    <span class="z-keyword z-other z-DML z-II z-sql">VALUES</span> (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-constant z-language z-sql">NULL</span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Gesch√§ftst√§tigkeit<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Interns<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-constant z-language z-sql">NULL</span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Human Resources<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Marketing<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-constant z-language z-sql">NULL</span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Logistics<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-constant z-language z-sql">NULL</span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>ÂõΩÈôÖÂåñ<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-constant z-language z-sql">NULL</span>);
</span></code></pre>
<p>Listing all of them:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> team_structure <span class="z-keyword z-other z-DML z-sql">ORDER BY</span> <span class="z-storage z-type z-sql">path</span>;
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">NULL</td><td align="left">{Administration}</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td><td align="left">{Administration,Human Resources}</td></tr>
<tr><td align="left">Engineering</td><td align="left">NULL</td><td align="left">{Engineering}</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td><td align="left">{Engineering,Gesch√§ftst√§tigkeit}</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td><td align="left">{Logistics}</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td><td align="left">{Marketing}</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td><td align="left">{ÂõΩÈôÖÂåñ}</td></tr>
</tbody></table>
<p>A specific one:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> team_structure <span class="z-keyword z-other z-DML z-sql">WHERE</span> name <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
</tbody></table>
<p>Finding all subteams (deep) of a team:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> team_structure <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span> <span class="z-keyword z-operator z-comparison z-sql">=</span> ANY(<span class="z-storage z-type z-sql">path</span>);
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
</tbody></table>
<p>Let's look at the analysis:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-operator z-comparison z-sql">&gt;</span> EXPLAIN ANALYZE <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> team_structure <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span> <span class="z-keyword z-operator z-comparison z-sql">=</span> ANY(<span class="z-storage z-type z-sql">path</span>);
Seq Scan on team_structure  (cost<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">00</span>..<span class="z-constant z-numeric z-sql">24</span>.<span class="z-constant z-numeric z-sql">63</span> rows<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">3</span> width<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">96</span>) (actual <span class="z-storage z-type z-sql">time</span><span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">015</span>..<span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">016</span> rows<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">2</span> loops<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">1</span>)
  Filter: (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>::<span class="z-storage z-type z-sql">text</span> <span class="z-keyword z-operator z-comparison z-sql">=</span> ANY (<span class="z-storage z-type z-sql">path</span>))
  Rows Removed by Filter: <span class="z-constant z-numeric z-sql">8</span>
Planning <span class="z-storage z-type z-sql">Time</span>: <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">047</span> ms
Execution <span class="z-storage z-type z-sql">Time</span>: <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">026</span> ms
</span></code></pre>
<h2 id="solution-2-ltree-columns">Solution 2: <code>ltree</code> columns</h2>
<blockquote>
<p>Thanks to <a rel="noopener" target="_blank" href="https://twitter.com/focusaurus">@focusaurus</a> for giving me the idea to add this section after publication!</p>
</blockquote>
<p><code>ltree</code> is an extension that you should <em>probably</em> already have if your PostgreSQL is an officially distributed package. The <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/ltree.html">PostgreSQL docs</a> on the <code>ltree</code> type summarize it quite well, so let's not just repeat them and let's solve our problem!</p>
<p>First, let's note some limitations:</p>
<blockquote>
<p>A label is a sequence of alphanumeric characters and underscores <strong>(for example, in C locale the characters A-Za-z0-9_ are allowed)</strong>. Labels must be <strong>less than 256 bytes long</strong>.</p>
</blockquote>
<p>While the length limit is not terrible, the lack of support for the full UTF-8 spectrum, such as spaces or even words like Â∑•Á®ã or Gesch√§ftst√§tigkeit is really limiting!</p>
<p>So, when we create our table, let's give it a <code>name</code> column where we can store any eÕùÃòÃ´Ã©ÃºxÃ¢oÃµÃûÕôÃ∞ÕïtÕàÕÖÃºÃ∫ÕçÃ•iÃªÕâÃ∫ÕöÕïcÃ∂Ã•ÃòÕñÃ™Ã§Ãú text we want. We'll also need a <code>slug</code> column containing the expected fragment in the <code>path</code>.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql">CREATE EXTENSION IF NOT <span class="z-keyword z-operator z-logical z-sql">EXISTS</span> ltree;
<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TABLE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">teams</span></span> (
    name <span class="z-storage z-type z-sql">text</span>
        <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>,
    slug <span class="z-storage z-type z-sql">text</span>
        <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>
        <span class="z-storage z-modifier z-sql">CHECK</span> (slug ~<span class="z-variable z-language z-star z-sql">*</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>^[A-Za-z0-9_]{1,255}$<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
    <span class="z-storage z-type z-sql">path</span> ltree
        UNIQUE <span class="z-keyword z-operator z-logical z-sql">NOT</span> <span class="z-constant z-language z-sql">NULL</span>
        <span class="z-storage z-modifier z-sql">PRIMARY KEY</span>
);
</span></code></pre>
<h3 id="testing-1">Testing</h3>
<p>Loading the data is a bit different, you'll notice we just insert paths. </p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">INSERT INTO</span> teams (name, slug, <span class="z-storage z-type z-sql">path</span>)
    <span class="z-keyword z-other z-DML z-II z-sql">VALUES</span> (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Gesch√§ftst√§tigkeit<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Operations<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering.Operations<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering.Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Interns<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Interns<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Engineering.Product.Interns<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Human Resources<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Human_Resources<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration.Human_Resources<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Administration.Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Marketing<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Marketing<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Marketing<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Logistics<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Logistics<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Logistics<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>),
           (<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>ÂõΩÈôÖÂåñ<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Internationalization<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>,<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Internationalization<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>);
</span></code></pre>
<p>Listing all of them:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> teams <span class="z-keyword z-other z-DML z-sql">ORDER BY</span> <span class="z-storage z-type z-sql">path</span>;
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">Administration</td><td align="left">Administration</td></tr>
<tr><td align="left">Finance</td><td align="left">Finance</td><td align="left">Administration.Finance</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Human_Resources</td><td align="left">Administration.Human_Resources</td></tr>
<tr><td align="left">Engineering</td><td align="left">Engineering</td><td align="left">Engineering</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Operations</td><td align="left">Engineering.Operations</td></tr>
<tr><td align="left">Product</td><td align="left">Product</td><td align="left">Engineering.Product</td></tr>
<tr><td align="left">Interns</td><td align="left">Interns</td><td align="left">Engineering.Product.Interns</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">Internationalization</td><td align="left">Internationalization</td></tr>
<tr><td align="left">Logistics</td><td align="left">Logistics</td><td align="left">Logistics</td></tr>
<tr><td align="left">Marketing</td><td align="left">Marketing</td><td align="left">Marketing</td></tr>
</tbody></table>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> teams <span class="z-keyword z-other z-DML z-sql">WHERE</span> slug <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Finance<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Finance</td><td align="left">Finance</td><td align="left">Administration.Finance</td></tr>
</tbody></table>
<p>Finding all subteams (deep) of a team:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> teams <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-storage z-type z-sql">path</span> @ <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;
</span></code></pre>
<table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Product</td><td align="left">Product</td><td align="left">Engineering.Product</td></tr>
<tr><td align="left">Interns</td><td align="left">Interns</td><td align="left">Engineering.Product.Interns</td></tr>
</tbody></table>
<p>The query plan:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-operator z-comparison z-sql">&gt;</span> EXPLAIN ANALYZE <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-variable z-language z-star z-sql">*</span> <span class="z-keyword z-other z-DML z-sql">FROM</span> teams <span class="z-keyword z-other z-DML z-sql">WHERE</span> <span class="z-storage z-type z-sql">path</span> @ <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;
Seq Scan on teams  (cost<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">00</span>..<span class="z-constant z-numeric z-sql">18</span>.<span class="z-constant z-numeric z-sql">13</span> rows<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">1</span> width<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">96</span>) (actual <span class="z-storage z-type z-sql">time</span><span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">013</span>..<span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">014</span> rows<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">2</span> loops<span class="z-keyword z-operator z-comparison z-sql">=</span><span class="z-constant z-numeric z-sql">1</span>)
  Filter: (<span class="z-storage z-type z-sql">path</span> @ <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>Product<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>::ltxtquery)
  Rows Removed by Filter: <span class="z-constant z-numeric z-sql">8</span>
Planning <span class="z-storage z-type z-sql">Time</span>: <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">055</span> ms
Execution <span class="z-storage z-type z-sql">Time</span>: <span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">029</span> ms
</span></code></pre>
<h2 id="conclusion">Conclusion</h2>
<p>As you can see, this problem can be tackled in a couple different ways, with some basic SQL concepts used together, or with already existing types! Don't let limitations turn you away, you can overcome them!</p>
<p>I hope this have given you some ideas about new things you can do with your database!</p>

</main>
<footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;
    <a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;
    <a rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">@ana@hachyderm.io</a> on Mastodon,</a>&nbsp;
    <a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre
        class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/71ff4f2443a6a28a399e4a9c9aed096e3c80bf13
">71ff4f2443a6a28a399e4a9c9aed096e3c80bf13
</a></pre></body>

</html>