<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>Hierarchical Structures in PostgreSQL
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bcd8060a2fec229f00.jpg">
        <meta name="twitter:site" content="@a_hoverbear">
        <meta name="twitter:creator" content="@a_hoverbear">
        
            <meta name="twitter:title" content="Hierarchical Structures in PostgreSQL">
        
        
            <meta name="twitter:description" content="It&#x27;s a common pattern: a database developer at a startup is probably on the Product subteam of the Engineering team at their company. In a department store, shoes are a subcategory of clothing, while your favorite thermos is probably in the travel department.
In any Github organization, there are teams within teams within teams. In any large department store there are categories deeply nested. In any recipe book, there are many ways to classify food.
So how can we model them?
">
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- Javier Allegue Barros; @soymeraki on Unsplash</figcaption>
        <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;7af41ef30c2eb1c300.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bcd8060a2fec229f00.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;9102ec7ae89dc56100.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            Hierarchical Structures in PostgreSQL
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <p class="description">
                    Modelling hierarchical&#x2F;team&#x2F;categorical&#x2F;tag data with arbitrary depths.
                </p>

            <p class="date">
                    Posted on 2020-01-19, around 7 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#core-problem">Core Problem</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#concepts">Concepts</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#before-we-start">Before we start</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#solution-1-materialized-views-and-recursive-ctes">Solution 1: Materialized Views and Recursive CTEs</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#testing">Testing</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#solution-2-ltree-columns">Solution 2: ltree columns</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#testing-1">Testing</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-hierarchical-structures/#conclusion">Conclusion</a>
                
            </li>
            
        </ol>
    </nav>

        <p>It's a common pattern: a database developer at a startup is probably on the Product subteam of the Engineering team at their company. In a department store, shoes are a subcategory of clothing, while your favorite thermos is probably in the travel department.</p>
<p>In any Github organization, there are teams within teams within teams. In any large department store there are categories deeply nested. In any recipe book, there are many ways to classify food.</p>
<p>So how can we model them?</p>
<span id="continue-reading"></span>
<p>Jake (my boyfriend) and I have been exploring relational database concepts out of interest and pure geekery. This was a fun problem that I gave him and we got to work it out together. It was so fun we wanted to share! We won't beat the bush around with PostgreSQL installation, security, setup, blah blah at this time, let's just have some pure database fun for a few minutes!</p>
<h2 id="core-problem">Core Problem</h2>
<p>Handle a high amount of reads and a small amount of writes over a small to medium amount of keys (in this case, a text field), each of which <em>possibly</em> has a reference to a parent key.</p>
<p>In this concrete example, we will replicate team structures. Start with the teams existing inside some small organization, each with a <code>name</code> and possibly a <code>parent</code>:</p>
<table><thead><tr><th align="left">name</th><th align="left">parent</th></tr></thead><tbody>
<tr><td align="left">Engineering</td><td align="left">NULL</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td></tr>
<tr><td align="left">Administration</td><td align="left">NULL</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td></tr>
</tbody></table>
<p>Then somehow mixin the <code>path</code> which shows the datum's place in the hierarchy.</p>
<table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">NULL</td><td align="left">{Administration}</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td><td align="left">{Administration,Human Resources}</td></tr>
<tr><td align="left">Engineering</td><td align="left">NULL</td><td align="left">{Engineering}</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td><td align="left">{Engineering,Gesch√§ftst√§tigkeit}</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td><td align="left">{Logistics}</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td><td align="left">{Marketing}</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td><td align="left">{ÂõΩÈôÖÂåñ}</td></tr>
</tbody></table>
<p>For this exercise, the exact format of the <code>path</code> is not important. An HTML string, a comma separated list, or any ordered collection is acceptable.</p>
<h2 id="concepts">Concepts</h2>
<p>We'll actually cover two solutions, both of which demonstrate a few core concepts! </p>
<p>For the first solution, ensure you're familiar with the ideas of <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-comparison.html"><strong><code>NULL</code></strong></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-PRIMARY-KEYS"><strong>Primary Keys</strong></a>, and <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-FK"><strong>Foreign Keys</strong></a>. We'll need these for building safe, efficient linking between teams and their parents.</p>
<p>We'll then use a <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/sql-creatematerializedview.html"><strong>Materialized View</strong></a> to create a sort of <em>cache</em> of the point-in-time team structure. We'll refresh this using a <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/plpgsql-trigger.html"><strong>Function</strong></a> that is <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/trigger-definition.html"><strong>Triggered</strong></a> whenever the original table is written to.</p>
<p>For the next solution, we'll explore the tailor-made <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/ltree.html"><strong><code>ltree</code></strong></a> type that can solve our needs without the complex mechanics of the first solution. Further, this solution offers some useful functionality like <code>subpath</code>s.</p>
<h2 id="before-we-start">Before we start</h2>
<p>Please make sure your database is in UTF-8! We're going to be exploring international text today. If you're not sure, let's create a new empty database, and go ahead and connect to it.</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">CREATE DATABASE </span><span style="color:#c0c5ce;">organization WITH ENCODING &#39;UTF8&#39; </span><span style="color:#8fa1b3;">TEMPLATE</span><span style="color:#c0c5ce;">=template0
</span></code></pre><h2 id="solution-1-materialized-views-and-recursive-ctes">Solution 1: Materialized Views and Recursive CTEs</h2>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">CREATE TABLE </span><span style="color:#8fa1b3;">teams</span><span style="color:#c0c5ce;"> (
    name   </span><span style="color:#b48ead;">TEXT
</span><span style="color:#c0c5ce;">           UNIQUE NOT </span><span style="color:#d08770;">NULL
           </span><span style="color:#b48ead;">PRIMARY KEY</span><span style="color:#c0c5ce;">,
    parent </span><span style="color:#b48ead;">TEXT
           REFERENCES</span><span style="color:#c0c5ce;"> teams (name)
);

CREATE MATERIALIZED VIEW team_structure AS
    </span><span style="color:#b48ead;">WITH</span><span style="color:#c0c5ce;"> RECURSIVE teams_cte(name, parent, </span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;">) AS (
        </span><span style="color:#b48ead;">SELECT </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">name</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">parent</span><span style="color:#c0c5ce;">, ARRAY [</span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">name</span><span style="color:#c0c5ce;">]
            </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams
            </span><span style="color:#b48ead;">WHERE </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">parent </span><span style="color:#c0c5ce;">IS </span><span style="color:#d08770;">NULL
        </span><span style="color:#b48ead;">UNION ALL
        SELECT </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">name</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">parent</span><span style="color:#c0c5ce;">, array_append(</span><span style="color:#d08770;">teams_cte</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">path</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">name</span><span style="color:#c0c5ce;">)
            </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams_cte,
                 teams
            </span><span style="color:#b48ead;">WHERE </span><span style="color:#d08770;">teams</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">parent </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">teams_cte</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">name
</span><span style="color:#c0c5ce;">    )
    </span><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">*
        </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams_cte;

</span><span style="color:#b48ead;">CREATE FUNCTION </span><span style="color:#8fa1b3;">refresh_team_structure</span><span style="color:#c0c5ce;">() RETURNS TRIGGER
    LANGUAGE plpgsql AS
$$
</span><span style="color:#b48ead;">BEGIN
</span><span style="color:#c0c5ce;">    REFRESH MATERIALIZED VIEW team_structure;
    RETURN new;
</span><span style="color:#b48ead;">END</span><span style="color:#c0c5ce;">;
$$;

</span><span style="color:#b48ead;">CREATE TRIGGER </span><span style="color:#8fa1b3;">trigger_update_team_structure
</span><span style="color:#c0c5ce;">    AFTER </span><span style="color:#b48ead;">UPDATE </span><span style="color:#c0c5ce;">OR </span><span style="color:#b48ead;">INSERT </span><span style="color:#c0c5ce;">OR </span><span style="color:#b48ead;">DELETE </span><span style="color:#c0c5ce;">OR </span><span style="color:#b48ead;">TRUNCATE
</span><span style="color:#c0c5ce;">    ON teams
EXECUTE PROCEDURE refresh_team_structure();
</span></code></pre><h3 id="testing">Testing</h3>
<p>Loading the example data, including a few complex cases, like spaces, umlauts, and Chinese script:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">INSERT INTO</span><span style="color:#c0c5ce;"> teams (name, parent)
    </span><span style="color:#b48ead;">VALUES</span><span style="color:#c0c5ce;"> (&#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">),
           (&#39;</span><span style="color:#a3be8c;">Gesch√§ftst√§tigkeit</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Interns</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">),
           (&#39;</span><span style="color:#a3be8c;">Human Resources</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Finance</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Marketing</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">),
           (&#39;</span><span style="color:#a3be8c;">Logistics</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">),
           (&#39;</span><span style="color:#a3be8c;">ÂõΩÈôÖÂåñ</span><span style="color:#c0c5ce;">&#39;, </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">);
</span></code></pre>
<p>Listing all of them:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> team_structure </span><span style="color:#b48ead;">ORDER BY path</span><span style="color:#c0c5ce;">;
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">NULL</td><td align="left">{Administration}</td></tr>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Administration</td><td align="left">{Administration,Human Resources}</td></tr>
<tr><td align="left">Engineering</td><td align="left">NULL</td><td align="left">{Engineering}</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Engineering</td><td align="left">{Engineering,Gesch√§ftst√§tigkeit}</td></tr>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
<tr><td align="left">Logistics</td><td align="left">NULL</td><td align="left">{Logistics}</td></tr>
<tr><td align="left">Marketing</td><td align="left">NULL</td><td align="left">{Marketing}</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">NULL</td><td align="left">{ÂõΩÈôÖÂåñ}</td></tr>
</tbody></table>
<p>A specific one:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> team_structure </span><span style="color:#b48ead;">WHERE</span><span style="color:#c0c5ce;"> name = &#39;</span><span style="color:#a3be8c;">Finance</span><span style="color:#c0c5ce;">&#39;;
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Finance</td><td align="left">Administration</td><td align="left">{Administration,Finance}</td></tr>
</tbody></table>
<p>Finding all subteams (deep) of a team:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> team_structure </span><span style="color:#b48ead;">WHERE </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39; = ANY(</span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;">);
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">parent</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Product</td><td align="left">Engineering</td><td align="left">{Engineering,Product}</td></tr>
<tr><td align="left">Interns</td><td align="left">Product</td><td align="left">{Engineering,Product,Interns}</td></tr>
</tbody></table>
<p>Let's look at the analysis:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#c0c5ce;">&gt; EXPLAIN ANALYZE </span><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> team_structure </span><span style="color:#b48ead;">WHERE </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39; = ANY(</span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;">);
Seq Scan on team_structure  (cost=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">00</span><span style="color:#c0c5ce;">..</span><span style="color:#d08770;">24</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">63</span><span style="color:#c0c5ce;"> rows=</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;"> width=</span><span style="color:#d08770;">96</span><span style="color:#c0c5ce;">) (actual </span><span style="color:#b48ead;">time</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">015</span><span style="color:#c0c5ce;">..</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">016</span><span style="color:#c0c5ce;"> rows=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;"> loops=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
  Filter: (&#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;::</span><span style="color:#b48ead;">text </span><span style="color:#c0c5ce;">= ANY (</span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;">))
  Rows Removed by Filter: </span><span style="color:#d08770;">8
</span><span style="color:#c0c5ce;">Planning </span><span style="color:#b48ead;">Time</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">047</span><span style="color:#c0c5ce;"> ms
Execution </span><span style="color:#b48ead;">Time</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">026</span><span style="color:#c0c5ce;"> ms
</span></code></pre><h2 id="solution-2-ltree-columns">Solution 2: <code>ltree</code> columns</h2>
<blockquote>
<p>Thanks to <a rel="noopener" target="_blank" href="https://twitter.com/focusaurus">@focusaurus</a> for giving me the idea to add this section after publication!</p>
</blockquote>
<p><code>ltree</code> is an extension that you should <em>probably</em> already have if your PostgreSQL is an officially distributed package. The <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/12/ltree.html">PostgreSQL docs</a> on the <code>ltree</code> type summarize it quite well, so let's not just repeat them and let's solve our problem!</p>
<p>First, let's note some limitations:</p>
<blockquote>
<p>A label is a sequence of alphanumeric characters and underscores <strong>(for example, in C locale the characters A-Za-z0-9_ are allowed)</strong>. Labels must be <strong>less than 256 bytes long</strong>.</p>
</blockquote>
<p>While the length limit is not terrible, the lack of support for the full UTF-8 spectrum, such as spaces or even words like Â∑•Á®ã or Gesch√§ftst√§tigkeit is really limiting!</p>
<p>So, when we create our table, let's give it a <code>name</code> column where we can store any eÕùÃòÃ´Ã©ÃºxÃ¢oÃµÃûÕôÃ∞ÕïtÕàÕÖÃºÃ∫ÕçÃ•iÃªÕâÃ∫ÕöÕïcÃ∂Ã•ÃòÕñÃ™Ã§Ãú text we want. We'll also need a <code>slug</code> column containing the expected fragment in the <code>path</code>.</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#c0c5ce;">CREATE EXTENSION IF NOT EXISTS ltree;
</span><span style="color:#b48ead;">CREATE TABLE </span><span style="color:#8fa1b3;">teams</span><span style="color:#c0c5ce;"> (
    name </span><span style="color:#b48ead;">text
        </span><span style="color:#c0c5ce;">NOT </span><span style="color:#d08770;">NULL</span><span style="color:#c0c5ce;">,
    slug </span><span style="color:#b48ead;">text
        </span><span style="color:#c0c5ce;">NOT </span><span style="color:#d08770;">NULL
        </span><span style="color:#b48ead;">CHECK</span><span style="color:#c0c5ce;"> (slug ~</span><span style="color:#bf616a;">* </span><span style="color:#c0c5ce;">&#39;</span><span style="color:#a3be8c;">^[A-Za-z0-9_]{1,255}$</span><span style="color:#c0c5ce;">&#39;),
    </span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;"> ltree
        UNIQUE NOT </span><span style="color:#d08770;">NULL
        </span><span style="color:#b48ead;">PRIMARY KEY
</span><span style="color:#c0c5ce;">);
</span></code></pre><h3 id="testing-1">Testing</h3>
<p>Loading the data is a bit different, you'll notice we just insert paths. </p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">INSERT INTO</span><span style="color:#c0c5ce;"> teams (name, slug, </span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;">)
    </span><span style="color:#b48ead;">VALUES</span><span style="color:#c0c5ce;"> (&#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Gesch√§ftst√§tigkeit</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Operations</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering.Operations</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering.Product</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Interns</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Interns</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Engineering.Product.Interns</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Human Resources</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Human_Resources</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration.Human_Resources</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Finance</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Finance</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Administration.Finance</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Marketing</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Marketing</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Marketing</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">Logistics</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Logistics</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Logistics</span><span style="color:#c0c5ce;">&#39;),
           (&#39;</span><span style="color:#a3be8c;">ÂõΩÈôÖÂåñ</span><span style="color:#c0c5ce;">&#39;, &#39;</span><span style="color:#a3be8c;">Internationalization</span><span style="color:#c0c5ce;">&#39;,&#39;</span><span style="color:#a3be8c;">Internationalization</span><span style="color:#c0c5ce;">&#39;);
</span></code></pre>
<p>Listing all of them:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams </span><span style="color:#b48ead;">ORDER BY path</span><span style="color:#c0c5ce;">;
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Administration</td><td align="left">Administration</td><td align="left">Administration</td></tr>
<tr><td align="left">Finance</td><td align="left">Finance</td><td align="left">Administration.Finance</td></tr>
<tr><td align="left">Human Resources</td><td align="left">Human_Resources</td><td align="left">Administration.Human_Resources</td></tr>
<tr><td align="left">Engineering</td><td align="left">Engineering</td><td align="left">Engineering</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Operations</td><td align="left">Engineering.Operations</td></tr>
<tr><td align="left">Product</td><td align="left">Product</td><td align="left">Engineering.Product</td></tr>
<tr><td align="left">Interns</td><td align="left">Interns</td><td align="left">Engineering.Product.Interns</td></tr>
<tr><td align="left">ÂõΩÈôÖÂåñ</td><td align="left">Internationalization</td><td align="left">Internationalization</td></tr>
<tr><td align="left">Logistics</td><td align="left">Logistics</td><td align="left">Logistics</td></tr>
<tr><td align="left">Marketing</td><td align="left">Marketing</td><td align="left">Marketing</td></tr>
</tbody></table>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams </span><span style="color:#b48ead;">WHERE</span><span style="color:#c0c5ce;"> slug = &#39;</span><span style="color:#a3be8c;">Finance</span><span style="color:#c0c5ce;">&#39;;
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Finance</td><td align="left">Finance</td><td align="left">Administration.Finance</td></tr>
</tbody></table>
<p>Finding all subteams (deep) of a team:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams </span><span style="color:#b48ead;">WHERE path</span><span style="color:#c0c5ce;"> @ &#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;;
</span></code></pre><table><thead><tr><th align="left">name</th><th align="left">slug</th><th align="left">path</th></tr></thead><tbody>
<tr><td align="left">Engineering</td><td align="left">Engineering</td><td align="left">Engineering</td></tr>
<tr><td align="left">Gesch√§ftst√§tigkeit</td><td align="left">Operations</td><td align="left">Engineering.Operations</td></tr>
<tr><td align="left">Product</td><td align="left">Product</td><td align="left">Engineering.Product</td></tr>
<tr><td align="left">Interns</td><td align="left">Interns</td><td align="left">Engineering.Product.Interns</td></tr>
</tbody></table>
<p>The query plan:</p>
<pre style="background-color:#2b303b;">
<code class="language-sql" data-lang="sql"><span style="color:#c0c5ce;">&gt; EXPLAIN ANALYZE </span><span style="color:#b48ead;">SELECT </span><span style="color:#bf616a;">* </span><span style="color:#b48ead;">FROM</span><span style="color:#c0c5ce;"> teams </span><span style="color:#b48ead;">WHERE path</span><span style="color:#c0c5ce;"> @ &#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;;
Seq Scan on teams  (cost=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">00</span><span style="color:#c0c5ce;">..</span><span style="color:#d08770;">18</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">13</span><span style="color:#c0c5ce;"> rows=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;"> width=</span><span style="color:#d08770;">96</span><span style="color:#c0c5ce;">) (actual </span><span style="color:#b48ead;">time</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">013</span><span style="color:#c0c5ce;">..</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">014</span><span style="color:#c0c5ce;"> rows=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;"> loops=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
  Filter: (</span><span style="color:#b48ead;">path</span><span style="color:#c0c5ce;"> @ &#39;</span><span style="color:#a3be8c;">Product</span><span style="color:#c0c5ce;">&#39;::ltxtquery)
  Rows Removed by Filter: </span><span style="color:#d08770;">8
</span><span style="color:#c0c5ce;">Planning </span><span style="color:#b48ead;">Time</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">055</span><span style="color:#c0c5ce;"> ms
Execution </span><span style="color:#b48ead;">Time</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">029</span><span style="color:#c0c5ce;"> ms
</span></code></pre><h2 id="conclusion">Conclusion</h2>
<p>As you can see, this problem can be tackled in a couple different ways, with some basic SQL concepts used together, or with already existing types! Don't let limitations turn you away, you can overcome them!</p>
<p>I hope this have given you some ideas about new things you can do with your database!</p>

    </main>
    <footer class="post-footer">
    <p>
        Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
        or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
    </p>
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/c276aa685996120ae9c0047a6b6be01f3b22b967
">c276aa685996120ae9c0047a6b6be01f3b22b967
</a></pre>
    </body>

</html>
