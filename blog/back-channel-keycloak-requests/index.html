<!DOCTYPE html>
<html>
<head>
    <!-- Fun compatability things -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge"> <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
    <meta name="HandheldFriendly" content="True" />
    <meta name="MobileOptimized" content="320" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">

    <!-- Information about this site -->
    <title>
        Back Channel Keycloak Requests
    </title>
    <meta name="description"
        content="A computer scientist working in open source towards a more hopeful future." />

    <!-- Various Twitter related content. -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg" />
    <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg" />
    <meta name="twitter:site" content="@a_hoverbear" />
    <meta name="twitter:creator" content="@a_hoverbear" />
    <link rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">

    <meta name="twitter:title"
        content="Back Channel Keycloak Requests" />
    <meta property='og:title'
        content="Back Channel Keycloak Requests" />

    <meta property='og:url'
        content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;back-channel-keycloak-requests&#x2F;" />

    <meta name="twitter:description"
        content="While using Keycloak you may need to make authenticated requests between various services. How can this be accomplished with Immutant?

You may want to check this link to learn how to use Immutant with Keycloak.

" />
    <meta property='og:description'
        content="While using Keycloak you may need to make authenticated requests between various services. How can this be accomplished with Immutant?

You may want to check this link to learn how to use Immutant with Keycloak.

" />


    <!-- Talk about the homepage and the rss feed. -->
    <link rel="canonical"
        href="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;back-channel-keycloak-requests&#x2F;">
    <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">

    <!-- Stylesheets are fun -->
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />

    <!-- Katex -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css"
        integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
    <!-- The loading of KaTeX is deferred to speed up page rendering -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js"
        integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O"
        crossorigin="anonymous"></script>
    <!-- To automatically render math in text elements, include the auto-render extension: -->
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js"
        integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous"
        onload="renderMathInElement(document.body);"></script>
</head>

<body>
    
<div id="hero-wrapper">
    <figure class="enriched " style="">
       <figcaption>Photo&nbsp;- <a href="https://unsplash.com/photos/-N0cgDSF_MI">Kobi Li</a></figcaption>
       

<img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg 3840w
              " sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px" src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg" alt="Photo" />
</figure>
</div>
<header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
                Back Channel Keycloak Requests
            </a></h1>

        <nav id="tree">
    <ul>
        <li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul>
        </ul><ul>
        </ul>
</nav>

        <div class="metadata">
            <h5 class="description">
                A computer scientist working in open source towards a more hopeful future.
            </h5>

            <p class="date">
                Posted on 2014-08-04, around 3 minutes of reading.
            </p>
        </div>
    </div>
</header>

<main>
    
<nav id=toc>
    <ol>
        
        <li>
            <a href="https://hoverbear.org/blog/back-channel-keycloak-requests/#concept">Concept</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/back-channel-keycloak-requests/#preparation">Preparation</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/back-channel-keycloak-requests/#setting-up-keycloak">Setting Up Keycloak</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/back-channel-keycloak-requests/#making-a-request">Making a Request</a>
            
        </li>
        
        <li>
            <a href="https://hoverbear.org/blog/back-channel-keycloak-requests/#handling-a-request">Handling a Request</a>
            
        </li>
        
    </ol>
</nav>

    <p>While using <a rel="noopener" target="_blank" href="http://keycloak.jboss.org/">Keycloak</a> you may need to make authenticated requests between various services. How can this be accomplished with <a rel="noopener" target="_blank" href="http://immutant.org/">Immutant</a>?</p>
<blockquote>
<p>You may want to check <a href="/2014/07/25/integrating-immutant-and-keycloak/">this</a> link to learn how to use Immutant with Keycloak.</p>
</blockquote>
<span id="continue-reading"></span><h2 id="concept">Concept</h2>
<p>In this deployment, there are three components to the deployment, a <strong>Consumer</strong>, a <strong>Provider</strong>, and <strong>Keycloak</strong>. The <strong>Consumer</strong> makes a request of the <strong>Provider</strong> using authentication through <strong>Keycloak</strong>.</p>
<p><strong>Workflow:</strong></p>
<ul>
<li><strong>User</strong> visits <strong>Consumer</strong>, gets redirected to <strong>Keycloak</strong>.</li>
<li><strong>User</strong> authenticates with <strong>Keycloak</strong>, gets redirected back to <strong>Consumer</strong>.</li>
<li><strong>Consumer</strong> uses the <strong>User</strong>'s &quot;Bearer&quot; token in a back channel request to the <strong>Provider</strong>.</li>
<li><strong>Provider</strong> verifies the <strong>User</strong>'s &quot;Bearer&quot; token with <strong>Keycloak</strong>.</li>
<li><strong>Provider</strong> returns data to <strong>Consumer</strong> which returns it to the <strong>User</strong> after performing arbitrary computations.</li>
</ul>
<h2 id="preparation">Preparation</h2>
<p>Deploy out a Keycloak container, and scaffold a pair of Immutant applications. In Keycloak, create a <strong>Consumer</strong> application, and a <strong>Provider</strong> application with <strong>User</strong> roles for both. In the <strong>Consumer</strong>'s <code>web.xml</code>, restrict the <code>/backchannel</code> route to only authenticated <strong>User</strong> roles. Do the same thing with <code>/locked</code> on the <strong>Provider</strong>.</p>
<h2 id="setting-up-keycloak">Setting Up Keycloak</h2>
<p>As of the 1.0.0-3 BETA version Keycloak currently requires you to declare the scopes necessary for your application. <strong>In 1.0.0-4 BETA, applications will have full role access by default, so this section is not applicable.</strong></p>
<p>Currently, Keycloak does not grant applications any &quot;Scopes&quot; with other applications, scopes allow you to restrict which role mappings are studded into an access token. In Keycloak, go to the prepared appliactions and under the &quot;Scopes&quot; tab, select the <em>other</em> application and give it the <strong>User</strong> scope.</p>
<h2 id="making-a-request">Making a Request</h2>
<p>The <strong>User</strong> will browse to the <strong>Consumer</strong> and authenticate with <strong>Keycloak</strong>, then return to the <code>/backchannel</code> route. Since at this point they will be authenticated, you can get their session and utilize the Token it provides.</p>
<p>The <code>get-session</code> function produces a session which can be utilized.</p>
<pre data-lang="clojure" class="language-clojure z-code"><code class="language-clojure" data-lang="clojure"><span class="z-source z-clojure"><span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">get-session</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Gets the session, get the object with `.getToken` or the access token itself with `.getTokenString`<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">let</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>servlet-request <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>servlet-request</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span> request
        session <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getAttribute</span> servlet-request <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>org.keycloak.KeycloakSecurityContext<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
    session<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
</span></code></pre>
<p><code>back-channel-handler</code>, which is bound to the <code>/backchannel</code> route, responds to the request with information regarding the users resource access, as well as the data sent from the provider.</p>
<pre data-lang="clojure" class="language-clojure z-code"><code class="language-clojure" data-lang="clojure"><span class="z-source z-clojure"><span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">back-channel-handler</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>A back channel request handler<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>The back call resulted in:&lt;br&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
    <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getResourceAccess</span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getToken</span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">get-session</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
    <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;br&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
    <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">try</span>
      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">client/get</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>http://provider:8080/locked<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
        <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>headers</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>
          <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Authorization<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Bearer <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getTokenString</span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">get-session</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
        <span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">catch</span> Exception e
        <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Exception occured... &lt;pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> e <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>

<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defroutes</span> <span class="z-entity z-name z-function z-clojure">app</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>The router.<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/backchannel<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">back-channel-handler</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
</span></code></pre>
<h2 id="handling-a-request">Handling a Request</h2>
<p>On the <strong>Provider</strong>, lock down the <code>/locked</code> route in the <code>web.xml</code> file. Then, Keycloak provides all of the necessary facilities to handle and verify the request. By the time the request reaches the <strong>Provider</strong>, it's already verified that the user has access.</p>

</main>
<footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;
    <a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;
    <a rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@ana">@ana@hachyderm.io</a> on Mastodon,</a>&nbsp;
    <a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre
        class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/ec90682a05aacf55e686dffd93dfdf232af7e30b
">ec90682a05aacf55e686dffd93dfdf232af7e30b
</a></pre></body>

</html>