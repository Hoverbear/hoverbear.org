<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>PostgreSQL Aggregates with Rust
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fe614e91db782cd600.jpg"/>
        <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fe614e91db782cd600.jpg"/>
        <meta name="twitter:site" content="@a_hoverbear"/>
        <meta name="twitter:creator" content="@a_hoverbear"/>
        
        
            <meta name="twitter:title" content="PostgreSQL Aggregates with Rust"/>
            <meta property='og:title' content="PostgreSQL Aggregates with Rust"/>
        

        
            <meta property='og:url' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;postgresql-aggregates-with-rust&#x2F;"/>
        

        
            <meta name="twitter:description" content="Reaching for something like SUM(vals) or AVG(vals) is a common habit when using PostgreSQL. These aggregate functions offer users an easy, efficient way to compute results from a set of inputs.
How do they work? What makes them different than a function? How do we make one? What kinds of other uses exist?
We&#x27;ll explore creating some basic ones using SQL, then create an extension that defines aggregates in Rust using pgx 0.3.0&#x27;s new aggregate support.
"/>
            <meta property='og:description' content="Reaching for something like SUM(vals) or AVG(vals) is a common habit when using PostgreSQL. These aggregate functions offer users an easy, efficient way to compute results from a set of inputs.
How do they work? What makes them different than a function? How do we make one? What kinds of other uses exist?
We&#x27;ll explore creating some basic ones using SQL, then create an extension that defines aggregates in Rust using pgx 0.3.0&#x27;s new aggregate support.
"/>
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- <a href="https://unsplash.com/photos/avKc9N7wxuQ">Jean Wimmerlin</a></figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;8927c105298ca42800.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fe614e91db782cd600.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;8927c105298ca42800.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            PostgreSQL Aggregates with Rust
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <h5 class="description">
                    Writing custom Aggregates for statistical or analytical purposes.
                </h5>

            <p class="date">
                    Posted on 2022-02-09, around 21 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#aggregates-in-the-world">Aggregates in the world</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#what-makes-an-aggregate">What makes an Aggregate?</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#familiarizing-with-pgx">Familiarizing with pgx</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#aggregates-with-pgx">Aggregates with pgx</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#rust-state-types">Rust state types</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#ordered-set-aggregates">Ordered-Set Aggregates</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#moving-aggregate-mode">Moving-Aggregate mode</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/postgresql-aggregates-with-rust/#wrapping-up">Wrapping up</a>
                
            </li>
            
        </ol>
    </nav>

        <p>Reaching for something like <code>SUM(vals)</code> or <code>AVG(vals)</code> is a common habit when using PostgreSQL. These <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html">aggregate functions</a> offer users an easy, efficient way to compute results from a set of inputs.</p>
<p>How do they work? What makes them different than a function? How do we make one? What kinds of other uses exist?</p>
<p>We'll explore creating some basic ones using SQL, then create an extension that defines aggregates in Rust using <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a> 0.3.0's new aggregate support.</p>
<span id="continue-reading"></span><h1 id="aggregates-in-the-world">Aggregates in the world</h1>
<p>Aggregates have a number of uses, beyond the ones already mentioned (sum and average) we can find slightly less conceptually straightforward aggregates like:</p>
<ul>
<li>JSON/JSONB/XML 'collectors': <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>json_agg</code></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>json_object_agg</code></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>xmlagg</code></a>.</li>
<li>Bitwise operators: <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>bit_and</code></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>bit_xor</code></a>, etc.</li>
<li>Some <a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html"><code>std::iter::Iterator</code></a> equivalents:
<ul>
<li><a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.all"><code>all</code></a>: <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>bool_and</code></a></li>
<li><a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.any"><code>any</code></a>: <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>bool_or</code></a></li>
<li><a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.collect"><code>collect::&lt;Vec&lt;_&gt;&gt;</code></a>: <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/functions-aggregate.html"><code>array_agg</code></a></li>
</ul>
</li>
<li><a rel="noopener" target="_blank" href="https://postgis.net/">PostGIS</a>'s geospacial <a rel="noopener" target="_blank" href="https://postgis.net/docs/PostGIS_Special_Functions_Index.html#PostGIS_Aggregate_Functions">aggregates</a> such as <a rel="noopener" target="_blank" href="https://postgis.net/docs/ST_3DExtent.html"><code>ST_3DExtent</code></a> which produces bounding boxes over geometry sets.</li>
<li><a rel="noopener" target="_blank" href="https://heterodb.github.io/pg-strom/">PG-Strom</a>'s <a rel="noopener" target="_blank" href="https://heterodb.github.io/pg-strom/ref_sqlfuncs/#hyperloglog-functions">HyperLogLog aggregates</a> such as <a rel="noopener" target="_blank" href="https://heterodb.github.io/pg-strom/ref_sqlfuncs/#hyperloglog-functions"><code>hll_count</code></a>.</li>
</ul>
<p>So, aggregates can collect items, work like a <a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.collect"><code>fold</code></a>, or do complex analytical math... how do we make one?</p>
<h1 id="what-makes-an-aggregate">What makes an Aggregate?</h1>
<p>Defining an aggregate is via <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/sql-createaggregate.html"><code>CREATE AGGREGATE</code></a> and <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/sql-createfunction.html"><code>CREATE FUNCTION</code></a>, here's a reimplementation of <code>sum</code> only for <code>integer</code>:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_sum_state</span></span>(
    state <span class="z-storage z-type z-sql">integer</span>,
    next  <span class="z-storage z-type z-sql">integer</span>
) RETURNS <span class="z-storage z-type z-sql">integer</span>
LANGUAGE SQL
STRICT
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> $$
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> $<span class="z-constant z-numeric z-sql">1</span> <span class="z-keyword z-operator z-math z-sql">+</span> $<span class="z-constant z-numeric z-sql">2</span>;
$$;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_sum</span></span>(<span class="z-storage z-type z-sql">integer</span>)
(
    SFUNC    <span class="z-keyword z-operator z-comparison z-sql">=</span> example_sum_state, <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> State function
</span>    STYPE    <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">integer</span>,           <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> State type
</span>    INITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>0<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>                <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> Must be a string or null
</span>);

<span class="z-keyword z-other z-DML z-sql">SELECT</span> example_sum(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">1</span>, <span class="z-constant z-numeric z-sql">2</span>, <span class="z-constant z-numeric z-sql">3</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  example_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> -------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>            6
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>Conceptually, the aggregate loops over each item in the input and runs the <code>SFUNC</code> function on the current state as well as each value. That code is analogous to:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">example_sum</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span><span class="z-variable z-parameter z-rust">values</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">isize</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-storage z-type z-rust">isize</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">let</span> <span class="z-storage z-modifier z-rust">mut</span> sum <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-numeric z-integer z-decimal z-rust">0</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-keyword z-control z-rust">for</span> value <span class="z-keyword z-operator z-rust">in</span> values <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        sum <span class="z-keyword z-operator z-assignment z-rust">+=</span> value<span class="z-punctuation z-terminator z-rust">;</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span>
    sum
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Aggregates are more than just a loop, though. If the aggregate specifies a <code>combinefunc</code> PostgreSQL can run different instances of the aggregate over subsets of the data, then combine them later. This is called <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/xaggr.html#XAGGR-PARTIAL-AGGREGATES"><em>partial aggregation</em></a> and enables different worker processes to handle data in parallel. Let's make our <code>example_sum</code> aggregate above have a <code>combinefunc</code>:</p>
<p><em>(Readers may note we could use <code>example_sum_state</code> in this particular case, but not in general, so we're gonna make a new function for demonstration.)</em></p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_sum_combine</span></span>(
    first   <span class="z-storage z-type z-sql">integer</span>,
    second  <span class="z-storage z-type z-sql">integer</span>
) RETURNS <span class="z-storage z-type z-sql">integer</span>
LANGUAGE SQL
STRICT
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> $$
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> $<span class="z-constant z-numeric z-sql">1</span> <span class="z-keyword z-operator z-math z-sql">+</span> $<span class="z-constant z-numeric z-sql">2</span>;
$$;

<span class="z-meta z-drop z-sql"><span class="z-keyword z-other z-create z-sql">DROP</span> <span class="z-keyword z-other z-sql">AGGREGATE</span></span> example_sum(<span class="z-storage z-type z-sql">integer</span>);

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_sum</span></span>(<span class="z-storage z-type z-sql">integer</span>)
(
    SFUNC    <span class="z-keyword z-operator z-comparison z-sql">=</span> example_sum_state,
    STYPE    <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">integer</span>,
    INITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>0<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>,
    combinefunc <span class="z-keyword z-operator z-comparison z-sql">=</span> example_sum_combine
);

<span class="z-keyword z-other z-DML z-sql">SELECT</span> example_sum(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> generate_series(<span class="z-constant z-numeric z-sql">0</span>, <span class="z-constant z-numeric z-sql">4000</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  example_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> -------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      8002000
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>Here's one using <code>FINALFUNC</code>, which offers a way to compute some final value from the state:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_uniq_state</span></span>(
    state <span class="z-storage z-type z-sql">text</span>[],
    next  <span class="z-storage z-type z-sql">text</span>
) RETURNS <span class="z-storage z-type z-sql">text</span>[]
LANGUAGE SQL
STRICT
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> $$
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> array_append($<span class="z-constant z-numeric z-sql">1</span>, $<span class="z-constant z-numeric z-sql">2</span>);
$$;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_uniq_final</span></span>(
    state <span class="z-storage z-type z-sql">text</span>[]
) RETURNS <span class="z-storage z-type z-sql">integer</span>
LANGUAGE SQL
STRICT
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> $$
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> <span class="z-support z-function z-aggregate z-sql">count</span>(DISTINCT value) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(state) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value
$$;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_uniq</span></span>(<span class="z-storage z-type z-sql">text</span>)
(
    SFUNC     <span class="z-keyword z-operator z-comparison z-sql">=</span> example_uniq_state, <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> State function
</span>    STYPE     <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">text</span>[],             <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> State type
</span>    INITCOND  <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>{}<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>,               <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> Must be a string or null
</span>    FINALFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> example_uniq_final  <span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> Final function
</span>);

<span class="z-keyword z-other z-DML z-sql">SELECT</span> example_uniq(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  example_uniq 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> --------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>             2
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>This is particularly handy as your <code>STYPE</code> doesn't need to be the type you return!</p>
<p>Aggregates can take multiple arguments, too:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_concat_state</span></span>(
    state <span class="z-storage z-type z-sql">text</span>[],
    first <span class="z-storage z-type z-sql">text</span>,
    second <span class="z-storage z-type z-sql">text</span>,
    third <span class="z-storage z-type z-sql">text</span>
) RETURNS <span class="z-storage z-type z-sql">text</span>[]
LANGUAGE SQL
STRICT
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> $$
    <span class="z-keyword z-other z-DML z-sql">SELECT</span> array_append($<span class="z-constant z-numeric z-sql">1</span>, concat($<span class="z-constant z-numeric z-sql">2</span>, $<span class="z-constant z-numeric z-sql">3</span>, $<span class="z-constant z-numeric z-sql">4</span>));
$$;

<span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">example_concat</span></span>(<span class="z-storage z-type z-sql">text</span>, <span class="z-storage z-type z-sql">text</span>, <span class="z-storage z-type z-sql">text</span>)
(
    SFUNC     <span class="z-keyword z-operator z-comparison z-sql">=</span> example_concat_state,
    STYPE     <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">text</span>[],
    INITCOND  <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>{}<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>
);

<span class="z-keyword z-other z-DML z-sql">SELECT</span> example_concat(first, second, third) <span class="z-keyword z-other z-DML z-sql">FROM</span>
    UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> first,
    UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>2<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>3<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> second,
    UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>!<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>@<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>#<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> third;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>                                                 example_concat                                                 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ---------------------------------------------------------------------------------------------------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  {a1!,a2!,a3!,b1!,b2!,b3!,c1!,c2!,c3!,a1@,a2@,a3@,b1@,b2@,b3@,c1@,c2@,c3@,a1#,a2#,a3#,b1#,b2#,b3#,c1#,c2#,c3#}
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>See how we see <code>a1</code>, <code>b1</code>, and <code>c1</code>? Multiple arguments might not work as you expect! As you can see, each argument is passed with each other argument.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>c<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> first,
       UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>1<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>2<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>3<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> second,
       UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>!<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>@<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>#<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> third;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  first | second | third 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> -------+--------+-------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  a     | 1      | !
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  b     | 2      | @
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  c     | 3      | #
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (3 rows)
</span></span></code></pre>
<p>Aggregates have several more optional fields, such as a <code>PARALLEL</code>. Their signatures are documented in the <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/sql-createaggregate.html"><code>CREATE AGGREGATE</code></a> documentation and this article isn't meant to be comprehensive.</p>
<blockquote>
<p><strong>Reminder:</strong> You can also create functions with <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/plpgsql.html"><code>pl/pgsql</code></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/xfunc-c.html"><code>c</code></a>, <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/plpython.html">pl/Python</a>, or even in the experimental <a rel="noopener" target="_blank" href="https://github.com/zombodb/plrust"><code>pl/Rust</code></a>.</p>
</blockquote>
<p>Extensions can, of course, create aggregates too. Next, let's explore how to do that with Rust using <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a> 0.3.0's Aggregate support.</p>
<h1 id="familiarizing-with-pgx">Familiarizing with <code>pgx</code></h1>
<p><a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a> is a suite of crates that provide everything required to build, test, and package extensions for PostgreSQL versions 10 through 14 using pure Rust.</p>
<p>It includes:</p>
<ul>
<li><code>cargo-pgx</code>: A <code>cargo</code> plugin that provides commands like <code>cargo pgx package</code> and <code>cargo pgx test</code>,</li>
<li><code>pgx</code>: A crate providing macros, high level abstractions (such as SPI), and low level generated bindings for PostgreSQL.</li>
<li><code>pgx-tests</code>: A crate providing a test framework for running tests inside PostgreSQL.</li>
</ul>
<p><strong>Note:</strong> <code>pgx</code> does not currently offer Windows support, but works great in <a rel="noopener" target="_blank" href="https://docs.microsoft.com/en-us/windows/wsl/install">WSL2</a>.</p>
<p>If a Rust toolchain is not already installed, please follow the instructions on <a rel="noopener" target="_blank" href="https://rustup.rs/">rustup.rs</a>.</p>
<p>You'll also <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx#system-requirements">need to make sure you have some development libraries</a> like <code>zlib</code> and <code>libclang</code>, as 
<code>cargo pgx init</code> will, by default, build it's own development PostgreSQL installs. Usually it's possible to
figure out if something is missing from error messages and then discover the required package for the system.</p>
<p>Install <code>cargo-pgx</code> then initialize its development PostgreSQL installations (used for <code>cargo pgx test</code> and <code>cargo pgx run</code>):</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo install cargo-pgx</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx init</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span></span></code></pre>
<p>We can create a new extension with:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx new exploring_aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cd exploring_aggregates</span>
</span></code></pre>
<p>Then run it:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx run</span>
<span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> ...</span><span class="z-comment z-line z-number-sign z-shell">
</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">building</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension with features <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>build<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> dev <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.06s</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">installing</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension</span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> control file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates.control</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> shared library to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/lib/postgresql/exploring_aggregates.so</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
 <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovering</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL entities</span>
  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 SQL entities: 0 schemas (0 unique</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 functions, 0 types, 0 enums, 0 sqls, 0 ords, 0 hashes</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/debug/sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension schema file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> installing exploring_aggregates</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Starting</span></span><span class="z-meta z-function-call z-arguments z-shell"> Postgres v13 on port 28813</span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Creating</span></span><span class="z-meta z-function-call z-arguments z-shell"> database exploring_aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">psql</span></span><span class="z-meta z-function-call z-arguments z-shell"> (13.5</span><span class="z-meta z-function-call z-shell"></span>)
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Type</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>help<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> for help.</span>

<span class="z-variable z-other z-readwrite z-assignment z-shell">exploring_aggregates</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">#</span> 
</span></code></pre>
<p>Observing the start of the <code>src/lib.rs</code> file, we can see the <code>pg_module_magic!()</code> and a function <code>hello_exploring_aggregates</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-support z-macro z-rust">pg_module_magic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_extern</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">hello_exploring_aggregates</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span></span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>Hello, exploring_aggregates<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Back on our <code>psql</code> prompt, we can load the extension and run the function:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql">CREATE EXTENSION exploring_aggregates;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> CREATE EXTENSION
</span>
\dx<span class="z-keyword z-operator z-math z-sql">+</span> exploring_aggregates
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> Objects in extension &quot;exploring_aggregates&quot;
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>           Object description           
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ---------------------------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  function hello_exploring_aggregates()
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> hello_exploring_aggregates<span class="z-meta z-block z-sql"><span class="z-punctuation z-section z-scope z-begin z-sql">(</span><span class="z-punctuation z-section z-scope z-end z-sql">)</span></span>;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  hello_exploring_aggregates  
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> -----------------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  Hello, exploring_aggregates
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>Next, let's run the tests:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx test</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>test<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--features<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span> pg_test<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> test <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.08s</span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Running</span></span><span class="z-meta z-function-call z-arguments z-shell"> unittests (target/debug/deps/exploring_aggregates-4783beb51375d29c</span><span class="z-meta z-function-call z-shell"></span>)

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 test</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">building</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension with features <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">pg_test</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>build<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--features<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span> pg_test<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> dev <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.41s</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">installing</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension</span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> control file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates.control</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> shared library to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/lib/postgresql/exploring_aggregates.so</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
 <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovering</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL entities</span>
  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3 SQL entities: 1 schemas (1 unique</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 2 functions, 0 types, 0 enums, 0 sqls, 0 ords, 0 hashes, 0 aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/debug/sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension schema file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> installing exploring_aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">test</span></span><span class="z-meta z-function-call z-arguments z-shell"> tests::pg_test_hello_exploring_aggregates ... ok</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">test</span></span><span class="z-meta z-function-call z-arguments z-shell"> result: ok. 1 passed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> failed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> ignored</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> measured</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> filtered out</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> in 2.44s</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Stopping</span></span><span class="z-meta z-function-call z-arguments z-shell"> Postgres</span>

     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Running</span></span><span class="z-meta z-function-call z-arguments z-shell"> unittests (target/debug/deps/sql_generator-1bb38131b30894e5</span><span class="z-meta z-function-call z-shell"></span>)

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0 tests</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">test</span></span><span class="z-meta z-function-call z-arguments z-shell"> result: ok. 0 passed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> failed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> ignored</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> measured</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> filtered out</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> in 0.00s</span>

   <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Doc-tests</span></span><span class="z-meta z-function-call z-arguments z-shell"> exploring_aggregates</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0 tests</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">test</span></span><span class="z-meta z-function-call z-arguments z-shell"> result: ok. 0 passed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> failed</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> ignored</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> measured</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">0</span></span><span class="z-meta z-function-call z-arguments z-shell"> filtered out</span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> in 0.00s</span>
</span></code></pre>
<p>We can also inspect the SQL the extension generates:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx schema</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Building</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator with features <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>build<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--bin<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> dev <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.06s</span>
 <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovering</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL entities</span>
  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 SQL entities: 0 schemas (0 unique</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 functions, 0 types, 0 enums, 0 sqls, 0 ords, 0 hashes, 0 aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/debug/sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>sql/exploring_aggregates-0.0.0.sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
</span></code></pre>
<p>This creates <code>sql/exploring_aggregates-0.0.0.sql</code>:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> 
This file is auto generated by pgx.

The ordering of items is not stable, it is driven by a dependency graph.
*/</span>

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:5
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::hello_exploring_aggregates
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE OR REPLACE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">&quot;<span class="z-entity z-name z-function z-sql">hello_exploring_aggregates</span>&quot;</span><span class="z-meta z-block z-sql"><span class="z-punctuation z-section z-scope z-begin z-sql">(</span><span class="z-punctuation z-section z-scope z-end z-sql">)</span></span> RETURNS <span class="z-storage z-type z-sql">text</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> &amp;str */</span>
STRICT
LANGUAGE c <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> Rust */</span>
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>MODULE_PATHNAME<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>hello_exploring_aggregates_wrapper<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;
</span></code></pre>
<p>Finally we can create a package for the <code>pg_config</code> version installed on the system, this is done in release mode, so it takes a few minutes:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx package</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">building</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension with features <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>build<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--release<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> release <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>optimized<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.07s</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">installing</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension</span>
 <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovering</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL entities</span>
  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 SQL entities: 0 schemas (0 unique</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 1 functions, 0 types, 0 enums, 0 sqls, 0 ords, 0 hashes, 0 aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/release/sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/release/exploring_aggregates-pg13/usr/share/postgresql/13/extension/exploring_aggregates--0.0.0.sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension schema file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">target/release/exploring_aggregates-pg13/usr/share/postgresql/13/extension/exploring_aggregates--0.0.0.sql</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> installing exploring_aggregates</span>
</span></code></pre>
<p>Let's make some aggregates with <code>pgx</code> now!</p>
<h1 id="aggregates-with-pgx">Aggregates with <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a></h1>
<p>While designing the aggregate support for <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a> 0.3.0 we wanted to try to make things feel idiomatic and natural from the Rust side,
but it should be flexible enough for any use.</p>
<p>Aggregates in <code>pgx</code> are defined by creating a type (this doesn't necessarily need to be the state type), then using the <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/attr.pg_aggregate.html"><code>#[pg_aggregate]</code></a>
procedural macro on an <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html"><code>pgx::Aggregate</code></a> implementation for that type.</p>
<p>The <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html"><code>pgx::Aggregate</code></a> trait has quite a few items (<code>fn</code>s, <code>const</code>s, <code>type</code>s) that you can implement, but the procedural macro can fill in
stubs for all non-essential items. The state type (the implementation target by default) must have a <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/derive.PostgresType.html"><code>#[derive(PostgresType)]</code></a> declaration,
or be a type PostgreSQL already knows about.</p>
<p>Here's the simplest aggregate you can make with <code>pgx</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">serde<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-support z-macro z-rust">pg_module_magic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Copy<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Default<span class="z-punctuation z-separator z-rust">,</span> Debug<span class="z-punctuation z-separator z-rust">,</span> PostgresType<span class="z-punctuation z-separator z-rust">,</span> Serialize<span class="z-punctuation z-separator z-rust">,</span> Deserialize</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">DemoSum</span> </span><span class="z-meta z-struct z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-variable z-other z-member z-rust">count</span><span class="z-punctuation z-separator z-type z-rust">:</span> <span class="z-storage z-type z-rust">i32</span>,
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoSum</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">INITIAL_CONDITION</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-raw z-rust"><span class="z-storage z-type z-string z-rust">r</span><span class="z-punctuation z-definition z-string z-begin z-rust">#&quot;</span>{ &quot;count&quot;: 0 }<span class="z-punctuation z-definition z-string z-end z-rust">&quot;#</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Args</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        current<span class="z-punctuation z-accessor z-dot z-rust">.</span>count <span class="z-keyword z-operator z-assignment z-rust">+=</span> arg<span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We can review the generated SQL (generated via <code>cargo pgx schema</code>):</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> 
This file is auto generated by pgx.

The ordering of items is not stable, it is driven by a dependency graph.
*/</span>

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:6
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoSum
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TYPE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">DemoSum</span></span>;

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:6
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::demosum_in
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE OR REPLACE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">&quot;<span class="z-entity z-name z-function z-sql">demosum_in</span>&quot;</span>(
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>input<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> cstring <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> &amp;cstr_core::CStr */</span>
) RETURNS DemoSum <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum */</span>
IMMUTABLE PARALLEL SAFE STRICT
LANGUAGE c <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> Rust */</span>
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>MODULE_PATHNAME<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>demosum_in_wrapper<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:6
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::demosum_out
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE OR REPLACE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">&quot;<span class="z-entity z-name z-function z-sql">demosum_out</span>&quot;</span>(
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>input<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> DemoSum <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum */</span>
) RETURNS cstring <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> &amp;cstr_core::CStr */</span>
IMMUTABLE PARALLEL SAFE STRICT
LANGUAGE c <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> Rust */</span>
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>MODULE_PATHNAME<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>demosum_out_wrapper<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:6
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoSum
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">TYPE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">DemoSum</span></span> (
	INTERNALLENGTH <span class="z-keyword z-operator z-comparison z-sql">=</span> variable,
	INPUT <span class="z-keyword z-operator z-comparison z-sql">=</span> demosum_in, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::demosum_in */</span>
	OUTPUT <span class="z-keyword z-operator z-comparison z-sql">=</span> demosum_out, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::demosum_out */</span>
	STORAGE <span class="z-keyword z-operator z-comparison z-sql">=</span> extended
);

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:11
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::demo_sum_state
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE OR REPLACE</span> <span class="z-keyword z-other z-sql">FUNCTION</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql">&quot;<span class="z-entity z-name z-function z-sql">demo_sum_state</span>&quot;</span>(
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>this<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> DemoSum, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum */</span>
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>arg_one<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> <span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
) RETURNS DemoSum <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum */</span>
STRICT
LANGUAGE c <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> Rust */</span>
<span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>MODULE_PATHNAME<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>demo_sum_state_wrapper<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>;

<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:11
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoSum
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">DemoSum</span></span> (
	<span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
)
(
	SFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_state<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::state */</span>
	STYPE <span class="z-keyword z-operator z-comparison z-sql">=</span> DemoSum, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum */</span>
	INITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>{ &quot;count&quot;: 0 }<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::INITIAL_CONDITION */</span>
);
</span></code></pre>
<p>We can test it out with <code>cargo pgx run</code>:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">$</span></span><span class="z-meta z-function-call z-arguments z-shell"> cargo pgx run</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Stopping</span></span><span class="z-meta z-function-call z-arguments z-shell"> Postgres v13</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">building</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension with features <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>cargo<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>build<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> dev <span class="z-keyword z-control z-regexp z-set z-begin z-shell">[</span>unoptimized + debuginfo<span class="z-keyword z-control z-regexp z-set z-end z-shell">]</span> target(s</span><span class="z-meta z-function-call z-shell"></span>) <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">in</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0.06s</span>

<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">installing</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension</span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> control file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates.control</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> shared library to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/lib/postgresql/exploring_aggregates.so</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
 <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovering</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL entities</span>
  <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Discovered</span></span><span class="z-meta z-function-call z-arguments z-shell"> 5 SQL entities: 0 schemas (0 unique</span><span class="z-meta z-function-call z-shell"></span>)<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">,</span></span><span class="z-meta z-function-call z-arguments z-shell"> 3 functions, 1 types, 0 enums, 0 sqls, 0 ords, 0 hashes, 1 aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">running</span></span><span class="z-meta z-function-call z-arguments z-shell"> SQL generator</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell"><span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/git/samples/exploring_aggregates/target/debug/sql-generator<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>--sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span>
     <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Copying</span></span><span class="z-meta z-function-call z-arguments z-shell"> extension schema file to <span class="z-meta z-group z-expansion z-command z-backticks z-shell"><span class="z-punctuation z-section z-group z-begin z-shell">`</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">/home/ana/.pgx/13.5/pgx-install/share/postgresql/extension/exploring_aggregates--0.0.0.sql</span></span><span class="z-punctuation z-section z-group z-end z-shell">`</span></span></span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Finished</span></span><span class="z-meta z-function-call z-arguments z-shell"> installing exploring_aggregates</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Starting</span></span><span class="z-meta z-function-call z-arguments z-shell"> Postgres v13 on port 28813</span>
    <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Re-using</span></span><span class="z-meta z-function-call z-arguments z-shell"> existing database exploring_aggregates</span>
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">psql</span></span><span class="z-meta z-function-call z-arguments z-shell"> (13.5</span><span class="z-meta z-function-call z-shell"></span>)
<span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">Type</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>help<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> for help.</span>

<span class="z-variable z-other z-readwrite z-assignment z-shell">exploring_aggregates</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell">#</span> 
</span></code></pre>
<p>Now we're connected via <code>psql</code>:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql">CREATE EXTENSION exploring_aggregates;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> CREATE EXTENSION
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> DemoSum(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> generate_series(<span class="z-constant z-numeric z-sql">0</span>, <span class="z-constant z-numeric z-sql">4000</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>       demosum      
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> -------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  {&quot;count&quot;:8002000}
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>Pretty cool!</p>
<p>...But we don't want that silly <code>{&quot;count&quot;: ... }</code> stuff, just the number! We can resolve this by changing the <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedtype.State"><code>State</code></a> type, or by adding a <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#tymethod.finalize"><code>finalize</code></a> (which maps to <code>ffunc</code>) as we saw in the previous section.</p>
<p>Let's change the <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedtype.State"><code>State</code></a> this time:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Copy<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Default<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">DemoSum</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoSum</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">INITIAL_CONDITION</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-raw z-rust"><span class="z-storage z-type z-string z-rust">r</span><span class="z-punctuation z-definition z-string z-begin z-rust">#&quot;</span>0<span class="z-punctuation z-definition z-string z-end z-rust">&quot;#</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Args</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">State</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        current <span class="z-keyword z-operator z-assignment z-rust">+=</span> arg<span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>Now when we run it:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> DemoSum(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> generate_series(<span class="z-constant z-numeric z-sql">0</span>, <span class="z-constant z-numeric z-sql">4000</span>) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demosum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ---------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  8002000
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>This is a fine reimplementation of <code>SUM</code> so far, but as we saw previously we need a <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#tymethod.combine"><code>combine</code></a> (mapping to <code>combinefunc</code>) to support partial aggregation:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoSum</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span>    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">combine</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">first</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">second</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        first <span class="z-keyword z-operator z-assignment z-rust">+=</span> second<span class="z-punctuation z-terminator z-rust">;</span>
        first
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We can also change the name of the generated aggregate, or set the <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedconstant.PARALLEL"><code>PARALLEL</code></a> settings, for example:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoSum</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span>    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">NAME</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>demo_sum<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">PARALLEL</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>ParallelOption<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">aggregate<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ParallelOption<span class="z-punctuation z-accessor z-rust">::</span></span>Unsafe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> ...
</span></span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This generates:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:9
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoSum
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">demo_sum</span></span> (
	<span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
)
(
	SFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_state<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::state */</span>
	STYPE <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">integer</span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
	COMBINEFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_combine<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::combine */</span>
	INITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>0<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::INITIAL_CONDITION */</span>
	PARALLEL <span class="z-keyword z-operator z-comparison z-sql">=</span> UNSAFE <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::PARALLEL */</span>
);
</span></code></pre>
<h2 id="rust-state-types">Rust state types</h2>
<p>It's possible to use a non-SQL (say, <a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/collections/struct.HashSet.html"><code>HashSet&lt;String&gt;</code></a>) type as a state by using <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/datum/struct.Internal.html"><code>Internal</code></a>.</p>
<blockquote>
<p>When using this strategy, <strong>a <code>finalize</code> function must be provided.</strong></p>
</blockquote>
<p>Here's a unique string counter aggregate that uses a <code>HashSet</code>:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-keyword z-operator z-arithmetic z-rust">*</span><span class="z-punctuation z-terminator z-rust">;</span>
<span class="z-keyword z-other z-rust">use</span> <span class="z-meta z-path z-rust">std<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">collections<span class="z-punctuation z-accessor z-rust">::</span></span>HashSet<span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-support z-macro z-rust">pg_module_magic!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Copy<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Default<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">DemoUnique</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoUnique</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Args</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">State</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> Internal<span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Finalize</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> current<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">insert</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>arg<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">to_string</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">combine</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">first</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">second</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> first_inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> first<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-storage z-type z-rust">let</span> second_inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> second<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        <span class="z-storage z-type z-rust">let</span> unioned<span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">_</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> first_inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">union</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>second_inner</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">collect</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-meta z-path z-rust">Internal<span class="z-punctuation z-accessor z-rust">::</span></span>new<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>unioned</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">finalize</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">_direct_arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>OrderedSetArgs,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Finalize</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> current<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust">HashSet<span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-support z-type z-rust">String</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">i32</span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>We can test it:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> DemoUnique(value) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>a<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>b<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demounique 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>           2
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<p>Using <code>Internal</code> here means that the values it holds get dropped at the end of <a rel="noopener" target="_blank" href="https://github.com/postgres/postgres/blob/7c1aead6cbe7dcc6c216715fed7a1fb60684c5dc/src/backend/utils/mmgr/README#L72"><code> PgMemoryContexts::CurrentMemoryContext</code></a>, the aggregate context in this case.</p>
<h2 id="ordered-set-aggregates">Ordered-Set Aggregates</h2>
<p>PostgreSQL also supports what are called <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/xaggr.html#XAGGR-ORDERED-SET-AGGREGATES"><em>Ordered-Set Aggregates</em></a>. Ordered-Set Aggregates can take a <strong>direct argument</strong>, and specify a sort ordering for the inputs.</p>
<blockquote>
<p>PostgreSQL does <em>not</em> order inputs behind the scenes!</p>
</blockquote>
<p>Let's create a simple <code>percentile_disc</code> reimplementation to get an idea of how to make one with <code>pgx</code>. You'll notice we add <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedconstant.ORDERED_SET"><code>ORDERED_SET = true</code></a> and set an (optional) <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedtype.OrderedSetArgs"><code>OrderedSetArgs</code></a>, which determines the direct arguments.</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Copy<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Default<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">DemoPercentileDisc</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoPercentileDisc</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Args</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">name!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>input<span class="z-punctuation z-separator z-rust">,</span> <span class="z-storage z-type z-rust">i32</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">State</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> Internal<span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Finalize</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">ORDERED_SET</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-storage z-type z-rust">bool</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-constant z-language z-rust">true</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">OrderedSetArgs</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-macro z-rust">name!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>percentile<span class="z-punctuation z-separator z-rust">,</span> <span class="z-storage z-type z-rust">f64</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> current<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">push</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>arg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">finalize</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">direct_arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>OrderedSetArgs,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Finalize</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-storage z-type z-rust">let</span> inner <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-modifier z-rust">unsafe</span> <span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span> current<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-meta z-path z-rust">get_or_insert_default<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-generic z-rust"><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Vec</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        <span class="z-comment z-line z-double-slash z-rust"><span class="z-punctuation z-definition z-comment z-rust">//</span> This isn&#39;t done for us!
</span>        inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">sort</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

        <span class="z-storage z-type z-rust">let</span> target_index <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span>inner<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">len</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">f64</span> <span class="z-keyword z-operator z-arithmetic z-rust">*</span> direct_arg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">round</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span> <span class="z-keyword z-operator z-rust">as</span> <span class="z-storage z-type z-rust">usize</span><span class="z-punctuation z-terminator z-rust">;</span>
        inner<span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">[</span>target_index<span class="z-punctuation z-accessor z-dot z-rust">.</span><span class="z-support z-function z-rust">saturating_sub</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-constant z-numeric z-integer z-decimal z-rust">1</span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This creates SQL like:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:9
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoPercentileDisc
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">DemoPercentileDisc</span></span> (
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>percentile<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> <span class="z-storage z-type z-sql">double precision</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> f64 */</span>
	<span class="z-keyword z-other z-DML z-sql">ORDER BY</span>
	<span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>input<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> <span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
)
(
	SFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_percentile_disc_state<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoPercentileDisc::state */</span>
	STYPE <span class="z-keyword z-operator z-comparison z-sql">=</span> internal, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> pgx::datum::internal::Internal */</span>
	FINALFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_percentile_disc_finalize<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoPercentileDisc::final */</span>
);
</span></code></pre>
<p>We can test it like so:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> DemoPercentileDisc(<span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">5</span>) WITHIN GROUP (<span class="z-keyword z-other z-DML z-sql">ORDER BY</span> income) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">6000</span>, <span class="z-constant z-numeric z-sql">70000</span>, <span class="z-constant z-numeric z-sql">500</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> income;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demopercentiledisc 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> --------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>                6000
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> DemoPercentileDisc(<span class="z-constant z-numeric z-sql">0</span>.<span class="z-constant z-numeric z-sql">05</span>) WITHIN GROUP (<span class="z-keyword z-other z-DML z-sql">ORDER BY</span> income) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">5</span>, <span class="z-constant z-numeric z-sql">100000000</span>, <span class="z-constant z-numeric z-sql">6000</span>, <span class="z-constant z-numeric z-sql">70000</span>, <span class="z-constant z-numeric z-sql">500</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> income;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demopercentiledisc 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> --------------------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>                   5
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (1 row)
</span></span></code></pre>
<h2 id="moving-aggregate-mode">Moving-Aggregate mode</h2>
<p>Aggregates can also support <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/xaggr.html#XAGGR-MOVING-AGGREGATES"><em>moving-aggregate mode</em></a>, which can <strong>remove</strong> inputs from the aggregate as well.</p>
<p>This allows for some optimization if you are using aggregates as window functions. The documentation explains that this is because PostgreSQL doesn't need to recalculate the aggregate each time the frame starting point moves.</p>
<p>Moving-aggregate mode has it's own <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#tymethod.moving_state"><code>moving_state</code></a> function as well as an <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#tymethod.moving_state_inverse"><code>moving_state_inverse</code></a> function for removing inputs. Because moving-aggregate mode may require some additional tracking on the part of the aggregate, there is also a <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#associatedtype.MovingState"><code>MovingState</code></a> associated type as well as a <a rel="noopener" target="_blank" href="https://docs.rs/pgx/0.3.0/pgx/aggregate/trait.Aggregate.html#tymethod.moving_finalize"><code>moving_state_finalize</code></a> function for any specialized final computation.</p>
<p>Let's take our sum example above and add moving-aggregate mode support to it:</p>
<pre data-lang="rust" class="language-rust z-code"><code class="language-rust" data-lang="rust"><span class="z-source z-rust"><span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">derive</span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span></span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust">Copy<span class="z-punctuation z-separator z-rust">,</span> Clone<span class="z-punctuation z-separator z-rust">,</span> Default<span class="z-punctuation z-separator z-rust">,</span> Debug</span></span><span class="z-meta z-annotation z-parameters z-rust"><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span></span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-struct z-rust"><span class="z-storage z-modifier z-rust">pub</span> <span class="z-storage z-type z-struct z-rust">struct</span> </span><span class="z-meta z-struct z-rust"><span class="z-entity z-name z-struct z-rust">DemoSum</span></span><span class="z-punctuation z-terminator z-rust">;</span>

<span class="z-meta z-annotation z-rust"><span class="z-punctuation z-definition z-annotation z-rust">#</span><span class="z-punctuation z-section z-group z-begin z-rust">[</span><span class="z-variable z-annotation z-rust">pg_aggregate</span><span class="z-punctuation z-section z-group z-end z-rust">]</span></span>
<span class="z-meta z-impl z-rust"><span class="z-storage z-type z-impl z-rust">impl</span> </span><span class="z-meta z-impl z-rust">Aggregate <span class="z-keyword z-other z-rust">for</span></span><span class="z-meta z-impl z-rust"> <span class="z-entity z-name z-impl z-rust">DemoSum</span> </span><span class="z-meta z-impl z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">NAME</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-keyword z-operator z-bitwise z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>demo_sum<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">PARALLEL</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span>ParallelOption<span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">aggregate<span class="z-punctuation z-accessor z-rust">::</span></span><span class="z-meta z-path z-rust">ParallelOption<span class="z-punctuation z-accessor z-rust">::</span></span>Unsafe</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">INITIAL_CONDITION</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-raw z-rust"><span class="z-storage z-type z-string z-rust">r</span><span class="z-punctuation z-definition z-string z-begin z-rust">#&quot;</span>0<span class="z-punctuation z-definition z-string z-end z-rust">&quot;#</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-rust">const</span> <span class="z-constant z-other z-rust">MOVING_INITIAL_CONDITION</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-generic z-rust"><span class="z-support z-type z-rust">Option</span><span class="z-punctuation z-definition z-generic z-begin z-rust">&lt;</span><span class="z-keyword z-operator z-rust">&amp;</span><span class="z-storage z-modifier z-lifetime z-rust">&#39;static</span> <span class="z-storage z-type z-rust">str</span><span class="z-punctuation z-definition z-generic z-end z-rust">&gt;</span></span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-support z-type z-rust">Some</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-raw z-rust"><span class="z-storage z-type z-string z-rust">r</span><span class="z-punctuation z-definition z-string z-begin z-rust">#&quot;</span>0<span class="z-punctuation z-definition z-string z-end z-rust">&quot;#</span></span></span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">Args</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">State</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>
    <span class="z-storage z-type z-type z-rust">type</span> <span class="z-entity z-name z-type z-rust">MovingState</span> <span class="z-keyword z-operator z-assignment z-rust">=</span> <span class="z-storage z-type z-rust">i32</span><span class="z-punctuation z-terminator z-rust">;</span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span>log<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>state({}, {})<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> current<span class="z-punctuation z-separator z-rust">,</span> arg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        current <span class="z-keyword z-operator z-assignment z-rust">+=</span> arg<span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">moving_state</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>MovingState</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span>log<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>moving_state({}, {})<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> current<span class="z-punctuation z-separator z-rust">,</span> arg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        current <span class="z-keyword z-operator z-assignment z-rust">+=</span> arg<span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">moving_state_inverse</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">current</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">arg</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>Args,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>MovingState</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span>log<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>moving_state_inverse({}, {})<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> current<span class="z-punctuation z-separator z-rust">,</span> arg</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        current <span class="z-keyword z-operator z-assignment z-rust">-=</span> arg<span class="z-punctuation z-terminator z-rust">;</span>
        current
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>

    <span class="z-meta z-function z-rust"><span class="z-meta z-function z-rust"><span class="z-storage z-type z-function z-rust">fn</span> </span><span class="z-entity z-name z-function z-rust">combine</span></span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-begin z-rust">(</span>
        <span class="z-storage z-modifier z-rust">mut</span> <span class="z-variable z-parameter z-rust">first</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">second</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State,
        <span class="z-variable z-parameter z-rust">_fcinfo</span><span class="z-punctuation z-separator z-rust">:</span> <span class="z-meta z-path z-rust">pg_sys<span class="z-punctuation z-accessor z-rust">::</span></span>FunctionCallInfo,
    </span><span class="z-meta z-function z-rust"><span class="z-meta z-function z-parameters z-rust"><span class="z-punctuation z-section z-parameters z-end z-rust">)</span></span></span></span><span class="z-meta z-function z-rust"> <span class="z-meta z-function z-return-type z-rust"><span class="z-punctuation z-separator z-rust">-&gt;</span> <span class="z-meta z-path z-rust"><span class="z-storage z-type z-rust"><span class="z-storage z-type z-rust">Self</span><span class="z-punctuation z-accessor z-rust">::</span></span></span>State</span> </span><span class="z-meta z-function z-rust"><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-begin z-rust">{</span>
        <span class="z-meta z-path z-rust">pgx<span class="z-punctuation z-accessor z-rust">::</span></span>log<span class="z-keyword z-operator z-logical z-rust">!</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-begin z-rust">(</span><span class="z-string z-quoted z-double z-rust"><span class="z-punctuation z-definition z-string z-begin z-rust">&quot;</span>combine({}, {})<span class="z-punctuation z-definition z-string z-end z-rust">&quot;</span></span><span class="z-punctuation z-separator z-rust">,</span> first<span class="z-punctuation z-separator z-rust">,</span> second</span><span class="z-meta z-group z-rust"><span class="z-punctuation z-section z-group z-end z-rust">)</span></span><span class="z-punctuation z-terminator z-rust">;</span>
        first <span class="z-keyword z-operator z-assignment z-rust">+=</span> second<span class="z-punctuation z-terminator z-rust">;</span>
        first
    </span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span><span class="z-meta z-block z-rust"><span class="z-punctuation z-section z-block z-end z-rust">}</span></span></span>
</span></code></pre>
<p>This generates:</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> src/lib.rs:8
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> exploring_aggregates::DemoSum
</span><span class="z-meta z-create z-sql"><span class="z-keyword z-other z-create z-sql">CREATE</span> <span class="z-keyword z-other z-sql">AGGREGATE</span> </span><span class="z-meta z-toc-list z-full-identifier z-sql"><span class="z-entity z-name z-function z-sql">demo_sum</span></span> (
	<span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
)
(
	SFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_state<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::state */</span>
	STYPE <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">integer</span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> i32 */</span>
	COMBINEFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_combine<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::combine */</span>
	INITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>0<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::INITIAL_CONDITION */</span>
	MSFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_moving_state<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::moving_state */</span>
	MINVFUNC <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-double z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&quot;</span>demo_sum_moving_state_inverse<span class="z-punctuation z-definition z-string z-end z-sql">&quot;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::moving_state_inverse */</span>
	MINITCOND <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-string z-quoted z-single z-sql"><span class="z-punctuation z-definition z-string z-begin z-sql">&#39;</span>0<span class="z-punctuation z-definition z-string z-end z-sql">&#39;</span></span>, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::MOVING_INITIAL_CONDITION */</span>
	PARALLEL <span class="z-keyword z-operator z-comparison z-sql">=</span> UNSAFE, <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::PARALLEL */</span>
	MSTYPE <span class="z-keyword z-operator z-comparison z-sql">=</span> <span class="z-storage z-type z-sql">integer</span> <span class="z-comment z-block z-c"><span class="z-punctuation z-definition z-comment z-sql">/*</span> exploring_aggregates::DemoSum::MovingState = i32 */</span>
);
</span></code></pre>
<p>Using it (we'll also turn on logging to see what happens with <code>SET client_min_messages TO debug;</code>):</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SET</span> client_min_messages TO debug;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> SET
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> demo_sum(value) OVER (
    ROWS CURRENT ROW
) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">1</span>, <span class="z-constant z-numeric z-sql">20</span>, <span class="z-constant z-numeric z-sql">300</span>, <span class="z-constant z-numeric z-sql">4000</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 1)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 20)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 300)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 4000)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demo_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ----------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>         1
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>        20
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>       300
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4000
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (4 rows)
</span></span></code></pre>
<p>Inside the <code>OVER ()</code> we can use <a rel="noopener" target="_blank" href="https://www.postgresql.org/docs/current/sql-expressions.html#SYNTAX-WINDOW-FUNCTIONS">syntax for window function calls</a>.</p>
<pre data-lang="sql" class="language-sql z-code"><code class="language-sql" data-lang="sql"><span class="z-source z-sql"><span class="z-keyword z-other z-DML z-sql">SELECT</span> demo_sum(value) OVER (
    ROWS <span class="z-keyword z-operator z-logical z-sql">BETWEEN</span> UNBOUNDED PRECEDING <span class="z-keyword z-operator z-logical z-sql">AND</span> UNBOUNDED FOLLOWING
) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">1</span>, <span class="z-constant z-numeric z-sql">20</span>, <span class="z-constant z-numeric z-sql">300</span>, <span class="z-constant z-numeric z-sql">4000</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 1)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(1, 20)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(21, 300)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(321, 4000)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demo_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ----------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4321
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4321
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4321
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4321
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (4 rows)
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> demo_sum(value) OVER (
    ROWS <span class="z-keyword z-operator z-logical z-sql">BETWEEN</span> <span class="z-constant z-numeric z-sql">1</span> PRECEDING <span class="z-keyword z-operator z-logical z-sql">AND</span> CURRENT ROW
) <span class="z-keyword z-other z-DML z-sql">FROM</span> UNNEST(ARRAY [<span class="z-constant z-numeric z-sql">1</span>, <span class="z-constant z-numeric z-sql">20</span>, <span class="z-constant z-numeric z-sql">300</span>, <span class="z-constant z-numeric z-sql">4000</span>]) <span class="z-keyword z-operator z-assignment z-alias z-sql">as</span> value;
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 1)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(1, 20)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state_inverse(21, 1)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(20, 300)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state_inverse(320, 20)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(300, 4000)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demo_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ----------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>         1
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>        21
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>       320
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>      4300
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (4 rows)
</span>
<span class="z-keyword z-other z-DML z-sql">SELECT</span> demo_sum(value) OVER (
    <span class="z-keyword z-other z-DML z-sql">ORDER BY</span> sorter
    ROWS <span class="z-keyword z-operator z-logical z-sql">BETWEEN</span> CURRENT ROW <span class="z-keyword z-operator z-logical z-sql">AND</span> <span class="z-constant z-numeric z-sql">1</span> FOLLOWING
) <span class="z-keyword z-other z-DML z-sql">FROM</span> (
    <span class="z-keyword z-other z-DML z-II z-sql">VALUES</span> (<span class="z-constant z-numeric z-sql">1</span>, <span class="z-constant z-numeric z-sql">10000</span>),
           (<span class="z-constant z-numeric z-sql">2</span>, <span class="z-constant z-numeric z-sql">1</span>)
    ) <span class="z-keyword z-operator z-assignment z-alias z-sql">AS</span> v (sorter, value);
<span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(0, 10000)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state(10000, 1)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> LOG:  moving_state_inverse(10001, 10000)
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>  demo_sum 
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> ----------
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>     10001
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span>         1
</span><span class="z-comment z-line z-double-dash z-sql"><span class="z-punctuation z-definition z-comment z-sql">--</span> (2 rows)
</span></span></code></pre>
<h1 id="wrapping-up">Wrapping up</h1>
<p>I had a lot of fun implementing the aggregate support for <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx"><code>pgx</code></a>, and hope you have just as much fun using it! If you have questions, open up an <a rel="noopener" target="_blank" href="https://github.com/zombodb/pgx/issues">issue</a>.</p>
<p>Moving-aggregate mode is pretty new to me, and I'm still learning about it! If you have any good resources I'd love to recieve them from you!</p>
<p>If you're looking for more materials about aggregates, the TimescaleDB folks wrote about aggregates and how they impacted their hyperfunctions in <a rel="noopener" target="_blank" href="https://blog.timescale.com/blog/how-postgresql-aggregation-works-and-how-it-inspired-our-hyperfunctions-design-2/">this article</a>. Also, My pal <a rel="noopener" target="_blank" href="https://tim.mcnamara.nz/">Tim McNamara</a> wrote about how to implement harmonic and geometric means as aggregates in <a rel="noopener" target="_blank" href="https://tim.mcnamara.nz/post/177172657187/user-defined-aggregates-in-postgresql">this article</a>.</p>

    </main>
    <footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/8e892235a2f07791d624c130fea6b63f8885252b
">8e892235a2f07791d624c130fea6b63f8885252b
</a></pre></body>

</html>
