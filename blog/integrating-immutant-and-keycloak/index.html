<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>Integrating Immutant and Keycloak
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg"/>
        <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg"/>
        <meta name="twitter:site" content="@a_hoverbear"/>
        <meta name="twitter:creator" content="@a_hoverbear"/>
        
        
            <meta name="twitter:title" content="Integrating Immutant and Keycloak"/>
            <meta property='og:title' content="Integrating Immutant and Keycloak"/>
        

        
            <meta property='og:url' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;integrating-immutant-and-keycloak&#x2F;"/>
        

        
            <meta name="twitter:description" content="In my past two posts, we took a surface level look at Immutant then took a look at deploying immutant applications to the Wildfly application server. This time, we&#x27;ll take a look at how to integrate Keycloak with an Immutant app, again using Docker heavily.

If you haven&#x27;t read the previous few articles, it might be useful to give them a quick glance over.

"/>
            <meta property='og:description' content="In my past two posts, we took a surface level look at Immutant then took a look at deploying immutant applications to the Wildfly application server. This time, we&#x27;ll take a look at how to integrate Keycloak with an Immutant app, again using Docker heavily.

If you haven&#x27;t read the previous few articles, it might be useful to give them a quick glance over.

"/>
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- <a href="https://unsplash.com/photos/-N0cgDSF_MI">Kobi Li</a></figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bc53a992eae12b8000.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;fd9cec75a970c38f00.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            Integrating Immutant and Keycloak
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <h5 class="description">
                    A computer scientist working in open source towards a more hopeful future.
                </h5>

            <p class="date">
                    Posted on 2014-07-25, around 10 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#keycloak">Keycloak</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#erecting-keycloak">Erecting Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#getting-into-keycloak">Getting into Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#creating-an-application">Creating an Application</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#creating-some-users">Creating Some Users</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#immutant">Immutant</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#setting-up-the-immutant-application">Setting Up the Immutant Application</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#planning-the-routes">Planning the Routes</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#integrating-keycloak">Integrating Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#building-the-container">Building the container</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#running">Running</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#exploring">Exploring</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#user-routes">User routes</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#admin-routes">Admin routes</a>
                    </li>
                    
                </ol>
                
            </li>
            
        </ol>
    </nav>

        <p>In my past two posts, we took a <a href="/2014/07/14/starting-with-immutant/">surface level look at Immutant</a> then took a look at <a href="/2014/07/22/deploying-immutant-to-wildfly/">deploying immutant applications to the Wildfly application server.</a> This time, we'll take a look at how to integrate Keycloak with an Immutant app, again using Docker heavily.</p>
<blockquote>
<p>If you haven't read the previous few articles, it might be useful to give them a quick glance over.</p>
</blockquote>
<span id="continue-reading"></span><h2 id="keycloak">Keycloak</h2>
<h3 id="erecting-keycloak">Erecting Keycloak</h3>
<p><a rel="noopener" target="_blank" href="http://keycloak.jboss.org/">Keycloak</a> is an integrated Single-Sign-On and Identity Management platform from the fine folks of JBoss. A Docker image of Keycloak is available <a rel="noopener" target="_blank" href="https://www.jboss.org/docker/">here</a>, just like Immutant, Wildfly, and a few others.</p>
<p>To pull the Keycloak image:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> pull jboss/keycloak</span>
</span></code></pre>
<p>Then, to erect the container (<a rel="noopener" target="_blank" href="https://github.com/jboss/dockerfiles/blob/master/keycloak/server/README.md">Source</a>):</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>it</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> keycloak<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> 8080:8080<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> 9090:9090 jboss/keycloak</span>
</span></code></pre>
<blockquote>
<p>Use the  <code>-d</code> flag to daemonize the service so it doesn't die with the tty. You can check the logs later with <code>docker logs -f keycloak</code></p>
</blockquote>
<p>Finally, you should be able to browse to <a rel="noopener" target="_blank" href="http://localhost:8080/">http://localhost:8080/</a> and see the friendly Wildfly logo and welcome screen. Visiting <a rel="noopener" target="_blank" href="http://localhost:8080/auth/">http://localhost:8080/auth/</a> should yield a Keycloak welcome screen.</p>
<h3 id="getting-into-keycloak">Getting into Keycloak</h3>
<p>Visiting <a rel="noopener" target="_blank" href="http://localhost:8080/auth/admin/">http://localhost:8080/auth/admin/</a> should bring you to a very <em>blue</em> login screen. The Keycloak docker image starts with a pre-created <code>admin</code> account for you to log in with.</p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
<p>After logging in, Keycloak should prompt for a password change.</p>
<h3 id="creating-an-application">Creating an Application</h3>
<p>Browse to the <strong>Applications</strong> menu and hit the blue <strong>Add Application</strong> button. For this exploration, I'm creating a <code>learning</code> application.</p>
<p><strong>Name:</strong> learning</p>
<p><strong>Enabled:</strong> ON</p>
<p><strong>Access Type:</strong> confidential</p>
<p><strong>Redirect URI:</strong> http://localhost:8081/*</p>
<p>After hitting save, you'll have the opportunity to add more information. For this exploration, we don't need to add any more information here.</p>
<p>Visiting the <strong>Roles</strong> tab at the top, hit <strong>Add Role</strong> and create a pair of roles:</p>
<ul>
<li><code>user</code></li>
<li><code>admin</code></li>
</ul>
<p>There are several other tabs which contain many more interesting configuration options, but we'll leave these alone for now.</p>
<h3 id="creating-some-users">Creating Some Users</h3>
<p>In our exploration, we'll utilize both of the scopes above to see how to allow different roles to access different parts of the site.</p>
<p>Browse over to the <strong>Users</strong> menu. Beside the search box, hit <strong>View all Users</strong>. You should see <code>admin</code> already created. Create a <code>user</code> user, the rest of the information you can use anything, or nothing.</p>
<p>Going back to the user listing. Select the <code>admin</code> user and go to the <strong>Role Mappings</strong> tab. At the bottom in &quot;Application Roles&quot; select <code>learning</code> from the dropdown. Add the <code>admin</code> role for the admin user. Then, repeat the steps for the <code>user</code> user, but only assign them the <code>user</code> role, not <code>admin</code>.</p>
<p><em>What does this all mean?</em> The <code>admin</code> user should be able to access every page the <code>admin</code> role can. The <code>user</code> user should <em>not</em> be able to access the <code>admin</code> role's pages.</p>
<h2 id="immutant">Immutant</h2>
<h3 id="setting-up-the-immutant-application">Setting Up the Immutant Application</h3>
<p>Start up a new lein project with:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">lein</span></span><span class="z-meta z-function-call z-arguments z-shell"> new app learning</span>
</span></code></pre>
<p>Your <code>learning/project.clj</code> needs to be modified to look similar to this:</p>
<pre data-lang="clojure" class="language-clojure z-code"><code class="language-clojure" data-lang="clojure"><span class="z-source z-clojure"><span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defproject</span> <span class="z-entity z-name z-function z-clojure">learning</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>0.1.0-SNAPSHOT<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>description</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>FIXME: write description<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>url</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>http://example.com/FIXME<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>license</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>name</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>MPL<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
            <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>url</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>http://choosealicense.com/licenses/mpl-2.0/<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>dependencies</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>org.clojure/clojure <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>1.6.0<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
                 <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>org.immutant/immutant <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>2.x.incremental.191<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
                 <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>compojure <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>1.1.8<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>repositories</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Immutant incremental builds<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
                  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>http://downloads.immutant.org/incremental/<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>plugins</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>lein-immutant <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>2.0.0-SNAPSHOT<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>main</span> <span class="z-keyword z-operator z-macro z-clojure">^</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>skip-aot</span> learning.core
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>target-path</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>target/%s<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>profiles</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>uberjar</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>aot</span> <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>all</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span>
  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Plugin configuration.
</span>  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>ring</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>handler</span> learning.core/app<span class="z-punctuation z-section z-braces z-end z-clojure">}</span>
  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>immutant</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>
     <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>war</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>
        <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>dev?</span> <span class="z-constant z-language z-clojure">false</span>
        <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>resource-paths</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>resources<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
        <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>nrepl</span> <span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>
          <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>port</span> <span class="z-constant z-numeric z-integer z-decimal z-clojure">8888</span>
          <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>start?</span> <span class="z-constant z-language z-clojure">true</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
</span></code></pre>
<p>Now change your <code>learning/src/learning/core.clj</code> file to contain the following:</p>
<pre data-lang="clojure" class="language-clojure z-code"><code class="language-clojure" data-lang="clojure"><span class="z-source z-clojure"><span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">ns</span> learning.core
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>use</span> compojure.core<span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>require</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>compojure.route       <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> route<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
            <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>immutant.web          <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> web<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
            <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>immutant.web.servlet  <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> servlet<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>gen-class</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>


<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">get-token</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Gets the session for the user<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">let</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>servlet-request <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>servlet-request</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span> request
        security-context <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getAttribute</span> servlet-request <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>org.keycloak.KeycloakSecurityContext<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
        id-token <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getIdToken</span> security-context<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
    id-token<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>

<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">show-profile</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Shows the profile of the user<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">try</span>
    <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">let</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>token <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">get-token</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
      <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> The token is a Java Object, don&#39;t expect more then a reference.
</span>      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;Token is: &lt;pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> token <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/pre&gt;&lt;/p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
           <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> This should show the users name.
</span>           <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Reference: https://docs.jboss.org/keycloak/docs/1.0-beta-3/javadocs/org/keycloak/representations/IDToken.html
</span>           <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;User is: &lt;pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.getPreferredUsername</span> token<span class="z-punctuation z-section z-parens z-end z-clojure">)</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/pre&gt;&lt;/p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
    <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">catch</span> Exception e
      <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> There is no token.
</span>      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;No user found.&lt;/p&gt;&lt;pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> e <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/pre&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>

<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">test-handler</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>A very versatile test route handler<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Handled different arities.
</span>  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request base<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
   <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;h1&gt;Base: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> base <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/h1&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
        <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">show-profile</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request base sub<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
   <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;h1&gt;Base: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> base <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span> Sub: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> sub <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/h1&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
        <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">show-profile</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>request base sub subsub<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
   <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;h1&gt;Base: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> base <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span> Sub: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> sub <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span> Subsub: <span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> subsub <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/h1&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
        <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">show-profile</span> request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;/p&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>

<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defroutes</span> <span class="z-entity z-name z-function z-clojure">app</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>The router.<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Logout
</span>  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Doesn&#39;t currently work: https://issues.jboss.org/browse/KEYCLOAK-478
</span>  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/logout<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
    <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">let</span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-punctuation z-section z-braces z-begin z-clojure">{</span>servlet-request <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>servlet-request</span><span class="z-punctuation z-section z-braces z-end z-clojure">}</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">.logout</span> servlet-request<span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
      <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">str</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Logged out<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Rest of the routes.
</span>  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span><span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
       <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">test-handler</span> request <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/:base<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>base <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
       <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">test-handler</span> request base<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/:base/:sub<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>base sub <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
       <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">test-handler</span> request base sub<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">GET</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>/:base/:sub/:subsub<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span> <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>base sub subsub <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>as</span> request<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
       <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">test-handler</span> request base sub subsub<span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">route/not-found</span> <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>&lt;h1&gt;Page not found&lt;/h1&gt;<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>

<span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-storage z-modifier z-def z-clojure">defn</span> <span class="z-entity z-name z-function z-clojure">-main</span>
  <span class="z-string z-quoted z-double z-clojure"><span class="z-punctuation z-definition z-string z-begin z-clojure">&quot;</span>Start the server<span class="z-punctuation z-definition z-string z-end z-clojure">&quot;</span></span>
  <span class="z-punctuation z-section z-brackets z-begin z-clojure">[</span>&amp; args<span class="z-punctuation z-section z-brackets z-end z-clojure">]</span>
  <span class="z-comment z-line z-clojure"><span class="z-punctuation z-definition z-comment">;</span> Start the server.
</span>  <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">web/run</span> <span class="z-punctuation z-section z-parens z-begin z-clojure">(</span><span class="z-variable z-function z-clojure">servlet/create-servlet</span> app<span class="z-punctuation z-section z-parens z-end z-clojure">)</span> <span class="z-constant z-other z-keyword z-clojure"><span class="z-punctuation z-definition z-keyword z-clojure">:</span>port</span> <span class="z-constant z-numeric z-integer z-decimal z-clojure">8081</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span><span class="z-punctuation z-section z-parens z-end z-clojure">)</span>
</span></code></pre>
<p>The <code>get-token</code> function returns an object that you can run things like <code>(.getPreferredUsername token)</code>. <a rel="noopener" target="_blank" href="https://docs.jboss.org/keycloak/docs/1.0-beta-3/javadocs/org/keycloak/representations/IDToken.html">This</a> documents the different methods you can use.</p>
<h3 id="planning-the-routes">Planning the Routes</h3>
<p>The routes are specifically very, very general so that we can test various routes. In our exploration we'll be paying attention to the following routes:</p>
<ul>
<li><code>/logout</code> - Logs out the user. (Note: <a rel="noopener" target="_blank" href="https://issues.jboss.org/browse/KEYCLOAK-478">This is currently broken in Keycloak-1.0.0-beta-3</a>)</li>
<li><code>/test</code> and <code>/test/foo</code> - General routes available to all visitors.</li>
<li><code>/locked</code> and <code>/locked/foo</code> - Routes available to all <code>user</code> and <code>admin</code> roles.</li>
<li><code>/admin</code> and <code>/admin/foo</code> - Routes available to only administrators.</li>
</ul>
<p>The routes in our code above covers much, much more then those, but you can play with those on your own.</p>
<h3 id="integrating-keycloak">Integrating Keycloak</h3>
<p><a rel="noopener" target="_blank" href="http://keycloak.jboss.org/docs.html">Keycloak's User Guide</a> specifies how to secure the application via the <code>web.xml</code>. If you're familiar with JBoss (I'm not) this is apparently a fairly standard way of securing the application.</p>
<p>However, Immutant does not currently provide an easy way to modify the <code>web.xml</code> in the war files it builds. Thankfully, since a war is a jar, and a jar is a zip, we can just add it in after.</p>
<p>First, lets make a folder for this type of data in <code>/learning/resources</code>.</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"> resources/WEB-INF</span>
</span></code></pre>
<p>Then, create a <code>learning/resources/WEB-INF/web.xml</code> with the following XML:</p>
<pre data-lang="xml" class="language-xml z-code"><code class="language-xml" data-lang="xml"><span class="z-text z-xml"><span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-app</span> <span class="z-entity z-other z-attribute-name z-localname z-xml">xmlns</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-double z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&quot;</span>http://java.sun.com/xml/ns/javaee<span class="z-punctuation z-definition z-string z-end z-xml">&quot;</span></span> <span class="z-entity z-other z-attribute-name z-namespace z-xml">xmlns</span><span class="z-entity z-other z-attribute-name z-xml"><span class="z-punctuation z-separator z-namespace z-xml">:</span></span><span class="z-entity z-other z-attribute-name z-localname z-xml">xsi</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-double z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="z-punctuation z-definition z-string z-end z-xml">&quot;</span></span> <span class="z-entity z-other z-attribute-name z-namespace z-xml">xsi</span><span class="z-entity z-other z-attribute-name z-xml"><span class="z-punctuation z-separator z-namespace z-xml">:</span></span><span class="z-entity z-other z-attribute-name z-localname z-xml">schemaLocation</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-double z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&quot;</span>http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd<span class="z-punctuation z-definition z-string z-end z-xml">&quot;</span></span> <span class="z-entity z-other z-attribute-name z-localname z-xml">version</span><span class="z-punctuation z-separator z-key-value z-xml">=</span><span class="z-string z-quoted z-double z-xml"><span class="z-punctuation z-definition z-string z-begin z-xml">&quot;</span>3.0<span class="z-punctuation z-definition z-string z-end z-xml">&quot;</span></span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">distributable</span><span class="z-punctuation z-definition z-tag z-end z-xml">/&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">listener</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">listener-class</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>org.projectodd.wunderboss.wildfly.ServletListener<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">listener-class</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">listener</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

	<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Anyone <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>test<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/test<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/test/*<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

	<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Users and Admins <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>user<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>admin<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>locked<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/locked<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Wildcard. Covers /locked/foo, /locked/foo/bar, etc <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/locked/*<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

	<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Admins <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>admin<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>admin<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/admin<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Wildcard. Covers /admin/foo, /admin/foo/bar, etc <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/admin/*<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

	<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Logout Route <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>admin<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>user<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">role-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">auth-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>logout<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
			<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>/logout<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">url-pattern</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-resource-collection</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">security-constraint</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

	<span class="z-comment z-block z-xml"><span class="z-punctuation z-definition z-comment z-begin z-xml">&lt;!--</span> Keycloak conf <span class="z-punctuation z-definition z-comment z-end z-xml">--&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">login-config</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">auth-method</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>KEYCLOAK<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">auth-method</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
		<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;</span><span class="z-entity z-name z-tag z-localname z-xml">realm-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>master<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">realm-name</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
	<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">login-config</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>

<span class="z-meta z-tag z-xml"><span class="z-punctuation z-definition z-tag z-begin z-xml">&lt;/</span><span class="z-entity z-name z-tag z-localname z-xml">web-app</span><span class="z-punctuation z-definition z-tag z-end z-xml">&gt;</span></span>
</span></code></pre>
<p>Now, navigate back to your <a rel="noopener" target="_blank" href="https://localhost:8080/auth">Keycloak container</a>, log in, and go to the <strong>Applications</strong> menu, hit <strong>learning</strong>, and go to the <strong>Installation</strong> tab. Select the <code>keycloak.json</code> from the dropdown. Finally, <strong>Download</strong> the output and save it as <code>learning/WEB-INF/keycloak.json</code>.</p>
<h3 id="building-the-container">Building the container</h3>
<p>Since we'll be using a Docker container for the application, create a <code>learning/Dockerfile</code> with the following:</p>
<pre class="z-code"><code><span class="z-text z-plain">FROM jboss/keycloak-adapter-wildfly
RUN /opt/wildfly/bin/add-user.sh admin hunter2 --silent
ADD target/base+system+user+dev/learning.war /opt/wildfly/standalone/deployments/ROOT.war
</span></code></pre>
<p>Then a <code>learning/Makefile</code> to (optionally) make things a bit smoother:</p>
<pre data-lang="make" class="language-make z-code"><code class="language-make" data-lang="make"><span class="z-source z-makefile"><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">all</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> rm<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>f</span> immut-test</span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">true</span></span></span>
	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> rmi immut-learning</span> <span class="z-keyword z-operator z-logical z-or z-shell">||</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">true</span></span></span>
	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">lein</span></span><span class="z-meta z-function-call z-arguments z-shell"> immutant war</span></span>
	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> build<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>t</span> immut-learning .</span></span>

</span><span class="z-meta z-function z-makefile"><span class="z-entity z-name z-function z-makefile">run</span></span><span class="z-keyword z-operator z-assignment z-makefile">:</span>
<span class="z-meta z-function z-arguments z-makefile"></span><span class="z-meta z-function z-body z-makefile"></span><span class="z-meta z-function z-body z-makefile">	<span class="z-source z-shell"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">docker</span></span><span class="z-meta z-function-call z-arguments z-shell"> run<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>name</span> immut-test<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>rm</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>t</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>i</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> 127.0.0.1:8081:8080<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> 127.0.0.1:9991:9990<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>link</span> keycloak:auth immut-learning</span></span>
</span></span></code></pre>
<p><strong>Just one more thing:</strong> Due to the linking between containers, you may need to add a line to your <code>/etc/hosts</code> so that the application will appropriately talk to the Keycloak server. The line should look like this:</p>
<pre class="z-code"><code><span class="z-text z-plain">127.0.0.1 auth
</span></code></pre>
<p>Then, edit your <code>keycloak.json</code> and set the <code>auth-server-url</code>:</p>
<pre data-lang="json" class="language-json z-code"><code class="language-json" data-lang="json"><span class="z-source z-json"><span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>auth-server-url<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span>: <span class="z-string z-quoted z-double z-json"><span class="z-punctuation z-definition z-string z-begin z-json">&quot;</span>http://auth:8080/auth<span class="z-punctuation z-definition z-string z-end z-json">&quot;</span></span>,
</span></code></pre>
<h2 id="running">Running</h2>
<p>You should now be able to build <strong>and start</strong> the application with:</p>
<pre data-lang="bash" class="language-bash z-code"><code class="language-bash" data-lang="bash"><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span> <span class="z-keyword z-operator z-logical z-and z-shell">&amp;&amp;</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">make</span></span><span class="z-meta z-function-call z-arguments z-shell"> run</span>
</span></code></pre>
<p>After waiting for boot, browsing to <a rel="noopener" target="_blank" href="http://localhost:8081/test">http://localhost:8081/test</a> should yield you a page that says, roughly:</p>
<pre class="z-code"><code><span class="z-text z-plain">Base = &quot;test&quot;

No user found.

java.lang.NullPointerException
</span></code></pre>
<h2 id="exploring">Exploring</h2>
<h3 id="user-routes">User routes</h3>
<p>Now, try visiting <a rel="noopener" target="_blank" href="http://localhost:8081/locked">http://localhost:8081/locked</a>. You should get redirected to the familiar Keycloak login screen. Log in with the <code>user</code> account. You should see something roughly like:</p>
<pre class="z-code"><code><span class="z-text z-plain">Base = &quot;locked Sub: test&quot;

Token is:

org.keycloak.representations.IDToken@7f55bb4f

User is:

user

</span></code></pre>
<p><em>Fantastic</em>. Now, try navigating to the admin route at <a rel="noopener" target="_blank" href="http://localhost:8081/admin">http://localhost:8081/admin</a>. You should see the helpful <code>Forbidden</code> error. This is exactly what we want!</p>
<h3 id="admin-routes">Admin routes</h3>
<p>In order to change accounts, you, unfortunately, can't browse to <a rel="noopener" target="_blank" href="http://localhost:8081/logout">http://localhost:8081/logout</a>. This seems to be a bug to be squashed in the next version of Keycloak (<a rel="noopener" target="_blank" href="https://issues.jboss.org/browse/KEYCLOAK-478">Bug</a>), but I'll leave it here for posterity. For now, navigate to <a rel="noopener" target="_blank" href="http://localhost:8080/auth">http://localhost:8080/auth</a>, log in as <code>admin</code>, navigate to the <strong>Sessions and Tokens</strong> and click the blue <strong>Logout All</strong> button.</p>
<p>Browse back to <a rel="noopener" target="_blank" href="http://localhost:8081/admin">http://localhost:8081/admin</a> and log in as <code>admin</code>. You should see:</p>
<pre class="z-code"><code><span class="z-text z-plain">Base = &quot;admin&quot;

Token is:

org.keycloak.representations.IDToken@4a8ca873

User is:

admin
</span></code></pre>
<p>You should also be able to hit all other routes as the admin. Be sure to explore Keycloak, as it has many features regarding roles, permissions, and other things not covered here.</p>
<p><strong>Special thanks to all the folks on #immutant, especially bbrowning, tcrawley, and jcrossley3 for their help!</strong></p>

    </main>
    <footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/79802a5675a5b8e17e6a67961c01fc42cc003520
">79802a5675a5b8e17e6a67961c01fc42cc003520
</a></pre></body>

</html>
