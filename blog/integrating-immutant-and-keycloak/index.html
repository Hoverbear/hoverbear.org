<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>Integrating Immutant and Keycloak
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;a157fd2afbc5f18800.jpg">
        <meta name="twitter:site" content="@a_hoverbear">
        <meta name="twitter:creator" content="@a_hoverbear">
        
            <meta name="twitter:title" content="Integrating Immutant and Keycloak">
        
        
            <meta name="twitter:description" content="In my past two posts, we took a surface level look at Immutant then took a look at deploying immutant applications to the Wildfly application server. This time, we&#x27;ll take a look at how to integrate Keycloak with an Immutant app, again using Docker heavily.

If you haven&#x27;t read the previous few articles, it might be useful to give them a quick glance over.

">
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- <a href="https://unsplash.com/photos/-N0cgDSF_MI">Kobi Li</a></figcaption>
        <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;a3aed6e7b2f3210400.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;a157fd2afbc5f18800.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;2851c84fd6c5141000.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            Integrating Immutant and Keycloak
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <p class="description">
                    A computer scientist working in open source towards a more hopeful future.
                </p>

            <p class="date">
                    Posted on 2014-07-25, around 10 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#keycloak">Keycloak</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#erecting-keycloak">Erecting Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#getting-into-keycloak">Getting into Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#creating-an-application">Creating an Application</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#creating-some-users">Creating Some Users</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#immutant">Immutant</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#setting-up-the-immutant-application">Setting Up the Immutant Application</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#planning-the-routes">Planning the Routes</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#integrating-keycloak">Integrating Keycloak</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#building-the-container">Building the container</a>
                    </li>
                    
                </ol>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#running">Running</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#exploring">Exploring</a>
                
                <ol>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#user-routes">User routes</a>
                    </li>
                    
                    <li>
                        <a href="https://hoverbear.org/blog/integrating-immutant-and-keycloak/#admin-routes">Admin routes</a>
                    </li>
                    
                </ol>
                
            </li>
            
        </ol>
    </nav>

        <p>In my past two posts, we took a <a href="/2014/07/14/starting-with-immutant/">surface level look at Immutant</a> then took a look at <a href="/2014/07/22/deploying-immutant-to-wildfly/">deploying immutant applications to the Wildfly application server.</a> This time, we'll take a look at how to integrate Keycloak with an Immutant app, again using Docker heavily.</p>
<blockquote>
<p>If you haven't read the previous few articles, it might be useful to give them a quick glance over.</p>
</blockquote>
<span id="continue-reading"></span><h2 id="keycloak">Keycloak</h2>
<h3 id="erecting-keycloak">Erecting Keycloak</h3>
<p><a rel="noopener" target="_blank" href="http://keycloak.jboss.org/">Keycloak</a> is an integrated Single-Sign-On and Identity Management platform from the fine folks of JBoss. A Docker image of Keycloak is available <a rel="noopener" target="_blank" href="https://www.jboss.org/docker/">here</a>, just like Immutant, Wildfly, and a few others.</p>
<p>To pull the Keycloak image:</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">docker</span><span style="color:#ccc9c2;"> pull jboss/keycloak
</span></code></pre>
<p>Then, to erect the container (<a rel="noopener" target="_blank" href="https://github.com/jboss/dockerfiles/blob/master/keycloak/server/README.md">Source</a>):</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">docker</span><span style="color:#ccc9c2;"> run</span><span style="color:#ffcc66;"> -it --name</span><span style="color:#ccc9c2;"> keycloak</span><span style="color:#ffcc66;"> -p</span><span style="color:#ccc9c2;"> 8080:8080</span><span style="color:#ffcc66;"> -p</span><span style="color:#ccc9c2;"> 9090:9090 jboss/keycloak
</span></code></pre>
<blockquote>
<p>Use the  <code>-d</code> flag to daemonize the service so it doesn't die with the tty. You can check the logs later with <code>docker logs -f keycloak</code></p>
</blockquote>
<p>Finally, you should be able to browse to <a rel="noopener" target="_blank" href="http://localhost:8080/">http://localhost:8080/</a> and see the friendly Wildfly logo and welcome screen. Visiting <a rel="noopener" target="_blank" href="http://localhost:8080/auth/">http://localhost:8080/auth/</a> should yield a Keycloak welcome screen.</p>
<h3 id="getting-into-keycloak">Getting into Keycloak</h3>
<p>Visiting <a rel="noopener" target="_blank" href="http://localhost:8080/auth/admin/">http://localhost:8080/auth/admin/</a> should bring you to a very <em>blue</em> login screen. The Keycloak docker image starts with a pre-created <code>admin</code> account for you to log in with.</p>
<p><strong>Username:</strong> admin</p>
<p><strong>Password:</strong> admin</p>
<p>After logging in, Keycloak should prompt for a password change.</p>
<h3 id="creating-an-application">Creating an Application</h3>
<p>Browse to the <strong>Applications</strong> menu and hit the blue <strong>Add Application</strong> button. For this exploration, I'm creating a <code>learning</code> application.</p>
<p><strong>Name:</strong> learning</p>
<p><strong>Enabled:</strong> ON</p>
<p><strong>Access Type:</strong> confidential</p>
<p><strong>Redirect URI:</strong> http://localhost:8081/*</p>
<p>After hitting save, you'll have the opportunity to add more information. For this exploration, we don't need to add any more information here.</p>
<p>Visiting the <strong>Roles</strong> tab at the top, hit <strong>Add Role</strong> and create a pair of roles:</p>
<ul>
<li><code>user</code></li>
<li><code>admin</code></li>
</ul>
<p>There are several other tabs which contain many more interesting configuration options, but we'll leave these alone for now.</p>
<h3 id="creating-some-users">Creating Some Users</h3>
<p>In our exploration, we'll utilize both of the scopes above to see how to allow different roles to access different parts of the site.</p>
<p>Browse over to the <strong>Users</strong> menu. Beside the search box, hit <strong>View all Users</strong>. You should see <code>admin</code> already created. Create a <code>user</code> user, the rest of the information you can use anything, or nothing.</p>
<p>Going back to the user listing. Select the <code>admin</code> user and go to the <strong>Role Mappings</strong> tab. At the bottom in &quot;Application Roles&quot; select <code>learning</code> from the dropdown. Add the <code>admin</code> role for the admin user. Then, repeat the steps for the <code>user</code> user, but only assign them the <code>user</code> role, not <code>admin</code>.</p>
<p><em>What does this all mean?</em> The <code>admin</code> user should be able to access every page the <code>admin</code> role can. The <code>user</code> user should <em>not</em> be able to access the <code>admin</code> role's pages.</p>
<h2 id="immutant">Immutant</h2>
<h3 id="setting-up-the-immutant-application">Setting Up the Immutant Application</h3>
<p>Start up a new lein project with:</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">lein</span><span style="color:#ccc9c2;"> new app learning
</span></code></pre>
<p>Your <code>learning/project.clj</code> needs to be modified to look similar to this:</p>
<pre style="background-color:#212733;">
<code class="language-clojure" data-lang="clojure"><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">defproject </span><span style="color:#ffd580;">learning </span><span style="color:#bae67e;">&quot;0.1.0-SNAPSHOT&quot;
  </span><span style="color:#ffcc66;">:description </span><span style="color:#bae67e;">&quot;FIXME: write description&quot;
  </span><span style="color:#ffcc66;">:url </span><span style="color:#bae67e;">&quot;http://example.com/FIXME&quot;
  </span><span style="color:#ffcc66;">:license </span><span style="color:#ccc9c2;">{</span><span style="color:#ffcc66;">:name </span><span style="color:#bae67e;">&quot;MPL&quot;
            </span><span style="color:#ffcc66;">:url </span><span style="color:#bae67e;">&quot;http://choosealicense.com/licenses/mpl-2.0/&quot;</span><span style="color:#ccc9c2;">}
  </span><span style="color:#ffcc66;">:dependencies </span><span style="color:#ccc9c2;">[[org.clojure/clojure </span><span style="color:#bae67e;">&quot;1.6.0&quot;</span><span style="color:#ccc9c2;">]
                 [org.immutant/immutant </span><span style="color:#bae67e;">&quot;2.x.incremental.191&quot;</span><span style="color:#ccc9c2;">]
                 [compojure </span><span style="color:#bae67e;">&quot;1.1.8&quot;</span><span style="color:#ccc9c2;">]]
  </span><span style="color:#ffcc66;">:repositories </span><span style="color:#ccc9c2;">[[</span><span style="color:#bae67e;">&quot;Immutant incremental builds&quot;
                  &quot;http://downloads.immutant.org/incremental/&quot;</span><span style="color:#ccc9c2;">]]
  </span><span style="color:#ffcc66;">:plugins </span><span style="color:#ccc9c2;">[[lein-immutant </span><span style="color:#bae67e;">&quot;2.0.0-SNAPSHOT&quot;</span><span style="color:#ccc9c2;">]]
  </span><span style="color:#ffcc66;">:main </span><span style="color:#f29e74;">^</span><span style="color:#ffcc66;">:skip-aot</span><span style="color:#ccc9c2;"> learning.core
  </span><span style="color:#ffcc66;">:target-path </span><span style="color:#bae67e;">&quot;target/%s&quot;
  </span><span style="color:#ffcc66;">:profiles </span><span style="color:#ccc9c2;">{</span><span style="color:#ffcc66;">:uberjar </span><span style="color:#ccc9c2;">{</span><span style="color:#ffcc66;">:aot :all</span><span style="color:#ccc9c2;">}}
  </span><span style="font-style:italic;color:#5c6773;">; Plugin configuration.
  :ring {:handler learning.core/app}
  :immutant {
     :war {
        :dev? false
        :resource-paths [&quot;resources&quot;]
        :nrepl {
          :port 8888
          :start? true}}})
</span></code></pre>
<p>Now change your <code>learning/src/learning/core.clj</code> file to contain the following:</p>
<pre style="background-color:#212733;">
<code class="language-clojure" data-lang="clojure"><span style="color:#ccc9c2;">(</span><span style="color:#ffd580;">ns</span><span style="color:#ccc9c2;"> learning.core
  (</span><span style="color:#ffcc66;">:use</span><span style="color:#ccc9c2;"> compojure.core)
  (</span><span style="color:#ffcc66;">:require </span><span style="color:#ccc9c2;">[compojure.route       </span><span style="color:#ffcc66;">:as</span><span style="color:#ccc9c2;"> route]
            [immutant.web          </span><span style="color:#ffcc66;">:as</span><span style="color:#ccc9c2;"> web]
            [immutant.web.servlet  </span><span style="color:#ffcc66;">:as</span><span style="color:#ccc9c2;"> servlet])
  (</span><span style="color:#ffcc66;">:gen-class</span><span style="color:#ccc9c2;">))


(</span><span style="color:#ffa759;">defn </span><span style="color:#ffd580;">get-token
  </span><span style="color:#bae67e;">&quot;Gets the session for the user&quot;
  </span><span style="color:#ccc9c2;">[request]
  (</span><span style="color:#ffd580;">let </span><span style="color:#ccc9c2;">[{servlet-request </span><span style="color:#ffcc66;">:servlet-request</span><span style="color:#ccc9c2;">} request
        security-context (</span><span style="color:#ffd580;">.getAttribute</span><span style="color:#ccc9c2;"> servlet-request </span><span style="color:#bae67e;">&quot;org.keycloak.KeycloakSecurityContext&quot;</span><span style="color:#ccc9c2;">)
        id-token (</span><span style="color:#ffd580;">.getIdToken</span><span style="color:#ccc9c2;"> security-context)]
    id-token))

(</span><span style="color:#ffa759;">defn </span><span style="color:#ffd580;">show-profile
  </span><span style="color:#bae67e;">&quot;Shows the profile of the user&quot;
  </span><span style="color:#ccc9c2;">[request]
  (</span><span style="color:#ffd580;">try
    </span><span style="color:#ccc9c2;">(</span><span style="color:#ffd580;">let </span><span style="color:#ccc9c2;">[token (</span><span style="color:#ffd580;">get-token</span><span style="color:#ccc9c2;"> request)]
      </span><span style="font-style:italic;color:#5c6773;">; The token is a Java Object, don&#39;t expect more then a reference.
      (str &quot;&lt;p&gt;Token is: &lt;pre&gt;&quot; token &quot;&lt;/pre&gt;&lt;/p&gt;&quot;
           ; This should show the users name.
           ; Reference: https://docs.jboss.org/keycloak/docs/1.0-beta-3/javadocs/org/keycloak/representations/IDToken.html
           &quot;&lt;p&gt;User is: &lt;pre&gt;&quot; (.getPreferredUsername token) &quot;&lt;/pre&gt;&lt;/p&gt;&quot;))
    (catch Exception e
      ; There is no token.
      (str &quot;&lt;p&gt;No user found.&lt;/p&gt;&lt;pre&gt;&quot; e &quot;&lt;/pre&gt;&quot;))))

(defn test-handler
  &quot;A very versatile test route handler&quot;
  ; Handled different arities.
  ([request base]
   (str &quot;&lt;h1&gt;Base: &quot; base &quot;&lt;/h1&gt;&quot;
        &quot;&lt;p&gt;&quot; (show-profile request) &quot;&lt;/p&gt;&quot;))
  ([request base sub]
   (str &quot;&lt;h1&gt;Base: &quot; base &quot; Sub: &quot; sub &quot;&lt;/h1&gt;&quot;
        &quot;&lt;p&gt;&quot; (show-profile request) &quot;&lt;/p&gt;&quot;))
  ([request base sub subsub]
   (str &quot;&lt;h1&gt;Base: &quot; base &quot; Sub: &quot; sub &quot; Subsub: &quot; subsub &quot;&lt;/h1&gt;&quot;
        &quot;&lt;p&gt;&quot; (show-profile request) &quot;&lt;/p&gt;&quot;)))

(defroutes app
  &quot;The router.&quot;
  ; Logout
  ; Doesn&#39;t currently work: https://issues.jboss.org/browse/KEYCLOAK-478
  (GET &quot;/logout&quot; [:as request]
    (let [{servlet-request :servlet-request} request]
      (.logout servlet-request)
      (str &quot;Logged out&quot;)))
  ; Rest of the routes.
  (GET &quot;/&quot; [:as request]
       (test-handler request &quot;/&quot;))
  (GET &quot;/:base&quot; [base :as request]
       (test-handler request base))
  (GET &quot;/:base/:sub&quot; [base sub :as request]
       (test-handler request base sub))
  (GET &quot;/:base/:sub/:subsub&quot; [base sub subsub :as request]
       (test-handler request base sub subsub))
  (route/not-found &quot;&lt;h1&gt;Page not found&lt;/h1&gt;&quot;))

(defn -main
  &quot;Start the server&quot;
  [&amp; args]
  ; Start the server.
  (web/run (servlet/create-servlet app) :port 8081))
</span></code></pre>
<p>The <code>get-token</code> function returns an object that you can run things like <code>(.getPreferredUsername token)</code>. <a rel="noopener" target="_blank" href="https://docs.jboss.org/keycloak/docs/1.0-beta-3/javadocs/org/keycloak/representations/IDToken.html">This</a> documents the different methods you can use.</p>
<h3 id="planning-the-routes">Planning the Routes</h3>
<p>The routes are specifically very, very general so that we can test various routes. In our exploration we'll be paying attention to the following routes:</p>
<ul>
<li><code>/logout</code> - Logs out the user. (Note: <a rel="noopener" target="_blank" href="https://issues.jboss.org/browse/KEYCLOAK-478">This is currently broken in Keycloak-1.0.0-beta-3</a>)</li>
<li><code>/test</code> and <code>/test/foo</code> - General routes available to all visitors.</li>
<li><code>/locked</code> and <code>/locked/foo</code> - Routes available to all <code>user</code> and <code>admin</code> roles.</li>
<li><code>/admin</code> and <code>/admin/foo</code> - Routes available to only administrators.</li>
</ul>
<p>The routes in our code above covers much, much more then those, but you can play with those on your own.</p>
<h3 id="integrating-keycloak">Integrating Keycloak</h3>
<p><a rel="noopener" target="_blank" href="http://keycloak.jboss.org/docs.html">Keycloak's User Guide</a> specifies how to secure the application via the <code>web.xml</code>. If you're familiar with JBoss (I'm not) this is apparently a fairly standard way of securing the application.</p>
<p>However, Immutant does not currently provide an easy way to modify the <code>web.xml</code> in the war files it builds. Thankfully, since a war is a jar, and a jar is a zip, we can just add it in after.</p>
<p>First, lets make a folder for this type of data in <code>/learning/resources</code>.</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">mkdir</span><span style="color:#ccc9c2;"> resources/WEB-INF
</span></code></pre>
<p>Then, create a <code>learning/resources/WEB-INF/web.xml</code> with the following XML:</p>
<pre style="background-color:#212733;">
<code class="language-xml" data-lang="xml"><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">web-app </span><span style="color:#ffd580;">xmlns</span><span style="color:#ccc9c2cc;">=</span><span style="color:#bae67e;">&quot;http://java.sun.com/xml/ns/javaee&quot; </span><span style="color:#ffd580;">xmlns</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ffd580;">xsi</span><span style="color:#ccc9c2cc;">=</span><span style="color:#bae67e;">&quot;http://www.w3.org/2001/XMLSchema-instance&quot; </span><span style="color:#ffd580;">xsi</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ffd580;">schemaLocation</span><span style="color:#ccc9c2cc;">=</span><span style="color:#bae67e;">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot; </span><span style="color:#ffd580;">version</span><span style="color:#ccc9c2cc;">=</span><span style="color:#bae67e;">&quot;3.0&quot;</span><span style="color:#5ccfe690;">&gt;
	&lt;</span><span style="color:#73d0ff;">distributable</span><span style="color:#5ccfe690;">/&gt;
	&lt;</span><span style="color:#73d0ff;">listener</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">listener-class</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">org.projectodd.wunderboss.wildfly.ServletListener</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">listener-class</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">listener</span><span style="color:#5ccfe690;">&gt;

	</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Anyone --&gt;
	</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">test</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/test</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/test/*</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;

	</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Users and Admins --&gt;
	</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">user</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">admin</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">locked</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/locked</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
			</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Wildcard. Covers /locked/foo, /locked/foo/bar, etc --&gt;
			</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/locked/*</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;

	</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Admins --&gt;
	</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">admin</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">admin</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/admin</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
			</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Wildcard. Covers /admin/foo, /admin/foo/bar, etc --&gt;
			</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/admin/*</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;

	</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Logout Route --&gt;
	</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">admin</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">user</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">role-name</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">auth-constraint</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">logout</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">web-resource-name</span><span style="color:#5ccfe690;">&gt;
			&lt;</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">/logout</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">url-pattern</span><span style="color:#5ccfe690;">&gt;
		&lt;/</span><span style="color:#73d0ff;">web-resource-collection</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">security-constraint</span><span style="color:#5ccfe690;">&gt;

	</span><span style="font-style:italic;color:#5c6773;">&lt;!-- Keycloak conf --&gt;
	</span><span style="color:#5ccfe690;">&lt;</span><span style="color:#73d0ff;">login-config</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">auth-method</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">KEYCLOAK</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">auth-method</span><span style="color:#5ccfe690;">&gt;
		&lt;</span><span style="color:#73d0ff;">realm-name</span><span style="color:#5ccfe690;">&gt;</span><span style="color:#ccc9c2;">master</span><span style="color:#5ccfe690;">&lt;/</span><span style="color:#73d0ff;">realm-name</span><span style="color:#5ccfe690;">&gt;
	&lt;/</span><span style="color:#73d0ff;">login-config</span><span style="color:#5ccfe690;">&gt;

&lt;/</span><span style="color:#73d0ff;">web-app</span><span style="color:#5ccfe690;">&gt;
</span></code></pre>
<p>Now, navigate back to your <a rel="noopener" target="_blank" href="https://localhost:8080/auth">Keycloak container</a>, log in, and go to the <strong>Applications</strong> menu, hit <strong>learning</strong>, and go to the <strong>Installation</strong> tab. Select the <code>keycloak.json</code> from the dropdown. Finally, <strong>Download</strong> the output and save it as <code>learning/WEB-INF/keycloak.json</code>.</p>
<h3 id="building-the-container">Building the container</h3>
<p>Since we'll be using a Docker container for the application, create a <code>learning/Dockerfile</code> with the following:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">FROM jboss/keycloak-adapter-wildfly
RUN /opt/wildfly/bin/add-user.sh admin hunter2 --silent
ADD target/base+system+user+dev/learning.war /opt/wildfly/standalone/deployments/ROOT.war
</span></code></pre>
<p>Then a <code>learning/Makefile</code> to (optionally) make things a bit smoother:</p>
<pre style="background-color:#212733;">
<code class="language-make" data-lang="make"><span style="color:#ffd580;">all</span><span style="color:#f29e74;">:
	</span><span style="color:#bae67e;">docker rm -f immut-test || true
	</span><span style="color:#ffd580;">docker</span><span style="color:#ccc9c2;"> rmi immut-learning </span><span style="color:#f29e74;">|| </span><span style="color:#ffd580;">true
	lein</span><span style="color:#ccc9c2;"> immutant war
	</span><span style="color:#ffd580;">docker</span><span style="color:#ccc9c2;"> build</span><span style="color:#ffcc66;"> -t</span><span style="color:#ccc9c2;"> immut-learning .

</span><span style="color:#ffd580;">run</span><span style="color:#f29e74;">:
	</span><span style="color:#bae67e;">docker run --name immut-test --rm -t -i -p 127.0.0.1:8081:8080 -p 127.0.0.1:9991:9990 --link keycloak:auth immut-learning
</span></code></pre>
<p><strong>Just one more thing:</strong> Due to the linking between containers, you may need to add a line to your <code>/etc/hosts</code> so that the application will appropriately talk to the Keycloak server. The line should look like this:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">127.0.0.1 auth
</span></code></pre>
<p>Then, edit your <code>keycloak.json</code> and set the <code>auth-server-url</code>:</p>
<pre style="background-color:#212733;">
<code class="language-json" data-lang="json"><span style="color:#bae67e;">&quot;auth-server-url&quot;</span><span style="color:#ccc9c2;">: </span><span style="color:#bae67e;">&quot;http://auth:8080/auth&quot;</span><span style="color:#ccc9c2;">,
</span></code></pre><h2 id="running">Running</h2>
<p>You should now be able to build <strong>and start</strong> the application with:</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">make </span><span style="color:#f29e74;">&amp;&amp; </span><span style="color:#ffd580;">make</span><span style="color:#ccc9c2;"> run
</span></code></pre>
<p>After waiting for boot, browsing to <a rel="noopener" target="_blank" href="http://localhost:8081/test">http://localhost:8081/test</a> should yield you a page that says, roughly:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">Base = &quot;test&quot;

No user found.

java.lang.NullPointerException
</span></code></pre><h2 id="exploring">Exploring</h2>
<h3 id="user-routes">User routes</h3>
<p>Now, try visiting <a rel="noopener" target="_blank" href="http://localhost:8081/locked">http://localhost:8081/locked</a>. You should get redirected to the familiar Keycloak login screen. Log in with the <code>user</code> account. You should see something roughly like:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">Base = &quot;locked Sub: test&quot;

Token is:

org.keycloak.representations.IDToken@7f55bb4f

User is:

user

</span></code></pre>
<p><em>Fantastic</em>. Now, try navigating to the admin route at <a rel="noopener" target="_blank" href="http://localhost:8081/admin">http://localhost:8081/admin</a>. You should see the helpful <code>Forbidden</code> error. This is exactly what we want!</p>
<h3 id="admin-routes">Admin routes</h3>
<p>In order to change accounts, you, unfortunately, can't browse to <a rel="noopener" target="_blank" href="http://localhost:8081/logout">http://localhost:8081/logout</a>. This seems to be a bug to be squashed in the next version of Keycloak (<a rel="noopener" target="_blank" href="https://issues.jboss.org/browse/KEYCLOAK-478">Bug</a>), but I'll leave it here for posterity. For now, navigate to <a rel="noopener" target="_blank" href="http://localhost:8080/auth">http://localhost:8080/auth</a>, log in as <code>admin</code>, navigate to the <strong>Sessions and Tokens</strong> and click the blue <strong>Logout All</strong> button.</p>
<p>Browse back to <a rel="noopener" target="_blank" href="http://localhost:8081/admin">http://localhost:8081/admin</a> and log in as <code>admin</code>. You should see:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">Base = &quot;admin&quot;

Token is:

org.keycloak.representations.IDToken@4a8ca873

User is:

admin
</span></code></pre>
<p>You should also be able to hit all other routes as the admin. Be sure to explore Keycloak, as it has many features regarding roles, permissions, and other things not covered here.</p>
<p><strong>Special thanks to all the folks on #immutant, especially bbrowning, tcrawley, and jcrossley3 for their help!</strong></p>

    </main>
    <footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/8679adcf7b99f689b5c359682b6e1c0f3bc36a8b
">8679adcf7b99f689b5c359682b6e1c0f3bc36a8b
</a></pre>
    </body>

</html>
