<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>The Future with Futures
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image"><meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;587e845a1306d55100.jpg"/>
        <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;587e845a1306d55100.jpg"/>
        <meta name="twitter:site" content="@a_hoverbear"/>
        <meta name="twitter:creator" content="@a_hoverbear"/>
        
        
            <meta name="twitter:title" content="The Future with Futures"/>
            <meta property='og:title' content="The Future with Futures"/>
        

        
            <meta property='og:url' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;the-future-with-futures&#x2F;"/>
        

        
            <meta name="twitter:description" content="Recently there has been a lot of progress in the Rust language towards a robust asynchronous stack. In this article we&#x27;ll take a look at what these things are, take a tour of what&#x27;s available, play with some examples, and talk about how the pieces fit together.
We&#x27;ll get started with the futures crate to start, move on to futures_cpupool, and then eventually to tokio. We will assume you have some knowledge of programming, and have at least thought about trying Rust before.
"/>
            <meta property='og:description' content="Recently there has been a lot of progress in the Rust language towards a robust asynchronous stack. In this article we&#x27;ll take a look at what these things are, take a tour of what&#x27;s available, play with some examples, and talk about how the pieces fit together.
We&#x27;ll get started with the futures crate to start, move on to futures_cpupool, and then eventually to tokio. We will assume you have some knowledge of programming, and have at least thought about trying Rust before.
"/>
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- NASA</figcaption>
        <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;a8e4cf3cac5b415b00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;587e845a1306d55100.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;7a85b7dee62f1ec400.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            The Future with Futures
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <p class="description">
                    A computer scientist working in open source towards a more hopeful future.
                </p>

            <p class="date">
                    Posted on 2017-03-01, around 27 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#what-are-futures-and-async">What are Futures and Async?</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#how-we-got-here">How We Got Here</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#getting-started">Getting Started</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#dipping-our-toes-into-the-cpu-pool">Dipping Our Toes Into the CPU Pool</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#visiting-tokio-s-core">Visiting Tokio&#x27;s Core</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#services-and-protocols">Services and Protocols</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/the-future-with-futures/#complete-tokio-example">Complete Tokio Example</a>
                
            </li>
            
        </ol>
    </nav>

        <p>Recently there has been a lot of progress in the Rust language towards a robust asynchronous stack. In this article we'll take a look at what these things are, take a tour of what's available, play with some examples, and talk about how the pieces fit together.</p>
<p>We'll get started with the <code>futures</code> crate to start, move on to <code>futures_cpupool</code>, and then eventually to <code>tokio</code>. We will assume you have some knowledge of programming, and have at least thought about trying Rust before.</p>
<span id="continue-reading"></span><h2 id="what-are-futures-and-async">What are Futures and Async?</h2>
<p>When writing code to do some action which may take some time, such as requesting a resource from a remote host, it is not always desirable to block further execution of our program. This is particularly true in the case where we are writing a web server, or performing a large number of complex calculations.</p>
<p>One way of handling this is to spawn threads and discretely slice up tasks to be distributed across threads. This is not always as convienent or as easy as it may sound. Suddenly we are forced to figure out how tasks are best split, how to allocate resources, to program against race conditions, and manage interthread communication.</p>
<p>As a community we've learnt some techniques over the years, such as CPU pools which allow a number of threads to cooperate on a task, and 'future' values which resolve to their intended value after they are finished some computation. These provide us useful and powerful tools that makes it easier, safer, and more fun to write such code.</p>
<p>If you've ever developed in Javascript you may already be familiar with asynchronous programming and the idea of Promises. Futures in Rust are very similar to this, but we're provided more control and more responsibility. With this comes greater power.</p>
<h2 id="how-we-got-here">How We Got Here</h2>
<p>Much of this async work has been in development since green threads were removed from Rust around the 0.7 release. There have been several projects related to futures and async since, their influence can be felt by what we have now and what is on the horizon.</p>
<p>Much of the async story today is founded on the ideas and lessons learned from <code>std</code>'s green threads, <a rel="noopener" target="_blank" href="https://github.com/carllerche/mio"><code>mio</code></a>, <a rel="noopener" target="_blank" href="https://github.com/rustcc/coroutine-rs"><code>coroutine</code></a>, and <a rel="noopener" target="_blank" href="https://github.com/tailhook/rotor"><code>rotor</code></a>. <code>mio</code> in particular is a foundation of nearly the entire async area of Rust. If you have interest in seeing high quality systems code I highly reccomend paying some attention to this project.</p>
<p>Today, <a rel="noopener" target="_blank" href="https://tokio.rs/"><code>tokio</code></a> and <a rel="noopener" target="_blank" href="https://github.com/alexcrichton/futures-rs"><code>futures</code></a> are the focus of much community effort. Recently <a rel="noopener" target="_blank" href="https://tokio.rs/blog/tokio-0-1/">Tokio accounced its first release</a>, while futures have been relatively stable for a couple months. This has spurned a large amount of development within the community to support and leverage these new capabilities.</p>
<h2 id="getting-started">Getting Started</h2>
<p>The <code>futures</code> crate offers a number of structures and abstractions to <em>enable</em> building asynchronous code. By itself it's quite simple, and through its clever design it is fundamentally a zero cost abstraction. This is an important thing to keep in mind as we work through our examples: Writing code with futures should have no performance overhead over code without.</p>
<p>When compiled futures <a rel="noopener" target="_blank" href="https://aturon.github.io/blog/2016/08/11/futures/">boil down to actual state machines</a> while still allowing us to write our code in a relatively familiar 'callback style' pattern. If you've already been using Rust then working with Futures will feel very similar to how iterators feel.</p>
<p>One of the things we'll commonly do in this section is &quot;sleep a little bit&quot; on a thread to simulate some asynchronous action. In order to do this let's create a little function:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> rand</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">thread</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">time</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Duration</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">rand</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">distributions</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Range</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> IndependentSample}</span><span style="color:#ccc9c2cc;">;

</span><span style="font-style:italic;color:#5c6773;">// This function sleeps for a bit, then returns how long it slept.
</span><span style="color:#ffa759;">pub fn </span><span style="color:#ffd580;">sleep_a_little_bit</span><span style="color:#ccc9c2;">() </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">u64 </span><span style="color:#ccc9c2;">{
    </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> generator </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">rand</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">thread_rng()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> possibilities </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Range</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">1000</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> choice </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> possibilities</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">ind_sample</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> generator)</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> a_little_bit </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Duration</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_millis(choice)</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ccc9c2;">thread</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep(a_little_bit)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">    choice
}
</span></code></pre>
<p>Now that we've got that established we can use it in our first future. We'll use a <code>oneshot</code> to delegate a task to another thread, then pick it up back in the main thread. A oneshot is essentially a single use channel, something can be sent from the sender to the receiver, then the channel is closed.</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> fun_with_futures</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">thread</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sync</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">oneshot</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">fun_with_futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep_a_little_bit</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// This is a simple future built into the crate which feel sort of like
    // one-time channels. You get a (sender, receiver) when you invoke them.
    // Sending a value consumes that side of the channel, leaving only the reciever.
    </span><span style="color:#ffa759;">let </span><span style="color:#ccc9c2;">(tx</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> rx) </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">oneshot</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">channel()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// We can spawn a thread to simulate an action that takes time, like a web
    // request. In this case it&#39;s just sleeping for a random time.
    </span><span style="color:#ccc9c2;">thread</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">spawn(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;--&gt; START&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> waited_for </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;+++ WAITED </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> waited_for)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// This consumes the sender, we can&#39;t use it afterwards.
</span><span style="color:#ccc9c2;">        tx</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">complete</span><span style="color:#ccc9c2;">(waited_for)</span><span style="color:#ccc9c2cc;">;

        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;&lt;-- END&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ccc9c2;">})</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Now we can wait for it to finish
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> rx</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// This value will be the same as the previous &quot;WAITED&quot; output.
    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> result)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span></code></pre>
<p>If we run this example we'll see something like:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">--&gt; START
+++ WAITED 542
&lt;-- END
542
</span></code></pre>
<p>The output is exactly what we might expect if we were doing this via the <code>std</code> channels. The code looks similar as well. At this point we're barely using Futures at all, so it shouldn't be a huge surprise that there is nothing surprising happening here. Futures start to come into their own during much more complicated tasks.</p>
<p>Next, let's look at how we can work with a set of futures. In this example we'll spawn a number of threads, have them do some long running task, and then collect all of the results into a vector.</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> fun_with_futures</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">thread</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">join_all</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">fun_with_futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep_a_little_bit</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">NUM_OF_TASKS</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">usize </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">10</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// We&#39;ll create a set to add a bunch of recievers to.
    </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> rx_set </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Next we&#39;ll spawn up a bunch of threads doing &#39;something&#39; for a bit then sending a value.
    </span><span style="color:#ffa759;">for</span><span style="color:#ccc9c2;"> index </span><span style="color:#f29e74;">in </span><span style="color:#ffcc66;">0</span><span style="color:#f29e74;">..</span><span style="color:#ffcc66;">NUM_OF_TASKS </span><span style="color:#ccc9c2;">{
        </span><span style="font-style:italic;color:#5c6773;">// Here we create a future, this is a `oneshot` value which is consumed after use.
        </span><span style="color:#ffa759;">let </span><span style="color:#ccc9c2;">(tx</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> rx) </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">oneshot()</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// Add the reciever to the vector we created earlier so we can collect on it.
</span><span style="color:#ccc9c2;">        rx_set</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">push</span><span style="color:#ccc9c2;">(rx)</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5c6773;">// Spawning up a thread means things won&#39;t be executed sequentially, so this will actually
        // behave like an asynchronous value, so we can actually see how they work.
        </span><span style="color:#ccc9c2;">thread</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">spawn(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{
            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> --&gt; START&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> index)</span><span style="color:#ccc9c2cc;">;

            </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> waited_for </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> +++ WAITED </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> index</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> waited_for)</span><span style="color:#ccc9c2cc;">;

            </span><span style="font-style:italic;color:#5c6773;">// Here we send back the index (and consume the sender).
</span><span style="color:#ccc9c2;">            tx</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">complete</span><span style="color:#ccc9c2;">(index)</span><span style="color:#ccc9c2cc;">;

            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> &lt;-- END&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> index)</span><span style="color:#ccc9c2cc;">;
        </span><span style="color:#ccc9c2;">})</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ccc9c2;">}

    </span><span style="font-style:italic;color:#5c6773;">// `join_all` lets us join together the set of futures.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">join_all</span><span style="color:#ccc9c2;">(rx_set)
        </span><span style="font-style:italic;color:#5c6773;">// Block until they all are resolved.
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="font-style:italic;color:#5c6773;">// Check they all came out in the right order.
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">values</span><span style="color:#ccc9c2;">|
            values</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">iter</span><span style="color:#ccc9c2;">()
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">enumerate</span><span style="color:#ccc9c2;">()
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">all</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">index</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> &amp;</span><span style="color:#ffcc66;">value</span><span style="color:#ccc9c2;">)| index </span><span style="color:#f29e74;">==</span><span style="color:#ccc9c2;"> value))
        </span><span style="font-style:italic;color:#5c6773;">// We&#39;ll be lazy and just unwrap the result.
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Job is done. Values returned in order: </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> result)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span></code></pre>
<p>The <code>map</code> call behaves just like the <code>map</code> of an <code>Option&lt;T&gt;</code> or a <code>Result&lt;T,E&gt;</code>. It transforms some <code>Future&lt;T&gt;</code> into some <code>Future&lt;U&gt;</code>.  Running this example in output similar to the following:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">0 --&gt; START
1 --&gt; START
3 --&gt; START
2 --&gt; START
4 --&gt; START
5 --&gt; START
6 --&gt; START
7 --&gt; START
8 --&gt; START
9 --&gt; START
4 +++ WAITED 124
4 &lt;-- END
1 +++ WAITED 130
1 &lt;-- END
0 +++ WAITED 174
0 &lt;-- END
2 +++ WAITED 268
2 &lt;-- END
6 +++ WAITED 445
6 &lt;-- END
3 +++ WAITED 467
3 &lt;-- END
9 +++ WAITED 690
9 &lt;-- END
8 +++ WAITED 694
8 &lt;-- END
5 +++ WAITED 743
5 &lt;-- END
7 +++ WAITED 802
7 &lt;-- END
Job is done. Values returned in order: true
</span></code></pre>
<p>In this example we can observe that all of the futures started, waited various times, then finished. They did not finish in order, but the resulting vector did come out in the correct order. Again, this result is not entirely surprising and we could have done something very similar with <code>std</code>'s channels.</p>
<blockquote>
<p>Remember, futures are a basic building block, not a batteries included solution. They are intended to be built on top of.</p>
</blockquote>
<p>We'll cover one more example which will feel fairly familiar to people who have used the channels from <code>std</code>, then we'll start doing more interesting stuff.</p>
<p>The next primitive from <code>futures</code> we'll use is the <a rel="noopener" target="_blank" href="https://docs.rs/futures/0.1.10/futures/sync/mpsc/fn.channel.html"><code>futures::sync::mpsc::channel</code></a> which behaves similar to the <a rel="noopener" target="_blank" href="https://doc.rust-lang.org/std/sync/mpsc/fn.channel.html"><code>std::sync::mpsc::channel</code></a>. We'll build a channel then pass off the sender <code>tx</code> to another thread, then we'll fire a series of messages along the channel. The <code>rx</code> side of the channel can then be used similarly to an <code>Iterator</code>.</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> fun_with_futures</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">thread</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Future</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> ok}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">stream</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Stream</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sync</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">mpsc</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Sink</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">fun_with_futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep_a_little_bit</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">BUFFER_SIZE</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">usize </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">10</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// A channel represents a stream and will yield a series of futures.

    // We&#39;re using a bounded channel here with a limited size.
    </span><span style="color:#ffa759;">let </span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> tx</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> rx) </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">mpsc</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">channel(</span><span style="color:#ffcc66;">BUFFER_SIZE</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ccc9c2;">thread</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">spawn(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;--&gt; START THREAD&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// We&#39;ll have the stream produce a series of values.
        </span><span style="color:#ffa759;">for </span><span style="color:#f29e74;">_ in </span><span style="color:#ffcc66;">0</span><span style="color:#f29e74;">..</span><span style="color:#ffcc66;">10 </span><span style="color:#ccc9c2;">{

            </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> waited_for </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;+++ THREAD WAITED </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> waited_for)</span><span style="color:#ccc9c2cc;">;

            </span><span style="font-style:italic;color:#5c6773;">// When we `send()` a value it consumes the sender. Returning
            // a &#39;new&#39; sender which we have to handle. In this case we just
            // re-assign.
            </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> tx</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">send</span><span style="color:#ccc9c2;">(waited_for)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">() {
                </span><span style="font-style:italic;color:#5c6773;">// Why do we need to do this? This is how back pressure is implemented.
                // When the buffer is full `wait()` will block.
                </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(new_tx) </span><span style="color:#f29e74;">=&gt;</span><span style="color:#ccc9c2;"> tx </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> new_tx</span><span style="color:#ccc9c2cc;">,
                </span><span style="font-style:italic;color:#5ccfe6;">Err</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#f28779;">panic!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Oh no!&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">,
            </span><span style="color:#ccc9c2;">}

        }
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;&lt;-- END THREAD&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// Here the stream is dropped.
    </span><span style="color:#ccc9c2;">})</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// We can `.fold()` like we would an iterator. In fact we can do many
    // things like we would an iterator.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> sum </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> rx</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">fold</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ccc9c2;">|</span><span style="color:#ffcc66;">acc</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">val</span><span style="color:#ccc9c2;">| {
            </span><span style="font-style:italic;color:#5c6773;">// Notice when we run that this is happening after each item of
            // the stream resolves, like an iterator.
            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;+++ FOLDING </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> INTO </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> val</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> acc)</span><span style="color:#ccc9c2cc;">;
            </span><span style="font-style:italic;color:#5c6773;">// `ok()` is a simple way to say &quot;Yes this worked.&quot;
            // `err()` also exists.
            </span><span style="color:#f28779;">ok</span><span style="color:#ccc9c2;">(acc </span><span style="color:#f29e74;">+</span><span style="color:#ccc9c2;"> val)
        })
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;SUM </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> sum)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span></code></pre>
<p>The output will be similar to the following:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">--&gt; START THREAD
+++ THREAD WAITED 166
+++ FOLDING 166 INTO 0
+++ THREAD WAITED 554
+++ FOLDING 554 INTO 166
+++ THREAD WAITED 583
+++ FOLDING 583 INTO 720
+++ THREAD WAITED 175
+++ FOLDING 175 INTO 1303
+++ THREAD WAITED 136
+++ FOLDING 136 INTO 1478
+++ THREAD WAITED 155
+++ FOLDING 155 INTO 1614
+++ THREAD WAITED 90
+++ FOLDING 90 INTO 1769
+++ THREAD WAITED 986
+++ FOLDING 986 INTO 1859
+++ THREAD WAITED 830
+++ FOLDING 830 INTO 2845
+++ THREAD WAITED 21
&lt;-- END THREAD
+++ FOLDING 21 INTO 3675
SUM 3696
</span></code></pre>
<p>Now that we're familiar with these basic ideas we can move on to working with <code>futures_cpupool</code>.</p>
<h2 id="dipping-our-toes-into-the-cpu-pool">Dipping Our Toes Into the CPU Pool</h2>
<p>Earlier we alluded to the idea of using futures with a CPU pool where we didn't have to manage which thread did which work, but in our examples so far we've still had to manually spin up threads. So let's fix that.</p>
<p>The <a rel="noopener" target="_blank" href="https://docs.rs/futures-cpupool/0.1.3/futures_cpupool/"><code>futures_cpupool</code></a> crate offers us this functionality. Let's take a look at a basic example which does nearly the same thing as our second example above:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> fun_with_futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures_cpupool</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Future</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> join_all}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures_cpupool</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Builder</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">fun_with_futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep_a_little_bit</span><span style="color:#ccc9c2cc;">;

</span><span style="font-style:italic;color:#5c6773;">// Feel free to change me!
</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">NUM_OF_TASKS</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">usize </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">10</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Creates a CpuPool with workers equal to the cores on the machine.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> pool </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Builder</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">create</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Create a batch of futures.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> futures </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">0</span><span style="color:#f29e74;">..</span><span style="color:#ffcc66;">NUM_OF_TASKS</span><span style="color:#ccc9c2;">)
        </span><span style="font-style:italic;color:#5c6773;">// Tell the pool to run a closure.
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">index</span><span style="color:#ccc9c2;">| pool</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">spawn_fn</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{

            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> --&gt; START&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> index)</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> waited_for </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;"> &lt;-- WAITED </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> index</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> waited_for)</span><span style="color:#ccc9c2cc;">;

            </span><span style="font-style:italic;color:#5c6773;">// We need to return a result!
            // Why? Futures were implemented with I/O in mind!
            </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">, ()&gt; </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(index)</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ccc9c2;">            result
        }))</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">&gt;&gt;()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// We wait on all the futures here and see if they came back in order.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result </span><span style="color:#f29e74;">= </span><span style="color:#f28779;">join_all</span><span style="color:#ccc9c2;">(futures)
        </span><span style="font-style:italic;color:#5c6773;">// Check they all came out in the right order.
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">values</span><span style="color:#ccc9c2;">|
            values</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">iter</span><span style="color:#ccc9c2;">()
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">enumerate</span><span style="color:#ccc9c2;">()
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">all</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">index</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> &amp;</span><span style="color:#ffcc66;">value</span><span style="color:#ccc9c2;">)| index </span><span style="color:#f29e74;">==</span><span style="color:#ccc9c2;"> value))
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Job is done. Values returned in order: </span><span style="color:#ffcc66;">{:?}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> result)
}
</span></code></pre>
<p>This outputs something similar to the following:</p>
<pre style="background-color:#212733;">
<code><span style="color:#ccc9c2;">0 --&gt; START
1 --&gt; START
2 --&gt; START
3 --&gt; START
4 --&gt; START
5 --&gt; START
6 --&gt; START
7 --&gt; START
0 &lt;-- WAITED 37
8 --&gt; START
2 &lt;-- WAITED 86
9 --&gt; START
3 &lt;-- WAITED 110
6 &lt;-- WAITED 326
9 &lt;-- WAITED 458
4 &lt;-- WAITED 568
5 &lt;-- WAITED 748
7 &lt;-- WAITED 757
1 &lt;-- WAITED 794
8 &lt;-- WAITED 838
Job is done. Values returned in order: true
</span></code></pre>
<p>This time we didn't need to manage threads or which thread does what. The pool just handled it for us. This is pretty handy. We can be rather arbitrary with what we do with the pool. For example different spawned tasks can return different types:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> fun_with_futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures_cpupool</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures_cpupool</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Builder</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">fun_with_futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sleep_a_little_bit</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Creates a CpuPool with workers equal to the cores on the machine.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> pool </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Builder</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">create</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Note the two spawns return different types.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> returns_string </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> pool</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">spawn_fn</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{
        </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// We need to return a result!
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">, ()&gt; </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;First&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ccc9c2;">        result
    })</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> returns_integer </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> pool</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">spawn_fn</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="color:#ccc9c2;">{
        </span><span style="color:#f28779;">sleep_a_little_bit</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// We need to return a result!
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> result</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">, ()&gt; </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">2</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ccc9c2;">        result
    })</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Wait for the jobs to finish.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> resulting_string </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> returns_string</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> resulting_integer </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> returns_integer</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">wait</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">, </span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> resulting_string</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> resulting_integer)</span><span style="color:#ccc9c2cc;">;
    </span><span style="font-style:italic;color:#5c6773;">// Returns `First, 2`
</span><span style="color:#ccc9c2;">}
</span></code></pre>
<p>This means that we can create a CPU pool and delegate arbitrary tasks to it throughout the lifetime of our program. It may be that you want to create multiple pools to prevent starvation, for example a pool with 2 workers for network connections, and another with 2 workers for delayed jobs.</p>
<h2 id="visiting-tokio-s-core">Visiting Tokio's Core</h2>
<p>The <a rel="noopener" target="_blank" href="https://tokio.rs/"><code>tokio</code></a> project has been developed closely alongside of <code>futures</code> and the projects share many authors. The project has a number of crates intended for building asynchronous applications. In the <code>tokio-core</code> crate there are things like the main event loop, TCP handlers, and timeouts. Building on top of that are crates such as <code>tokio-proto</code> and <code>tokio-service</code> which build on top of these constructs.</p>
<p>We'll start with just <code>tokio-core</code> and doing a simple HTTP GET request. Note since we're not actually using a HTTP client we need to handle all the details ourselves. Here's what that looks like:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_core</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ToSocketAddrs</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{read_to_end</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> write_all}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">reactor</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Core</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">TcpStream</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">DOMAIN</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">&#39;static str </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;google.com&quot;</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">PORT</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">u16 </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">80</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Create the event loop that will drive this server.
    </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> core </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> handle </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">handle</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Get a socket address from a domain name.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> socket_addr </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">DOMAIN</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">PORT</span><span style="color:#ccc9c2;">)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_socket_addrs</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">iter</span><span style="color:#ccc9c2;">| iter</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">&gt;&gt;())
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()[</span><span style="color:#ffcc66;">0</span><span style="color:#ccc9c2;">]</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Connect with a handle to the core event loop.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> response </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">TcpStream</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">connect(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">socket_addr</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">handle)
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">and_then</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">socket</span><span style="color:#ccc9c2;">| {
            </span><span style="font-style:italic;color:#5c6773;">// Write a raw GET request onto the socket.
            </span><span style="color:#f28779;">write_all</span><span style="color:#ccc9c2;">(socket</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f28779;">format!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">\
</span><span style="color:#bae67e;">                GET / HTTP/1.0</span><span style="color:#95e6cb;">\r\n</span><span style="color:#ccc9c2cc;">\
</span><span style="color:#bae67e;">                Host: </span><span style="color:#ffcc66;">{}</span><span style="color:#95e6cb;">\r\n</span><span style="color:#ccc9c2cc;">\
                </span><span style="color:#95e6cb;">\r\n</span><span style="color:#ccc9c2cc;">\
            </span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">DOMAIN</span><span style="color:#ccc9c2;">))
        })</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">and_then</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">socket</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">_request</span><span style="color:#ccc9c2;">)| {
            </span><span style="font-style:italic;color:#5c6773;">// Read the response into a buffer.
            </span><span style="color:#f28779;">read_to_end</span><span style="color:#ccc9c2;">(socket</span><span style="color:#ccc9c2cc;">, </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new())
        })</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Fire the task off onto the event loop.
    </span><span style="color:#ffa759;">let </span><span style="color:#ccc9c2;">(_socket</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> data) </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">run</span><span style="color:#ccc9c2;">(response)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Parse the data and output it.
    </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#ffcc66;">{}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8(data)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span></code></pre>
<p>This looks a bit different than what we've previously been doing with our futures. <a rel="noopener" target="_blank" href="https://docs.rs/tokio-core/0.1.4/tokio_core/reactor/struct.Core.html"><code>Core::new()</code></a> is how we create an event loop, or 'Reactor', which we can get <a rel="noopener" target="_blank" href="https://docs.rs/tokio-core/0.1.4/tokio_core/reactor/struct.Handle.html"><code>Handle</code>s</a> which we use when issuing tasks such as <code>TcpStream::Connect</code>. You can learn more about the basics of the Reactor <a rel="noopener" target="_blank" href="https://tokio.rs/docs/getting-started/reactor/">here</a>.</p>
<p>Working with the types provided by Tokio is slightly different than working with those provided by <code>std</code>, however many of the ideas and concepts are the same. Many of the changes are due to the differences between syncronous and asynchronous I/O.</p>
<p>Near the end of the example we have <code>core.run()</code> which is a way to fire off <strong>one off</strong> tasks and get a return value from them, similar to how we were using futures. Tokio also provides a <code>spawn()</code> and <code>spawn_fn()</code> functions which are executed in the background and must do their own handling of errors, making it ideal for tasks such as responding to new connections.</p>
<p>Let's play with <code>spawn_fn()</code> in our next example by making a simple server.</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_core</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">SocketAddr</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Stream</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{read_to_end</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> write_all}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">reactor</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Core</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">TcpListener</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">&#39;static str </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;0.0.0.0:8080&quot;</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Create the event loop that will drive this server.
    </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> core </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> handle </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">handle</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Get a SocketAddr
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> socket</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> SocketAddr </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">parse</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Start listening.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> listener </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">TcpListener</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">bind(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">socket</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">handle)
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// For each incoming connection...
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> server </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> listener</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">incoming</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">for_each</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">stream</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">_client_addr</span><span style="color:#ccc9c2;">)| {
        </span><span style="font-style:italic;color:#5c6773;">// Spawn the task on the reactor.
</span><span style="color:#ccc9c2;">        handle</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">spawn_fn</span><span style="color:#ccc9c2;">(|| {
            </span><span style="font-style:italic;color:#5c6773;">// Read until EOF
            </span><span style="color:#f28779;">read_to_end</span><span style="color:#ccc9c2;">(stream</span><span style="color:#ccc9c2cc;">, </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new())
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">and_then</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">socket</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">data</span><span style="color:#ccc9c2;">)| {
                    </span><span style="font-style:italic;color:#5c6773;">// Write the recieved data.
                    </span><span style="color:#f28779;">write_all</span><span style="color:#ccc9c2;">(socket</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> data)
                })
                </span><span style="font-style:italic;color:#5c6773;">// Errors have to be handled internally.
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|_| ())
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map_err</span><span style="color:#ccc9c2;">(|_| ())
        })</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(()) </span><span style="font-style:italic;color:#5c6773;">// keep accepting connections
    </span><span style="color:#ccc9c2;">})</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Run the reactor.
</span><span style="color:#ccc9c2;">    core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">run</span><span style="color:#ccc9c2;">(server)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span><span style="font-style:italic;color:#5c6773;">// Throw some data at it with `echo &quot;Test&quot; | nc 127.0.0.1 8080`
</span></code></pre>
<p>Running <code>echo &quot;Test&quot; | nc 127.0.0.1 8080</code> in another terminal echos back the data sent. </p>
<p>However, our example here isn't very useful, or idiomatic! For example, we can't use something like <code>telnet</code> or <code>curl</code> to interact with it. It's a start though. Let's do better.</p>
<p>We'll improve on our previous example by using a <a rel="noopener" target="_blank" href="https://docs.rs/tokio-core/0.1.4/tokio_core/io/trait.Codec.html"><code>Codec</code></a>. <code>Codec</code>s allow us to describe how to encode and decode the frames a <code>TcpStream</code> (or anything else that can be <code>framed()</code>). It asks us to define an <code>In</code> and an <code>Out</code> type as well as <code>encode()</code> and <code>decode()</code> functions.</p>
<p>Here's what our example with <code>EchoCodec</code> could look like:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_core</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">SocketAddr</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Stream</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Result</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Codec</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> EasyBuf</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Io}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">reactor</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Core</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">TcpListener</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">&#39;static str </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;0.0.0.0:8080&quot;</span><span style="color:#ccc9c2cc;">;

</span><span style="font-style:italic;color:#5c6773;">// Codecs can have state, but this one doesn&#39;t.
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">EchoCodec</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Codec </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">EchoCodec </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// Associated types which define the data taken/produced by the codec.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">In </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Out </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Returns `Ok(Some(In))` if there is a frame, `Ok(None)` if it needs more data.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">decode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> EasyBuf) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Option</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In&gt;&gt; {
        </span><span style="font-style:italic;color:#5c6773;">// It&#39;s important to drain the buffer!
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> amount </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">len</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> data </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(amount)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(data</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">into</span><span style="color:#ccc9c2;">()))
    }

    </span><span style="font-style:italic;color:#5c6773;">// Produces a frame.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">encode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">msg</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;()&gt; {
        buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(msg)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(())
    }
}

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Create the event loop that will drive this server.
    </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> core </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> handle </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">handle</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Get a SocketAddr
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> socket</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> SocketAddr </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">parse</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Start listening.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> listener </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">TcpListener</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">bind(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">socket</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">handle)
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// For each incoming connection...
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> server </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> listener</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">incoming</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">for_each</span><span style="color:#ccc9c2;">(|(</span><span style="color:#ffcc66;">stream</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffcc66;">_client_addr</span><span style="color:#ccc9c2;">)| {
        </span><span style="font-style:italic;color:#5c6773;">// Spawn the task on the reactor.
</span><span style="color:#ccc9c2;">        handle</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">spawn_fn</span><span style="color:#ccc9c2;">(|| {
            </span><span style="font-style:italic;color:#5c6773;">// Using our codec, split the in/out into frames.
            </span><span style="color:#ffa759;">let </span><span style="color:#ccc9c2;">(writer</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> reader) </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> stream</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">framed</span><span style="color:#ccc9c2;">(EchoCodec)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">split</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
            </span><span style="font-style:italic;color:#5c6773;">// Here we just sink any data recieved directly back into the socket.
</span><span style="color:#ccc9c2;">            reader</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">forward</span><span style="color:#ccc9c2;">(writer)
                </span><span style="font-style:italic;color:#5c6773;">// We need to handle errors internally.
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|_| ())
                </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map_err</span><span style="color:#ccc9c2;">(|_| ())
        })</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(()) </span><span style="font-style:italic;color:#5c6773;">// keep accepting connections
    </span><span style="color:#ccc9c2;">})</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Run the reactor.
</span><span style="color:#ccc9c2;">    core</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">run</span><span style="color:#ccc9c2;">(server)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span><span style="font-style:italic;color:#5c6773;">// Throw some data at it with `echo &quot;Test&quot; | nc 127.0.0.1 8080`
</span></code></pre>
<p>If you test this out you'll find the same behaviour as the previous example. With a little change we can even make it handle lines instead of entire messages, we'll borrow some code from Tokio's examples to do this:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="font-style:italic;color:#5c6773;">// Codecs can have state, but this one doesn&#39;t.
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">EchoCodec</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Codec </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">EchoCodec </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// Associated types which define the data taken/produced by the codec.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">In </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Out </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Returns `Ok(Some(In))` if there is a frame, `Ok(None)` if it needs more data.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">decode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> EasyBuf) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Option</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In&gt;&gt; {
        </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">iter</span><span style="color:#ccc9c2;">()</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">position</span><span style="color:#ccc9c2;">(|</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">b</span><span style="color:#ccc9c2;">| b </span><span style="color:#f29e74;">== </span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&#39;</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&#39;</span><span style="color:#ccc9c2;">) {
            </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(i) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="font-style:italic;color:#5c6773;">// Drain from the buffer (this is important!)
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> line </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(i)</span><span style="color:#ccc9c2cc;">;

                </span><span style="font-style:italic;color:#5c6773;">// Also remove the &#39;\n&#39;.
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;

                </span><span style="font-style:italic;color:#5c6773;">// Turn this data into a UTF string and return it in a Frame.
                </span><span style="color:#ffa759;">match str</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8(line</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">()) {
                    </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(s) </span><span style="color:#f29e74;">=&gt; </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(s</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_string</span><span style="color:#ccc9c2;">()))</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">Err</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">_</span><span style="color:#ccc9c2;">) </span><span style="color:#f29e74;">=&gt; </span><span style="font-style:italic;color:#5ccfe6;">Err</span><span style="color:#ccc9c2;">(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ErrorKind</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Other</span><span style="color:#ccc9c2cc;">,
                                                </span><span style="color:#bae67e;">&quot;invalid UTF-8&quot;</span><span style="color:#ccc9c2;">))</span><span style="color:#ccc9c2cc;">,
                </span><span style="color:#ccc9c2;">}
            }</span><span style="color:#ccc9c2cc;">,
            </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">None</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">,
        </span><span style="color:#ccc9c2;">}
    }

    </span><span style="font-style:italic;color:#5c6773;">// Produces a frame.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">encode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">msg</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;()&gt; {
        buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(msg</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_bytes</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5c6773;">// Add the necessary newline.
</span><span style="color:#ccc9c2;">        buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">push</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&#39;</span><span style="color:#95e6cb;">\n</span><span style="color:#bae67e;">&#39;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(())
    }
}
</span></code></pre>
<p>Running this example you can connect with <code>nc 127.0.0.1 8080</code> and send some lines of text, then get them back. Notice how we didn't have to change the rest of the code at all in order to make this change? All we had to do was change the behaivor of the codec.</p>
<p>Now let's try making a codec that encodes and decodes HTTP 1.1 GET and POST requests made from <code>curl</code> that we can build on later:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">enum </span><span style="color:#73d0ff;">ExampleRequest </span><span style="color:#ccc9c2;">{
    Get { url</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">    Post { url</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">}

</span><span style="color:#ffa759;">enum </span><span style="color:#73d0ff;">ExampleResponse </span><span style="color:#ccc9c2;">{
    NotFound</span><span style="color:#ccc9c2cc;">,
    </span><span style="font-style:italic;color:#5ccfe6;">Ok </span><span style="color:#ccc9c2;">{ content</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">}

</span><span style="font-style:italic;color:#5c6773;">// Codecs can have state, but this one doesn&#39;t.
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleCodec</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Codec </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleCodec </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// Associated types which define the data taken/produced by the codec.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">In </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> ExampleRequest</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Out </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> ExampleResponse</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Returns `Ok(Some(In))` if there is a frame, `Ok(None)` if it needs more data.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">decode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> EasyBuf) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Option</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In&gt;&gt; {
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> content_so_far </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5c6773;">// Request headers/content in HTTP 1.1 are split by double newline.
        </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> content_so_far</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">) {
            </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(i) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="font-style:italic;color:#5c6773;">// Drain from the buffer (this is important!)
                </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> headers </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">{
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> tmp </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(i)</span><span style="color:#ccc9c2cc;">;
                    </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(tmp</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()
                }</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">4</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// Also remove the &#39;\r\n\r\n&#39;.

                // Get the method and drain.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot; &quot;</span><span style="color:#ccc9c2;">)
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">len</span><span style="color:#ccc9c2;">| headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ccc9c2;">len)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;())</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ccc9c2;">                headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// Get rid of the space.

                // Since the method was drained we can do it again to get the url.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> url </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot; &quot;</span><span style="color:#ccc9c2;">)
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">len</span><span style="color:#ccc9c2;">| headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ccc9c2;">len)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;())
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap_or_default</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

                </span><span style="font-style:italic;color:#5c6773;">// The content of a POST.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> content </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">{
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> remaining </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">len</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> tmp </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(remaining)</span><span style="color:#ccc9c2cc;">;
                    </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(tmp</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()
                }</span><span style="color:#ccc9c2cc;">;

                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> method {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">ref</span><span style="color:#ccc9c2;"> method) </span><span style="color:#ffa759;">if</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;GET&quot; </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Get { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url }))
                    }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">ref</span><span style="color:#ccc9c2;"> method) </span><span style="color:#ffa759;">if</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;POST&quot; </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Post { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> content }))
                    }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="color:#f29e74;">_ =&gt; </span><span style="font-style:italic;color:#5ccfe6;">Err</span><span style="color:#ccc9c2;">(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ErrorKind</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Other</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;invalid&quot;</span><span style="color:#ccc9c2;">))
                }
            }</span><span style="color:#ccc9c2cc;">,
            </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">None</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">,
        </span><span style="color:#ccc9c2;">}
    }

    </span><span style="font-style:italic;color:#5c6773;">// Produces a frame.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">encode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">msg</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;()&gt; {
        </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> msg {
            ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">NotFound </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;HTTP/1.1 404 Not Found</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Content-Length: 0</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Connection: close</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
            </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v } </span><span style="color:#f29e74;">=&gt;  </span><span style="color:#ccc9c2;">{
                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;HTTP/1.1 200 Ok</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#f28779;">format!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Content-Length: </span><span style="color:#ffcc66;">{}</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">len</span><span style="color:#ccc9c2;">())</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_bytes</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Connection: close</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_bytes</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#ccc9c2;">}
        }
        buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(())
    }
}
</span></code></pre>
<p>Let's be honest with ourselves here, this is very naive and is obviously incomplete! However it works for <code>curl -vvvv localhost:8080</code> and <code>curl -vvvv localhost:8080 --data hello</code>, and we got to learn a bit about how to use Tokio. So far so good! Let's build on it.</p>
<h2 id="services-and-protocols">Services and Protocols</h2>
<p><code>tokio-core</code> is, by definition, minimal. The <code>tokio-proto</code> and <code>tokio-service</code> crates build atop it to create common abstractions which we can use for various applications.</p>
<p>In this next example we'll build off our previous example of our naive HTTP server. Since the code chunks are starting to get significant let's work with isolated bits and we'll show the full example at the very end.</p>
<p>Our goal will be to build an ultra simple web server that responds to GET/POST requests. A POST to <code>/cats</code> with the data <code>meow</code> should return a <code>200</code> OK with the old value (if any) as the data, and any future GET to <code>/cats</code> should return <code>meow</code> as well until it is replaced. Our goal is simplicity and learning, not being robust or perfect.</p>
<p>First, we'll go ahead and define our protocol. We'll use a simple pipelined, non-streaming protocol. This code is quite generic and will generally look quite similar for different implementations. <code>tokio-proto</code> allow us to define the general style of our network. The <a rel="noopener" target="_blank" href="https://docs.rs/tokio-proto/0.1.0/tokio_proto/"><code>tokio-proto</code> docs</a> provide a good explanation of the differences.</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_proto</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">pipeline</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ServerProto</span><span style="color:#ccc9c2cc;">;

</span><span style="font-style:italic;color:#5c6773;">// Like codecs, protocols can carry state too!
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleProto</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl</span><span style="color:#ccc9c2;">&lt;T</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Io </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">&#39;static</span><span style="color:#ccc9c2;">&gt; ServerProto&lt;T&gt; </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleProto </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// These types must match the corresponding codec types:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Request </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Response </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">/// A bit of boilerplate to hook in the codec:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Transport </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Framed&lt;T, ExampleCodec&gt;</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">BindTransport </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Transport, io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error&gt;</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">bind_transport</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">io</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> T) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">BindTransport {
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(io</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">framed</span><span style="color:#ccc9c2;">(ExampleCodec))
    }
}
</span></code></pre>
<p>The service is less generic, and handles our little &quot;database&quot; inside of it. Due to the <code>Proto</code> and the <code>Codec</code> already handling most of the complicated bits, it's fairly straightforward. Services are reusable abstractions that operate over protocols.</p>
<p>Here's what our little HTTP example looks like:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="font-style:italic;color:#5c6773;">// Surprise! Services can also carry state.
</span><span style="color:#ccc9c2cc;">#</span><span style="color:#ccc9c2;">[</span><span style="color:#ffd580;">derive</span><span style="color:#ccc9c2;">(Default)]
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleService </span><span style="color:#ccc9c2;">{
    db</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ccc9c2;">Arc&lt;Mutex&lt;HashMap&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">, </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;&gt;&gt;,
}

</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Service </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleService </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// These types must match the corresponding protocol types:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Request </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Response </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// For non-streaming protocols, service errors are always io::Error
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Error </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// The future for computing the response; box it for simplicity.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Future </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">BoxFuture&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Response, </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error&gt;</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Produce a future for computing a response from a request.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">call</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">req</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Request) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future {
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Request: </span><span style="color:#ffcc66;">{:?}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> req)</span><span style="color:#ccc9c2cc;">;
        
        </span><span style="font-style:italic;color:#5c6773;">// Deref the database.
        </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> db </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">lock</span><span style="color:#ccc9c2;">()
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// This should only panic in extreme cirumstances.
        
        // Return the appropriate value.
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> res </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> req {
            ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Get { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url } </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">get</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">url) {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(v) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">() }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">NotFound</span><span style="color:#ccc9c2cc;">,
                </span><span style="color:#ccc9c2;">}
            }</span><span style="color:#ccc9c2cc;">,
            </span><span style="color:#ccc9c2;">ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Post { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> content } </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">insert</span><span style="color:#ccc9c2;">(url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content) {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(v) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;&quot;</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">into</span><span style="color:#ccc9c2;">() }</span><span style="color:#ccc9c2cc;">,
                </span><span style="color:#ccc9c2;">}
            }
        }</span><span style="color:#ccc9c2cc;">;
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Database: </span><span style="color:#ffcc66;">{:?}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">*</span><span style="color:#ccc9c2;">db)</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5c6773;">// Return the result.
        </span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">finished(res)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">boxed</span><span style="color:#ccc9c2;">()
    }
}
</span></code></pre>
<p>At this point we have all the pieces and just need to put them all together. This requires some changes to our <code>main()</code> function like so:</p>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Get a SocketAddr
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> socket</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> SocketAddr </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">parse</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Create a server with the protocol.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> server </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">TcpServer</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(ExampleProto</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> socket)</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Create a database instance to provide to spawned services.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> db </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Arc</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(Mutex</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(HashMap</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()))</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Serve requests with our created service and a handle to the database.    
</span><span style="color:#ccc9c2;">    server</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">serve</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(ExampleService { db</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">() }))</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span><span style="font-style:italic;color:#5c6773;">// Throw some data at it with `curl 127.0.0.1 8080/foo` and `curl 127.0.0.1 8080 --data bar`
</span></code></pre>
<p>Testing it out:</p>
<pre style="background-color:#212733;">
<code class="language-bash" data-lang="bash"><span style="color:#ffd580;">$</span><span style="color:#ccc9c2;"> curl localhost:8080/bear           
</span><span style="color:#ffd580;">$</span><span style="color:#ccc9c2;"> curl localhost:8080/bear</span><span style="color:#ffcc66;"> --data</span><span style="color:#ccc9c2;"> foo
</span><span style="color:#ffd580;">$</span><span style="color:#ccc9c2;"> curl localhost:8080/bear           
</span><span style="color:#ffd580;">foo%</span><span style="color:#ccc9c2;">                                                                                                                                                                   $ curl localhost:8080/bear</span><span style="color:#ffcc66;"> --data</span><span style="color:#ccc9c2;"> bar
</span><span style="color:#ffd580;">foo%
$</span><span style="color:#ccc9c2;"> curl localhost:8080/bear
</span><span style="color:#ffd580;">bar%
</span></code></pre>
<p>This is great, we've created a little network connected database with a &quot;REST-ish&quot; API. I hope this has taught you a bit about Futures and Tokio, and inspired you to play around further! </p>
<blockquote>
<p>This post was supported in part through a time allocation from <a rel="noopener" target="_blank" href="http://asquera.de/">Asquera</a> and can be found <a rel="noopener" target="_blank" href="http://asquera.de/blog/2017-03-01/the-future-with-futures/">here</a>. Thanks!</p>
</blockquote>
<h2 id="complete-tokio-example">Complete Tokio Example</h2>
<pre style="background-color:#212733;">
<code class="language-rust" data-lang="rust"><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> futures</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_core</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_proto</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">extern crate</span><span style="color:#ccc9c2;"> tokio_service</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">net</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">SocketAddr</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">futures</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{</span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> BoxFuture</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Future}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">sync</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Mutex</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Arc}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{io</span><span style="color:#ccc9c2cc;">, </span><span style="color:#ffa759;">str</span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">std</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">collections</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">HashMap</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_core</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">{Codec</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> EasyBuf</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Io</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> Framed}</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_proto</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">TcpServer</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_proto</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">pipeline</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ServerProto</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">use </span><span style="color:#ccc9c2;">tokio_service</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Service</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ffa759;">const </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">&#39;static str </span><span style="color:#f29e74;">= </span><span style="color:#bae67e;">&quot;0.0.0.0:8080&quot;</span><span style="color:#ccc9c2cc;">;

#</span><span style="color:#ccc9c2;">[</span><span style="color:#ffd580;">derive</span><span style="color:#ccc9c2;">(Debug)]
</span><span style="color:#ffa759;">enum </span><span style="color:#73d0ff;">ExampleRequest </span><span style="color:#ccc9c2;">{
    Get { url</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">    Post { url</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">}

</span><span style="color:#ffa759;">enum </span><span style="color:#73d0ff;">ExampleResponse </span><span style="color:#ccc9c2;">{
    NotFound</span><span style="color:#ccc9c2cc;">,
    </span><span style="font-style:italic;color:#5ccfe6;">Ok </span><span style="color:#ccc9c2;">{ content</span><span style="color:#ccc9c2cc;">: </span><span style="font-style:italic;color:#5ccfe6;">String </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
</span><span style="color:#ccc9c2;">}

</span><span style="font-style:italic;color:#5c6773;">// Codecs can have state, but this one doesn&#39;t.
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleCodec</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Codec </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleCodec </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// Associated types which define the data taken/produced by the codec.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">In </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> ExampleRequest</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Out </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> ExampleResponse</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Returns `Ok(Some(In))` if there is a frame, `Ok(None)` if it needs more data.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">decode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut</span><span style="color:#ccc9c2;"> EasyBuf) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">Option</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In&gt;&gt; {
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> content_so_far </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5c6773;">// Request headers/content in HTTP 1.1 are split by double newline.
        </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> content_so_far</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">) {
            </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(i) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="font-style:italic;color:#5c6773;">// Drain from the buffer (this is important!)
                </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> headers </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">{
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> tmp </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(i)</span><span style="color:#ccc9c2cc;">;
                    </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(tmp</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()
                }</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(</span><span style="color:#ffcc66;">4</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// Also remove the &#39;\r\n\r\n&#39;.

                // Get the method and drain.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot; &quot;</span><span style="color:#ccc9c2;">)
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">len</span><span style="color:#ccc9c2;">| headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ccc9c2;">len)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;())</span><span style="color:#ccc9c2cc;">;

</span><span style="color:#ccc9c2;">                headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ffcc66;">1</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// Get rid of the space.

                // Since the method was drained we can do it again to get the url.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> url </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">find</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot; &quot;</span><span style="color:#ccc9c2;">)
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">map</span><span style="color:#ccc9c2;">(|</span><span style="color:#ffcc66;">len</span><span style="color:#ccc9c2;">| headers</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">..</span><span style="color:#ccc9c2;">len)</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">collect</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;())
                    </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap_or_default</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;

                </span><span style="font-style:italic;color:#5c6773;">// The content of a POST.
                </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> content </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">{
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> remaining </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">len</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
                    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> tmp </span><span style="color:#f29e74;">=</span><span style="color:#ccc9c2;"> buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">drain_to</span><span style="color:#ccc9c2;">(remaining)</span><span style="color:#ccc9c2cc;">;
                    </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">from_utf8_lossy(tmp</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_slice</span><span style="color:#ccc9c2;">())
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">to_mut</span><span style="color:#ccc9c2;">()
                        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">()
                }</span><span style="color:#ccc9c2cc;">;

                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> method {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">ref</span><span style="color:#ccc9c2;"> method) </span><span style="color:#ffa759;">if</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;GET&quot; </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Get { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url }))
                    }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">ref</span><span style="color:#ccc9c2;"> method) </span><span style="color:#ffa759;">if</span><span style="color:#ccc9c2;"> method </span><span style="color:#f29e74;">== </span><span style="color:#bae67e;">&quot;POST&quot; </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Post { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> content }))
                    }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="color:#f29e74;">_ =&gt; </span><span style="font-style:italic;color:#5ccfe6;">Err</span><span style="color:#ccc9c2;">(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">ErrorKind</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Other</span><span style="color:#ccc9c2cc;">, </span><span style="color:#bae67e;">&quot;invalid&quot;</span><span style="color:#ccc9c2;">))
                }
            }</span><span style="color:#ccc9c2cc;">,
            </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(</span><span style="font-style:italic;color:#5ccfe6;">None</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">,
        </span><span style="color:#ccc9c2;">}
    }

    </span><span style="font-style:italic;color:#5c6773;">// Produces a frame.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">encode</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">msg</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out, </span><span style="color:#ffcc66;">buf</span><span style="color:#ccc9c2cc;">: </span><span style="color:#f29e74;">&amp;</span><span style="color:#ffa759;">mut </span><span style="font-style:italic;color:#5ccfe6;">Vec</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">u8</span><span style="color:#ccc9c2;">&gt;) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;()&gt; {
        </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> msg {
            ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">NotFound </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;HTTP/1.1 404 Not Found</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Content-Length: 0</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Connection: close</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#ccc9c2;">}</span><span style="color:#ccc9c2cc;">,
            </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v } </span><span style="color:#f29e74;">=&gt;  </span><span style="color:#ccc9c2;">{
                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;HTTP/1.1 200 Ok</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#f28779;">format!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Content-Length: </span><span style="color:#ffcc66;">{}</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">len</span><span style="color:#ccc9c2;">())</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_bytes</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;Connection: close</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">                buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">as_bytes</span><span style="color:#ccc9c2;">())</span><span style="color:#ccc9c2cc;">;
            </span><span style="color:#ccc9c2;">}
        }
        buf</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">extend</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">b</span><span style="color:#bae67e;">&quot;</span><span style="color:#95e6cb;">\r\n</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2;">)</span><span style="color:#ccc9c2cc;">;
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(())
    }
}

</span><span style="font-style:italic;color:#5c6773;">// Like codecs, protocols can carry state too!
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleProto</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ffa759;">impl</span><span style="color:#ccc9c2;">&lt;T</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> Io </span><span style="color:#f29e74;">+ </span><span style="color:#ffa759;">&#39;static</span><span style="color:#ccc9c2;">&gt; ServerProto&lt;T&gt; </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleProto </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// These types must match the corresponding codec types:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Request </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Response </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">/// A bit of boilerplate to hook in the codec:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Transport </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Framed&lt;T, ExampleCodec&gt;</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">BindTransport </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">Result</span><span style="color:#ccc9c2;">&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Transport, io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error&gt;</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">bind_transport</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">io</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> T) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">BindTransport {
        </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(io</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">framed</span><span style="color:#ccc9c2;">(ExampleCodec))
    }
}

</span><span style="font-style:italic;color:#5c6773;">// Surprise! Services can also carry state.
</span><span style="color:#ccc9c2cc;">#</span><span style="color:#ccc9c2;">[</span><span style="color:#ffd580;">derive</span><span style="color:#ccc9c2;">(Default)]
</span><span style="color:#ffa759;">struct </span><span style="color:#73d0ff;">ExampleService </span><span style="color:#ccc9c2;">{
    db</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ccc9c2;">Arc&lt;Mutex&lt;HashMap&lt;</span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">, </span><span style="font-style:italic;color:#5ccfe6;">String</span><span style="color:#ccc9c2;">&gt;&gt;&gt;,
}

</span><span style="color:#ffa759;">impl </span><span style="color:#ccc9c2;">Service </span><span style="color:#ffa759;">for </span><span style="color:#73d0ff;">ExampleService </span><span style="color:#ccc9c2;">{
    </span><span style="font-style:italic;color:#5c6773;">// These types must match the corresponding protocol types:
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Request </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">In</span><span style="color:#ccc9c2cc;">;
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Response </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">&lt;ExampleCodec </span><span style="color:#f29e74;">as</span><span style="color:#ccc9c2;"> Codec&gt;</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Out</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// For non-streaming protocols, service errors are always io::Error
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Error </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">io</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// The future for computing the response; box it for simplicity.
    </span><span style="color:#ffa759;">type </span><span style="color:#73d0ff;">Future </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">BoxFuture&lt;</span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Response, </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Error&gt;</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Produce a future for computing a response from a request.
    </span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">call</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ffcc66;">self</span><span style="color:#ccc9c2;">, </span><span style="color:#ffcc66;">req</span><span style="color:#ccc9c2cc;">: </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Request) </span><span style="color:#ccc9c2cc;">-&gt; </span><span style="color:#ffa759;">Self</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Future {
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Request: </span><span style="color:#ffcc66;">{:?}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> req)</span><span style="color:#ccc9c2cc;">;
        
        </span><span style="font-style:italic;color:#5c6773;">// Deref the database.
        </span><span style="color:#ffa759;">let mut</span><span style="color:#ccc9c2;"> db </span><span style="color:#f29e74;">= </span><span style="font-style:italic;color:#5ccfe6;">self</span><span style="color:#f29e74;">.</span><span style="color:#ccc9c2;">db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">lock</span><span style="color:#ccc9c2;">()
            </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">; </span><span style="font-style:italic;color:#5c6773;">// This should only panic in extreme cirumstances.
        
        // Return the appropriate value.
        </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> res </span><span style="color:#f29e74;">= </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> req {
            ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Get { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url } </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">get</span><span style="color:#ccc9c2;">(</span><span style="color:#f29e74;">&amp;</span><span style="color:#ccc9c2;">url) {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(v) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">() }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">NotFound</span><span style="color:#ccc9c2cc;">,
                </span><span style="color:#ccc9c2;">}
            }</span><span style="color:#ccc9c2cc;">,
            </span><span style="color:#ccc9c2;">ExampleRequest</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Post { url</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> content } </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">{
                </span><span style="color:#ffa759;">match</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">insert</span><span style="color:#ccc9c2;">(url</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> content) {
                    </span><span style="font-style:italic;color:#5ccfe6;">Some</span><span style="color:#ccc9c2;">(v) </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> v }</span><span style="color:#ccc9c2cc;">,
                    </span><span style="font-style:italic;color:#5ccfe6;">None </span><span style="color:#f29e74;">=&gt; </span><span style="color:#ccc9c2;">ExampleResponse</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">Ok { content</span><span style="color:#ccc9c2cc;">: </span><span style="color:#bae67e;">&quot;&quot;</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">into</span><span style="color:#ccc9c2;">() }</span><span style="color:#ccc9c2cc;">,
                </span><span style="color:#ccc9c2;">}
            }
        }</span><span style="color:#ccc9c2cc;">;
        </span><span style="color:#f28779;">println!</span><span style="color:#ccc9c2;">(</span><span style="color:#bae67e;">&quot;Database: </span><span style="color:#ffcc66;">{:?}</span><span style="color:#bae67e;">&quot;</span><span style="color:#ccc9c2cc;">, </span><span style="color:#f29e74;">*</span><span style="color:#ccc9c2;">db)</span><span style="color:#ccc9c2cc;">;

        </span><span style="font-style:italic;color:#5c6773;">// Return the result.
        </span><span style="color:#ccc9c2;">future</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">finished(res)</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">boxed</span><span style="color:#ccc9c2;">()
    }
}

</span><span style="color:#ffa759;">fn </span><span style="color:#ffd580;">main</span><span style="color:#ccc9c2;">() {
    </span><span style="font-style:italic;color:#5c6773;">// Get a SocketAddr
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> socket</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> SocketAddr </span><span style="color:#f29e74;">= </span><span style="color:#ffcc66;">LISTEN_TO</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">parse</span><span style="color:#ccc9c2;">()
        </span><span style="color:#f29e74;">.</span><span style="color:#f28779;">unwrap</span><span style="color:#ccc9c2;">()</span><span style="color:#ccc9c2cc;">;
    
    </span><span style="font-style:italic;color:#5c6773;">// Create a server with the protocol.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> server </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">TcpServer</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(ExampleProto</span><span style="color:#ccc9c2cc;">,</span><span style="color:#ccc9c2;"> socket)</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Create a database instance to provide to spawned services.
    </span><span style="color:#ffa759;">let</span><span style="color:#ccc9c2;"> db </span><span style="color:#f29e74;">= </span><span style="color:#ccc9c2;">Arc</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(Mutex</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new(HashMap</span><span style="color:#f29e74;">::</span><span style="color:#ccc9c2;">new()))</span><span style="color:#ccc9c2cc;">;

    </span><span style="font-style:italic;color:#5c6773;">// Serve requests with our created service and a handle to the database.    
</span><span style="color:#ccc9c2;">    server</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">serve</span><span style="color:#ccc9c2;">(</span><span style="color:#ffa759;">move </span><span style="color:#f29e74;">|| </span><span style="font-style:italic;color:#5ccfe6;">Ok</span><span style="color:#ccc9c2;">(ExampleService { db</span><span style="color:#ccc9c2cc;">:</span><span style="color:#ccc9c2;"> db</span><span style="color:#f29e74;">.</span><span style="color:#f28779;">clone</span><span style="color:#ccc9c2;">() }))</span><span style="color:#ccc9c2cc;">;
</span><span style="color:#ccc9c2;">}
</span><span style="font-style:italic;color:#5c6773;">// Throw some data at it with `curl 127.0.0.1 8080/foo` and `curl 127.0.0.1 8080 --data bar`
</span></code></pre>
    </main>
    <footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/e38bd4b8ecbf1a44f73ff5adc170d0f95868db5d
">e38bd4b8ecbf1a44f73ff5adc170d0f95868db5d
</a></pre>
    </body>

</html>
