<!DOCTYPE html>
<html>
    <head>
        <!-- Fun compatability things -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
        <meta http-equiv="X-UA-Compatible" content="IE=edge">                  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
        <meta name="HandheldFriendly" content="True" />
        <meta name="MobileOptimized" content="320" />
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
        <link rel="shortcut icon" href="https:&#x2F;&#x2F;hoverbear.org/images/favicon.ico">
    
        <!-- Information about this site -->
        <title>Getting the most of WSL
        </title>
        <meta name="description" content="A computer scientist working in open source towards a more hopeful future." />
    
        <!-- Various Twitter related content. -->
        <meta name="twitter:card" content="summary_large_image">
        <meta name="twitter:image" content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;4bcb29022c8a36fe00.jpg"/>
        <meta property='og:image' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;4bcb29022c8a36fe00.jpg"/>
        <meta name="twitter:site" content="@a_hoverbear"/>
        <meta name="twitter:creator" content="@a_hoverbear"/>
        
        
            <meta name="twitter:title" content="Getting the most of WSL"/>
            <meta property='og:title' content="Getting the most of WSL"/>
        

        
            <meta property='og:url' content="https:&#x2F;&#x2F;hoverbear.org&#x2F;blog&#x2F;getting-the-most-out-of-wsl&#x2F;"/>
        

        
            <meta name="twitter:description" content="Not long ago, Microsoft started iterating more heavily on their long-existing &amp;quot;Windows Subsystem for Linux&amp;quot; feature. The feature has existed for some time, but recently has it become much more usable for everyday Linux development work.
In this post, we&#x27;ll investigate some ways to get the most out of WSL. I won&#x27;t present anything new here, just providing a single place for how I or someone else could get things set up.
"/>
            <meta property='og:description' content="Not long ago, Microsoft started iterating more heavily on their long-existing &amp;quot;Windows Subsystem for Linux&amp;quot; feature. The feature has existed for some time, but recently has it become much more usable for everyday Linux development work.
In this post, we&#x27;ll investigate some ways to get the most out of WSL. I won&#x27;t present anything new here, just providing a single place for how I or someone else could get things set up.
"/>
        
    
        <!-- Talk about the homepage and the rss feed. -->
        <link rel="canonical" href="https:&#x2F;&#x2F;hoverbear.org">
        <link rel="alternate" type="application/rss+xml" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">
    
        <!-- Stylesheets are fun -->
        <link rel="preconnect" href="https://fonts.gstatic.com">
        <link href="https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Delius&family=Fira+Code&family=Noto+Sans&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" media="screen" href="https:&#x2F;&#x2F;hoverbear.org/main.css" />
    
        <!-- Katex -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.css" integrity="sha384-D+9gmBxUQogRLqvARvNLmA9hS2x//eK1FhVb9PiU86gmcrBrJAQT8okdJ4LMp2uv" crossorigin="anonymous">
        <!-- The loading of KaTeX is deferred to speed up page rendering -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/katex.min.js" integrity="sha384-483A6DwYfKeDa0Q52fJmxFXkcPCFfnXMoXblOkJ4JcA8zATN6Tm78UNL72AKk+0O" crossorigin="anonymous"></script>
        <!-- To automatically render math in text elements, include the auto-render extension: -->
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0-rc.1/dist/contrib/auto-render.min.js" integrity="sha384-yACMu8JWxKzSp/C1YV86pzGiQ/l1YUfE8oPuahJQxzehAjEt2GiQuy/BIvl9KyeF" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script>
    </head>
    

    <body>
        
    <div id="hero-wrapper">
    <figure class="enriched ">
        <figcaption>Photo&nbsp;- Matthieu Joannon; @matt_j on Unsplash</figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;786fed048a2bb82500.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;4bcb29022c8a36fe00.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;786fed048a2bb82500.jpg"
              alt="Photo" />
    </figure>
</div>

    <header>
    <div class="content">
        <h1 id="main-title"><a id="main-link" href="https:&#x2F;&#x2F;hoverbear.org">
            Getting the most of WSL
        </a></h1>

        <nav id="tree"><ul><li>
            <a href="https://hoverbear.org/consulting/">
                Consulting Services
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/about/">
                Ana, Hoverbear üêª
            </a>&nbsp;
        </li><li>
            <a href="https://hoverbear.org/blog/">
                Articles
            </a>&nbsp;
        </li></ul><ul></ul><ul></ul>
</nav>


        <div class="metadata">
            <p class="description">
                    Some tricks for getting more mileage from your Linux subsystem
                </p>

            <p class="date">
                    Posted on 2019-12-11, around 7 minutes of reading.
                </p>
        </div>
    </div>
</header>

    <main>
        
    <nav id=toc>
        <ol>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#getting-it-set-up">Getting it set up</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#updating-ubuntu">Updating Ubuntu</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#better-terminals">Better terminals</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#configuring-wsl">Configuring WSL</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#passwordless-sudo">Passwordless sudo</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#set-up-ssh-keys">Set up SSH keys</a>
                
            </li>
            
            <li>
                <a href="https://hoverbear.org/blog/getting-the-most-out-of-wsl/#get-systemd-functional">Get systemd functional</a>
                
            </li>
            
        </ol>
    </nav>

        <p>Not long ago, Microsoft started iterating more heavily on their long-existing &quot;Windows Subsystem for Linux&quot; feature. The feature has existed for some time, but recently has it become much more usable for everyday Linux development work.</p>
<p>In this post, we'll investigate some ways to get the most out of WSL. I won't present anything new here, just providing a single place for how I or someone else <strong>could</strong> get things set up.</p>
<span id="continue-reading"></span>
<blockquote>
<p>This guide was written on Windows 10 Pro, Insiders build 18985, targetting Ubuntu. Your mileage may vary on older/newer builds or different distros.</p>
</blockquote>
<h2 id="getting-it-set-up">Getting it set up</h2>
<p>Getting WSL set up has a few steps, first you'll need to add some Windows optional Features.</p>
<pre data-lang="powershell" style="background-color:#212733;color:#ccc9c2;" class="language-powershell "><code class="language-powershell" data-lang="powershell"><span style="font-style:italic;color:#5c6773;"># In an administrator powershell
</span><span style="color:#f28779;">Enable-WindowsOptionalFeature </span><span style="color:#f29e74;">-</span><span>Online </span><span style="color:#f29e74;">-</span><span>FeatureName </span><span style="color:#bae67e;">&quot;Microsoft-Windows-Subsystem-Linux&quot;
</span><span style="color:#f28779;">Enable-WindowsOptionalFeature </span><span style="color:#f29e74;">-</span><span>Online </span><span style="color:#f29e74;">-</span><span>FeatureName </span><span style="color:#bae67e;">&quot;VirtualMachinePlatform&quot; 
</span><span>wsl </span><span style="color:#f29e74;">--</span><span style="color:#f28779;">set-default</span><span style="color:#f29e74;">-</span><span>version </span><span style="color:#ffcc66;">2
</span></code></pre>
<p>Next, head on over to the Windows Store and install <a rel="noopener" target="_blank" href="https://www.microsoft.com/en-ca/p/ubuntu/9nblggh4msv6?activetab=pivot:overviewtab">'Ubuntu'</a>. Once it's downloaded you should launch it and do the first time setup. It'll ask you to put a username and password.</p>
<p>At the point, you have a WSL2 installation of Ubuntu. To verify:</p>
<pre data-lang="powershell" style="background-color:#212733;color:#ccc9c2;" class="language-powershell "><code class="language-powershell" data-lang="powershell"><span>$ wsl </span><span style="color:#f29e74;">-</span><span>l </span><span style="color:#f29e74;">-</span><span>v
</span><span>  NAME      STATE           VERSION
</span><span style="color:#f29e74;">*</span><span> Ubuntu    Running         </span><span style="color:#ffcc66;">2
</span></code></pre>
<p>To access Ubuntu type <code>wsl</code> from Powershell, or open the 'Ubuntu' app in your Start Menu.</p>
<h2 id="updating-ubuntu">Updating Ubuntu</h2>
<p>The Ubuntu version you should have is Ubuntu 18.04. (Check with <code>lsb_release -r</code>) In order to upgrade it to Ubuntu 19.04 </p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">wsl</span><span> sudo sed</span><span style="color:#ffcc66;"> -i </span><span style="color:#bae67e;">&#39;s/Prompt=lts/Prompt=normal/g&#39;</span><span> /etc/update-manager/release-upgrades
</span><span style="color:#ffd580;">wsl</span><span> sudo do-release-upgrade
</span></code></pre>
<p>If the process asks you about &quot;restart services during package upgrades without asking&quot; you should pick <strong>no</strong>! If it asks you for a list of services to restart, just have it empty.</p>
<blockquote>
<p>Our Ubuntu isn't running <code>systemd</code> (yet) so we don't have to restart the services.</p>
</blockquote>
<p>If the process asks you about lxd and the snap store, you can select <strong>skip</strong>. Since we're not running <code>lxd</code> and <code>snapd</code> (yet) we don't need it.</p>
<p>For any new configuration files (such as <code>sshd</code>) select <strong>install the package maintainer's version</strong>.</p>
<p>Then, let it 'restart', restart the WSL machine with <code>wsl --shutdown</code> from a Powershell.</p>
<p>Open up a Ubuntu shell and check <code>lsb_release -r</code> again. For me it says 19.04. This means I need to upgrade again to get to 19.10!</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">wsl</span><span> sudo do-release-upgrade
</span></code></pre>
<p>Following the same procedure, <code>lsb_release -r</code> for me now shows 19.10.</p>
<h2 id="better-terminals">Better terminals</h2>
<p>The <a rel="noopener" target="_blank" href="https://www.microsoft.com/en-ca/p/windows-terminal-preview/9n0dx20hk701?activetab=pivot:overviewtab">'Windows Terminal'</a> app provides a nicer terminal experience.</p>
<figure class="enriched ">
        <figcaption>Windows Terminal chooser</figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;73f690b57305f78f00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;9c989ec5b63802a600.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;73f690b57305f78f00.jpg"
              alt="Windows Terminal chooser" />
    </figure>
<p>You can also install <a rel="noopener" target="_blank" href="https://code.visualstudio.com/insiders/">VS Code Insiders</a> and the <a rel="noopener" target="_blank" href="https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-wsl">Remote - WSL</a> extension to get a full featured editor/explorer.</p>
<figure class="enriched ">
        <figcaption>VS Code chooser</figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bca8df81f0a6b6ea00.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;41f1d4d1077bb98800.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;bca8df81f0a6b6ea00.jpg"
              alt="VS Code chooser" />
    </figure>
<p>Occasionally VS Code, the extension, or something else will update and render it unable to connect. Opening a local VS Code window, closing it, then restarting the computer should fix it.</p>
<h2 id="configuring-wsl">Configuring WSL</h2>
<p>Typically, you won't want your WSL instance to be able to consume all your resources. You may also want to disable things like swap.</p>
<p>Save a file to <code>%UserProfile%/.wslconfig</code> with contents like the following:</p>
<pre data-lang="ini" style="background-color:#212733;color:#ccc9c2;" class="language-ini "><code class="language-ini" data-lang="ini"><span style="color:#ffa759;">[wsl2]
</span><span style="color:#ffcc66;">memory</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">12GB
</span><span style="color:#ffcc66;">swap</span><span style="color:#f29e74;">=</span><span style="color:#ffcc66;">0
</span></code></pre>
<p>To apply these changes, run <code>wsl --shutdown</code> and open up a new Ubuntu terminal.</p>
<h2 id="passwordless-sudo">Passwordless <code>sudo</code></h2>
<p>Having to deal with passwords in a dev VM is kind of annoying. Let's turn that off in Ubuntu:</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">cat </span><span style="color:#f29e74;">&lt;&lt;-</span><span style="color:#bae67e;">&#39;</span><span style="color:#ffa759;">EOF</span><span style="color:#bae67e;">&#39; </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">sudo</span><span> tee</span><span style="color:#ffcc66;"> -a</span><span> /etc/sudoers.d/sudo
</span><span style="color:#bae67e;">%sudo         ALL = (ALL) NOPASSWD: ALL
</span><span style="color:#ffa759;">EOF
</span></code></pre>
<h2 id="set-up-ssh-keys">Set up SSH keys</h2>
<p>If you've already rolled keys with Window's built-in <code>ssh-keygen</code> you should copy over your existing key.</p>
<p>In your Ubuntu shell (change your user if it's different between Windows and Linux):</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">mkdir</span><span style="color:#ffcc66;"> -p </span><span style="font-style:italic;color:#5ccfe6;">~</span><span>/.ssh
</span><span style="color:#ffd580;">cp</span><span style="color:#ffcc66;"> -r</span><span> /mnt/c/Users/$USER/.ssh/</span><span style="color:#f29e74;">* </span><span style="font-style:italic;color:#5ccfe6;">~</span><span>/.ssh/
</span><span style="color:#ffd580;">chmod</span><span style="color:#ffcc66;"> -R</span><span> o-rwx,g-rwx </span><span style="font-style:italic;color:#5ccfe6;">~</span><span>/.ssh/</span><span style="color:#f29e74;">*
</span></code></pre>
<p>If you haven't already, roll some keys in Linux and copy them the other way:</p>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">mkdir</span><span style="color:#ffcc66;"> -p</span><span> /mnt/c/Users/$USER/.ssh/
</span><span style="color:#ffd580;">cp</span><span style="color:#ffcc66;"> -r </span><span style="font-style:italic;color:#5ccfe6;">~</span><span>/.ssh/</span><span style="color:#f29e74;">*</span><span> /mnt/c/Users/$USER/.ssh/
</span></code></pre>
<p>Unfortunately we can't easily link them since they're on different devices.</p>
<h2 id="get-systemd-functional">Get <code>systemd</code> functional</h2>
<p>At this stage of WSL2's development, we don't get a true <code>systemd</code> <em>yet</em>. That is, by default, you can't do things like <code>systemctl start sshd</code> or <code>systemctl start docker</code>.</p>
<p>Thankfully, a wonderful person in the Snapcraft project, <a rel="noopener" target="_blank" href="https://forum.snapcraft.io/u/daniel/summary">Daniel</a>, got an <a rel="noopener" target="_blank" href="https://forum.snapcraft.io/t/running-snaps-on-wsl2-insiders-only-for-now/13033">amazingly convienent hack working</a>! While you may want to fully review the linked article, here's a quick and dirty breakdown.</p>
<p>In your Ubuntu shell:</p>
<blockquote>
<p>Ubuntu 20.20? Daemonize is moved according to <a rel="noopener" target="_blank" href="https://twitter.com/ram0973/status/1253647608670814217">@ram0973</a> found
it on the <code>/usr/bin/daemonize</code> path.</p>
</blockquote>
<pre data-lang="bash" style="background-color:#212733;color:#ccc9c2;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#ffd580;">sudo</span><span> apt-get install</span><span style="color:#ffcc66;"> -yqq</span><span> daemonize dbus-user-session
</span><span style="color:#ffd580;">cat </span><span style="color:#f29e74;">&lt;&lt;-</span><span style="color:#bae67e;">&#39;</span><span style="color:#ffa759;">EOF</span><span style="color:#bae67e;">&#39; </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">sudo</span><span> tee</span><span style="color:#ffcc66;"> -a</span><span> /usr/sbin/start-systemd-namespace </span><span style="color:#f29e74;">&gt;</span><span> /dev/null
</span><span style="color:#bae67e;">#!/bin/bash
</span><span style="color:#bae67e;">
</span><span style="color:#bae67e;">SYSTEMD_PID=$(ps -ef | grep &#39;/lib/systemd/systemd --system-unit=basic.target$&#39; | grep -v unshare | awk &#39;{print $2}&#39;)
</span><span style="color:#bae67e;">if [ -z &quot;$SYSTEMD_PID&quot; ] || [ &quot;$SYSTEMD_PID&quot; != &quot;1&quot; ]; then
</span><span style="color:#bae67e;">    export PRE_NAMESPACE_PATH=&quot;$PATH&quot;
</span><span style="color:#bae67e;">    (set -o posix; set) | \
</span><span style="color:#bae67e;">        grep -v &quot;^BASH&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^DIRSTACK=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^EUID=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^GROUPS=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^HOME=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^HOSTNAME=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^HOSTTYPE=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^IFS=&#39;.*&quot;$&#39;\n&#39;&quot;&#39;&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^LANG=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^LOGNAME=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^MACHTYPE=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^NAME=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^OPTERR=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^OPTIND=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^OSTYPE=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^PIPESTATUS=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^POSIXLY_CORRECT=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^PPID=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^PS1=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^PS4=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^SHELL=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^SHELLOPTS=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^SHLVL=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^SYSTEMD_PID=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^UID=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^USER=&quot; | \
</span><span style="color:#bae67e;">        grep -v &quot;^_=&quot; | \
</span><span style="color:#bae67e;">        cat - &gt; &quot;$HOME/.systemd-env&quot;
</span><span style="color:#bae67e;">    echo &quot;PATH=&#39;$PATH&#39;&quot; &gt;&gt; &quot;$HOME/.systemd-env&quot;
</span><span style="color:#bae67e;">    exec sudo /usr/sbin/enter-systemd-namespace &quot;$BASH_EXECUTION_STRING&quot;
</span><span style="color:#bae67e;">fi
</span><span style="color:#bae67e;">if [ -n &quot;$PRE_NAMESPACE_PATH&quot; ]; then
</span><span style="color:#bae67e;">    export PATH=&quot;$PRE_NAMESPACE_PATH&quot;
</span><span style="color:#bae67e;">fi
</span><span style="color:#ffa759;">EOF
</span><span style="color:#ffd580;">sudo</span><span> chmod +x /usr/sbin/start-systemd-namespace
</span><span style="color:#ffd580;">cat </span><span style="color:#f29e74;">&lt;&lt;-</span><span style="color:#bae67e;">&#39;</span><span style="color:#ffa759;">EOF</span><span style="color:#bae67e;">&#39; </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">sudo</span><span> tee</span><span style="color:#ffcc66;"> -a</span><span> /usr/sbin/enter-systemd-namespace </span><span style="color:#f29e74;">&gt;</span><span> /dev/null
</span><span style="color:#bae67e;">#!/bin/bash
</span><span style="color:#bae67e;">
</span><span style="color:#bae67e;">if [ &quot;$UID&quot; != 0 ]; then
</span><span style="color:#bae67e;">    echo &quot;You need to run $0 through sudo&quot;
</span><span style="color:#bae67e;">    exit 1
</span><span style="color:#bae67e;">fi
</span><span style="color:#bae67e;">
</span><span style="color:#bae67e;">SYSTEMD_PID=&quot;$(ps -ef | grep &#39;/lib/systemd/systemd --system-unit=basic.target$&#39; | grep -v unshare | awk &#39;{print $2}&#39;)&quot;
</span><span style="color:#bae67e;">if [ -z &quot;$SYSTEMD_PID&quot; ]; then
</span><span style="color:#bae67e;">    /usr/sbin/daemonize /usr/bin/unshare --fork --pid --mount-proc /lib/systemd/systemd --system-unit=basic.target
</span><span style="color:#bae67e;">    while [ -z &quot;$SYSTEMD_PID&quot; ]; do
</span><span style="color:#bae67e;">        SYSTEMD_PID=&quot;$(ps -ef | grep &#39;/lib/systemd/systemd --system-unit=basic.target$&#39; | grep -v unshare | awk &#39;{print $2}&#39;)&quot;
</span><span style="color:#bae67e;">    done
</span><span style="color:#bae67e;">fi
</span><span style="color:#bae67e;">
</span><span style="color:#bae67e;">if [ -n &quot;$SYSTEMD_PID&quot; ] &amp;&amp; [ &quot;$SYSTEMD_PID&quot; != &quot;1&quot; ]; then
</span><span style="color:#bae67e;">    if [ -n &quot;$1&quot; ] &amp;&amp; [ &quot;$1&quot; != &quot;bash --login&quot; ] &amp;&amp; [ &quot;$1&quot; != &quot;/bin/bash --login&quot; ]; then
</span><span style="color:#bae67e;">        exec /usr/bin/nsenter -t &quot;$SYSTEMD_PID&quot; -a \
</span><span style="color:#bae67e;">            /usr/bin/sudo -H -u &quot;$SUDO_USER&quot; \
</span><span style="color:#bae67e;">            /bin/bash -c &#39;set -a; source &quot;$HOME/.systemd-env&quot;; set +a; exec bash -c &#39;&quot;$(printf &quot;%q&quot; &quot;$@&quot;)&quot;
</span><span style="color:#bae67e;">    else
</span><span style="color:#bae67e;">        exec /usr/bin/nsenter -t &quot;$SYSTEMD_PID&quot; -a \
</span><span style="color:#bae67e;">            /bin/login -p -f &quot;$SUDO_USER&quot; \
</span><span style="color:#bae67e;">            $(/bin/cat &quot;$HOME/.systemd-env&quot; | grep -v &quot;^PATH=&quot;)
</span><span style="color:#bae67e;">    fi
</span><span style="color:#bae67e;">    echo &quot;Existential crisis&quot;
</span><span style="color:#bae67e;">fi
</span><span style="color:#ffa759;">EOF
</span><span style="color:#ffd580;">sudo</span><span> chmod +x /usr/sbin/enter-systemd-namespace
</span><span style="color:#ffd580;">cat </span><span style="color:#f29e74;">&lt;&lt;-</span><span style="color:#bae67e;">&#39;</span><span style="color:#ffa759;">EOF</span><span style="color:#bae67e;">&#39; </span><span style="color:#f29e74;">| </span><span style="color:#ffd580;">sudo</span><span> tee</span><span style="color:#ffcc66;"> -a</span><span> /etc/sudoers.d/wsl </span><span style="color:#f29e74;">&gt;</span><span> /dev/null
</span><span style="color:#bae67e;">Defaults        env_keep += WSLPATH
</span><span style="color:#bae67e;">Defaults        env_keep += WSLENV
</span><span style="color:#bae67e;">Defaults        env_keep += WSL_INTEROP
</span><span style="color:#bae67e;">Defaults        env_keep += WSL_DISTRO_NAME
</span><span style="color:#bae67e;">Defaults        env_keep += PRE_NAMESPACE_PATH
</span><span style="color:#bae67e;">%sudo ALL=(ALL) NOPASSWD: /usr/sbin/enter-systemd-namespace
</span><span style="color:#ffa759;">EOF
</span><span style="color:#ffd580;">sudo</span><span> sed</span><span style="color:#ffcc66;"> -i</span><span> 2a</span><span style="color:#bae67e;">&quot;# Start or enter a PID namespace in WSL2\nsource /usr/sbin/start-systemd-namespace\n&quot;</span><span> /etc/bash.bashrc
</span></code></pre>
<p>In Powershell, set some final knobs then restart WSL:</p>
<pre data-lang="powershell" style="background-color:#212733;color:#ccc9c2;" class="language-powershell "><code class="language-powershell" data-lang="powershell"><span style="color:#f28779;">cmd.exe </span><span style="color:#f29e74;">/</span><span>C setx WSLENV BASH_ENV</span><span style="color:#f29e74;">/</span><span>u
</span><span style="color:#f28779;">cmd.exe </span><span style="color:#f29e74;">/</span><span>C setx BASH_ENV </span><span style="color:#f29e74;">/</span><span>etc</span><span style="color:#f29e74;">/</span><span>bash.bashrc
</span><span>wsl </span><span style="color:#f29e74;">--</span><span>shutdown
</span></code></pre>
<p>Finally, install <code>docker.io</code> with <code>apt</code> and have a try:</p>
<figure class="enriched ">
        <figcaption>Docker running in Sytemd</figcaption>
        
       
       <img srcset="
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;8bf4f501aa795c1100.jpg 1920w,
              https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;c4d905155d081bee00.jpg 3840w
              "
              sizes="
                     (max-width: 1200px) 1200px,
                     (max-width: 1800px) 1800px,set 
                     3840px"
              src="https:&#x2F;&#x2F;hoverbear.org&#x2F;processed_images&#x2F;8bf4f501aa795c1100.jpg"
              alt="Docker running in Sytemd" />
    </figure>

    </main>
    <footer class="post-footer">
    Connect through &nbsp<a href="mailto:operator@hoverbear.org">operator@hoverbear.org</a>,&nbsp;<a href="https://github.com/hoverbear">@hoverbear</a> on Github,&nbsp;<a href="https://twitter.com/a_hoverbear">@a_hoverbear</a> on Twitter,</a>&nbsp;
    or track via <a class="subscribe" href="https:&#x2F;&#x2F;hoverbear.org/rss.xml">RSS Feed</a>.
</footer>
<pre class="artifact"><a id="commit" href="https://github.com/Hoverbear/hoverbear.org/commit/d298b87631f8b420930992616c4e6556c3eef16e
">d298b87631f8b420930992616c4e6556c3eef16e
</a></pre>
    </body>

</html>
